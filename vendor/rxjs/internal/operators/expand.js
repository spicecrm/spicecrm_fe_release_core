"use strict";var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var OuterSubscriber_1=require("../OuterSubscriber"),subscribeToResult_1=require("../util/subscribeToResult");function expand(e,r,i){return void 0===r&&(r=Number.POSITIVE_INFINITY),void 0===i&&(i=void 0),r=(r||0)<1?Number.POSITIVE_INFINITY:r,function(t){return t.lift(new ExpandOperator(e,r,i))}}exports.expand=expand;var ExpandOperator=function(){function t(t,e,r){this.project=t,this.concurrent=e,this.scheduler=r}return t.prototype.call=function(t,e){return e.subscribe(new ExpandSubscriber(t,this.project,this.concurrent,this.scheduler))},t}();exports.ExpandOperator=ExpandOperator;var ExpandSubscriber=function(n){function o(t,e,r,i){var s=n.call(this,t)||this;return s.project=e,s.concurrent=r,s.scheduler=i,s.index=0,s.active=0,s.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(s.buffer=[]),s}return __extends(o,n),o.dispatch=function(t){var e=t.subscriber,r=t.result,i=t.value,s=t.index;e.subscribeToProjection(r,i,s)},o.prototype._next=function(t){var e=this.destination;if(e.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){e.next(t);try{var i=(0,this.project)(t,r);if(this.scheduler){var s={subscriber:this,result:i,value:t,index:r};this.destination.add(this.scheduler.schedule(o.dispatch,0,s))}else this.subscribeToProjection(i,t,r)}catch(t){e.error(t)}}else this.buffer.push(t)}},o.prototype.subscribeToProjection=function(t,e,r){this.active++,this.destination.add(subscribeToResult_1.subscribeToResult(this,t,e,r))},o.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete(),this.unsubscribe()},o.prototype.notifyNext=function(t,e,r,i,s){this._next(e)},o.prototype.notifyComplete=function(t){var e=this.buffer;this.destination.remove(t),this.active--,e&&0<e.length&&this._next(e.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()},o}(OuterSubscriber_1.OuterSubscriber);exports.ExpandSubscriber=ExpandSubscriber;