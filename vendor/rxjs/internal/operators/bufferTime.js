"use strict";var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var async_1=require("../scheduler/async"),Subscriber_1=require("../Subscriber"),isScheduler_1=require("../util/isScheduler");function bufferTime(t){var e=arguments.length,r=async_1.async;isScheduler_1.isScheduler(arguments[arguments.length-1])&&(r=arguments[arguments.length-1],e--);var n=null;2<=e&&(n=arguments[1]);var i=Number.POSITIVE_INFINITY;return 3<=e&&(i=arguments[2]),function(e){return e.lift(new BufferTimeOperator(t,n,i,r))}}exports.bufferTime=bufferTime;var BufferTimeOperator=function(){function e(e,t,r,n){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=r,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new BufferTimeSubscriber(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),Context=function(){this.buffer=[]},BufferTimeSubscriber=function(a){function e(e,t,r,n,i){var s=a.call(this,e)||this;s.bufferTimeSpan=t,s.bufferCreationInterval=r,s.maxBufferSize=n,s.scheduler=i,s.contexts=[];var o=s.openContext();if(s.timespanOnly=null==r||r<0,s.timespanOnly){var u={subscriber:s,context:o,bufferTimeSpan:t};s.add(o.closeAction=i.schedule(dispatchBufferTimeSpanOnly,t,u))}else{var c={subscriber:s,context:o},f={bufferTimeSpan:t,bufferCreationInterval:r,subscriber:s,scheduler:i};s.add(o.closeAction=i.schedule(dispatchBufferClose,t,c)),s.add(i.schedule(dispatchBufferCreation,r,f))}return s}return __extends(e,a),e.prototype._next=function(e){for(var t,r=this.contexts,n=r.length,i=0;i<n;i++){var s=r[i],o=s.buffer;o.push(e),o.length==this.maxBufferSize&&(t=s)}t&&this.onBufferFull(t)},e.prototype._error=function(e){this.contexts.length=0,a.prototype._error.call(this,e)},e.prototype._complete=function(){for(var e=this.contexts,t=this.destination;0<e.length;){var r=e.shift();t.next(r.buffer)}a.prototype._complete.call(this)},e.prototype._unsubscribe=function(){this.contexts=null},e.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var r=this.bufferTimeSpan,n={subscriber:this,context:e,bufferTimeSpan:r};this.add(e.closeAction=this.scheduler.schedule(dispatchBufferTimeSpanOnly,r,n))}},e.prototype.openContext=function(){var e=new Context;return this.contexts.push(e),e},e.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts;0<=(t?t.indexOf(e):-1)&&t.splice(t.indexOf(e),1)},e}(Subscriber_1.Subscriber);function dispatchBufferTimeSpanOnly(e){var t=e.subscriber,r=e.context;r&&t.closeContext(r),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function dispatchBufferCreation(e){var t=e.bufferCreationInterval,r=e.bufferTimeSpan,n=e.subscriber,i=e.scheduler,s=n.openContext();n.closed||(n.add(s.closeAction=i.schedule(dispatchBufferClose,r,{subscriber:n,context:s})),this.schedule(e,t))}function dispatchBufferClose(e){var t=e.subscriber,r=e.context;t.closeContext(r)}