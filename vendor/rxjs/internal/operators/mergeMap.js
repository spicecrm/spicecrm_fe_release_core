"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var subscribeToResult_1=require("../util/subscribeToResult"),OuterSubscriber_1=require("../OuterSubscriber"),InnerSubscriber_1=require("../InnerSubscriber"),map_1=require("./map"),from_1=require("../observable/from");function mergeMap(t,n,r){return void 0===r&&(r=Number.POSITIVE_INFINITY),"function"==typeof n?function(e){return e.pipe(mergeMap(function(r,i){return from_1.from(t(r,i)).pipe(map_1.map(function(e,t){return n(r,e,i,t)}))},r))}:("number"==typeof n&&(r=n),function(e){return e.lift(new MergeMapOperator(t,r))})}exports.mergeMap=mergeMap;var MergeMapOperator=function(){function e(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new MergeMapSubscriber(e,this.project,this.concurrent))},e}();exports.MergeMapOperator=MergeMapOperator;var MergeMapSubscriber=function(n){function e(e,t,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=n.call(this,e)||this;return i.project=t,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}return __extends(e,n),e.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},e.prototype._tryNext=function(e){var t,r=this.index++;try{t=this.project(e,r)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t,e,r)},e.prototype._innerSub=function(e,t,r){var i=new InnerSubscriber_1.InnerSubscriber(this,t,r),n=this.destination;n.add(i);var o=subscribeToResult_1.subscribeToResult(this,e,void 0,void 0,i);o!==i&&n.add(o)},e.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},e.prototype.notifyNext=function(e,t,r,i,n){this.destination.next(t)},e.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,0<t.length?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},e}(OuterSubscriber_1.OuterSubscriber);exports.MergeMapSubscriber=MergeMapSubscriber;