/*
SpiceUI 2018.10.001

Copyright (c) 2016-present, aac services.k.s - All rights reserved.
Redistribution and use in source and binary forms, without modification, are permitted provided that the following conditions are met:
- Redistributions of source code must retain this copyright and license notice, this list of conditions and the following disclaimer.
- Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
- If used the SpiceCRM Logo needs to be displayed in the upper left corner of the screen in a minimum dimension of 31x31 pixels and be clearly visible, the icon needs to provide a link to http://www.spicecrm.io
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

*/

/*(c) aac services 2020. All Rights reserved)*/
"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++)for(var a in t=arguments[i])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__decorate=this&&this.__decorate||function(e,t,i,s){var a,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var n=e.length-1;0<=n;n--)(a=e[n])&&(o=(r<3?a(o):3<r?a(t,i,o):a(t,i))||o);return 3<r&&o&&Object.defineProperty(t,i,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(i,s){return function(e,t){s(e,t,i)}},__awaiter=this&&this.__awaiter||function(e,o,n,u){return new(n=n||Promise)(function(t,i){function s(e){try{r(u.next(e))}catch(e){i(e)}}function a(e){try{r(u.throw(e))}catch(e){i(e)}}function r(e){e.done?t(e.value):function(t){return t instanceof n?t:new n(function(e){e(t)})}(e.value).then(s,a)}r((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(i,s){var a,r,o,e,n={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;n;)try{if(a=1,r&&(o=2&t[0]?r.return:t[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,t[1])).done)return o;switch(r=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return n.label++,{value:t[1],done:!1};case 5:n.label++,r=t[1],t=[0];continue;case 7:t=n.ops.pop(),n.trys.pop();continue;default:if(!(o=0<(o=n.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){n=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){n.label=t[1];break}if(6===t[0]&&n.label<o[1]){n.label=o[1],o=t;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(t);break}o[2]&&n.ops.pop(),n.trys.pop();continue}t=s.call(i,n)}catch(e){t=[6,e],r=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),platform_browser_1=require("@angular/platform-browser"),router_1=require("@angular/router"),rxjs_1=require("rxjs"),http_1=require("@angular/common/http"),noop=function(){},loggerService=function(){function e(){}return Object.defineProperty(e.prototype,"info",{get:function(){return this.isDev()?console.info.bind(console):noop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"warn",{get:function(){return this.isDev()?console.warn.bind(console):noop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"log",{get:function(){return this.isDev()?console.log.bind(console):noop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"error",{get:function(){return this.isDev()?console.error.bind(console):noop},enumerable:!0,configurable:!0}),e.prototype.isDev=function(){return core_1.isDevMode()||this.sessionService&&this.sessionService.isDev},e.prototype.setSession=function(e){this.sessionService=e},e=__decorate([core_1.Injectable()],e)}();exports.loggerService=loggerService;var VersionManagerService=function(){function e(){this._module_versions=[]}return Object.defineProperty(e.prototype,"module_versions",{get:function(){return this._module_versions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"module_version",{set:function(e){var t=this.getModule(e.name);t&&0!=t.length?t=e:this._module_versions.push(e)},enumerable:!0,configurable:!0}),e.prototype.registerModule=function(e){this.module_version={name:e.constructor.name,version:e.version,build_date:e.build_date}},e.prototype.getModule=function(t){return this._module_versions.filter(function(e){return e.name==t})[0]},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.VersionManagerService=VersionManagerService;var MathExpressionCompilerService=function(){function e(){}return e.prototype.do=function(e){return this.evaluate(this.parse(this.lex(e)))},e.prototype.lex=function(e){for(var t=function(e){return/[+\-*\/\^%=(),]/.test(e)},i=function(e){return/[0-9]/.test(e)},s=function(e){return/\s/.test(e)},a=function(e){return"string"==typeof e&&!t(e)&&!i(e)&&!s(e)},r=[],o=0,n=function(){return e[++o]},u=function(e,t){r.push({type:e,value:t})};o<e.length;){var l=e[o];if(s(l))n();else if(t(l))u(l),n();else if(i(l)){for(var c="";c+=l,l=n(),i(l););if("."===l)for(;c+=l,l=n(),i(l););var d=parseFloat(c);if(!isFinite(d))throw"Number is too large or too small for a 64-bit double.";u("number",d)}else{if(!a(l))throw"Unrecognized token: "+l+" at "+o;for(var h=l;a(n());)h+=l;u("identifier",h)}}return u("(end)"),r},e.prototype.parse=function(i){function a(e,t,i,s){var a=r[e]||{};r[e]={lbp:a.lbp||i,nud:a.nud||t,led:a.led||s}}var r={};a("(",function(){var e=l(2);if(")"!==n().type)throw"Expected closing parenthesis ')'";return u(),e}),a("number",function(e){return e}),a("identifier",function(e){if("("!==n().type)return e;var t=[];if(")"===i[o+1].type)u();else{for(;u(),t.push(l(2)),","===n().type;);if(")"!==n().type)throw"Expected closing parenthesis ')'"}return u(),{type:"call",args:t,name:e.value}}),a(","),a(")"),a("(end)");function e(t,e,i,s){i=i||e,a(t,null,e,s||function(e){return{type:t,left:e,right:l(i)}})}var t,s,o=0,n=function(){return function(e){var t=Object.create(r[e.type]);return t.type=e.type,t.value=e.value,t}(i[o])},u=function(){return o++,n()},l=function(e){var t,i=n();if(u(),!i.nud)throw"Unexpected token: "+i.type;for(t=i.nud(i);e<n().lbp;){if(i=n(),u(),!i.led)throw"Unexpected token: "+i.type;t=i.led(t)}return t};s=7,a(t="-",function(){return{type:t,right:l(s)}}),e("^",6,5),e("*",4),e("/",4),e("%",4),e("+",3),e("-",3),e("=",1,2,function(e){if("call"===e.type){for(var t=0;t<e.args.length;t++)if("identifier"!==e.args[t].type)throw"Invalid argument name";return{type:"function",name:e.name,args:e.args,value:l(2)}}if("identifier"===e.type)return{type:"assign",name:e.value,value:l(2)};throw"Invalid lvalue"});for(var c=[];"(end)"!==n().type;)c.push(l(0));return c},e.prototype.evaluate=function(e){for(var s={"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t},"^":function(e,t){return Math.pow(e,t)}},a={pi:Math.PI,e:Math.E},r={sin:Math.sin,cos:Math.cos,tan:Math.cos,asin:Math.asin,acos:Math.acos,atan:Math.atan,abs:Math.abs,round:Math.round,ceil:Math.ceil,floor:Math.floor,log:Math.log,exp:Math.exp,sqrt:Math.sqrt,max:Math.max,min:Math.min,random:Math.random},o={},n=function(i){if("number"===i.type)return i.value;if(s[i.type])return i.left?s[i.type](n(i.left),n(i.right)):s[i.type](n(i.right));if("identifier"===i.type){var e=o.hasOwnProperty(i.value)?o[i.value]:a[i.value];if(void 0===e)throw i.value+" is undefined";return e}if("assign"===i.type)a[i.name]=n(i.value);else{if("call"===i.type){for(var t=0;t<i.args.length;t++)i.args[t]=n(i.args[t]);return r[i.name].apply(null,i.args)}"function"===i.type&&(r[i.name]=function(){for(var e=0;e<i.args.length;e++)o[i.args[e].value]=arguments[e];var t=n(i.value);return o={},t})}},t="",i=0;i<e.length;i++){var u=n(e[i]);void 0!==u&&(t+=u+"\n")}return t},e=__decorate([core_1.Injectable()],e)}();exports.MathExpressionCompilerService=MathExpressionCompilerService;var cookie=function(){function e(){}return e.prototype.getValue=function(e){for(var t=e+"=",i=decodeURIComponent(document.cookie).split(";"),s=0;s<i.length;s++){for(var a=i[s];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(t))return a.substring(t.length,a.length)}return""},e.prototype.setValue=function(e,t,i){void 0===i&&(i=365);var s=new Date;s.setTime(s.getTime()+24*i*60*60*1e3);var a="expires="+s.toUTCString();document.cookie=e+"="+t+";"+a+";path=/"},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.cookie=cookie;var broadcast=function(){function e(){this.message$=new core_1.EventEmitter}return e.prototype.broadcastMessage=function(e,t){void 0===t&&(t={}),this.message$.emit({messagetype:e,messagedata:t})},e=__decorate([core_1.Injectable()],e)}();exports.broadcast=broadcast;var session=function(){function e(e,t){this.logger=e,this.broadcast=t,this.authData={sessionId:null,loaded:!1,userId:null,userName:"",first_name:"",last_name:"",display_name:"",email:"",password:"",admin:!1,dev:!1,renewPass:!1,portalOnly:!1,googleToken:"",userimage:"",companycode_id:"",obtainGDPRconsent:!1},this.sessionData={},this.logger.setSession(this)}return e.prototype.getSessionHeader=function(){var e=new http_1.HttpHeaders;return e=e.set("OAuth-Token",this.authData.sessionId)},e.prototype.setSessionData=function(e,t,i){void 0===i&&(i=!0),this.sessionData[e]=t,i&&sessionStorage.setItem(window.btoa(e+this.authData.sessionId),window.btoa(encodeURIComponent(JSON.stringify(t))))},e.prototype.clearSessionData=function(e){sessionStorage.removeItem(e)},e.prototype.getSessionData=function(e,t){if(void 0===t&&(t=!0),this.sessionData[e])return this.sessionData[e];try{return JSON.parse(decodeURIComponent(window.atob(sessionStorage.getItem(window.btoa(e+this.authData.sessionId)))))}catch(e){return!!t&&{}}},e.prototype.existsData=function(e){try{return sessionStorage[window.btoa(e+this.authData.sessionId)]&&0<sessionStorage[window.btoa(e+this.authData.sessionId)].length}catch(e){return!1}},e.prototype.endSession=function(){this.authData.sessionId=null,this.authData.userId=null,this.authData.loaded=!1,this.authData.userName="",this.authData.first_name="",this.authData.last_name="",this.authData.display_name="",this.authData.email="",this.authData.userimage="",this.authData.password="",this.authData.admin=!1,this.authData.dev=!1,this.authData.renewPass=!1,this.authData.companycode_id="",this.authData.obtainGDPRconsent=!1,this.sessionData={},sessionStorage.clear()},Object.defineProperty(e.prototype,"isAdmin",{get:function(){return this.authData.admin},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDev",{get:function(){return this.authData.dev},enumerable:!0,configurable:!0}),e.prototype.setTimezone=function(e){this.getSessionData("timezone")!==e&&(this.setSessionData("timezone",e,!1),moment.tz.setDefault(e),this.broadcast.broadcastMessage("timezone.changed",e))},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[loggerService,broadcast])],e)}();exports.session=session;var footer=function(){function e(){this.footercontainer=null,this.modalcontainer=null,this.modalbackdrop=null,this.visibleFooterHeight=0}return e=__decorate([core_1.Injectable()],e)}();exports.footer=footer;var configurationService=function(){function e(e,t,i,s,a){var o=this;this.http=e,this.cookie=t,this.session=i,this.broadcast=s,this.router=a,this.initialized=!1,this.sites=[],this.data={backendUrl:"proxy",backendextensions:{},systemparameters:{}},this.appdata={},this.loaded$=new core_1.EventEmitter,this.datachanged$=new core_1.EventEmitter;var r=localStorage.spiceuisites;if(r){this.sites=JSON.parse(atob(r));var n=this.cookie.getValue("spiceuibackend"),u=!1;this.sites.some(function(e){if(e.id==n)return o.setSiteID(e.id),u=!0}),u||this.setSiteID(this.sites[0].id),this.broadcast.message$.subscribe(function(e){return o.handleLogout(e)})}e.get("config/sites/").subscribe(function(e){var t=e,i=t.sites;for(var s in 0==i.length&&o.router.navigate(["/setup"]),t.general)o.data[s]=t.general[s];if(0<i.length&&(o.sites=i,localStorage.spiceuisites=btoa(JSON.stringify(i)),!o.data.id)){var a=o.cookie.getValue("spiceuibackend"),r=!1;o.sites.some(function(e){if(e.id==a)return o.setSiteID(e.id),r=!0}),r||o.setSiteID(i[0].id)}o.initialized=!0})}return e.prototype.handleLogout=function(e){"logout"==e.messagetype&&this.reset()},e.prototype.reset=function(){this.appdata={}},e.prototype.setSiteData=function(e){for(var t in this.sites.push(e),e)this.data[t]=e[t];localStorage.spiceuisites=btoa(JSON.stringify(this.sites)),this.getSysinfo()},e.prototype.setSiteID=function(i){var s=this;return this.sites.some(function(e){if(e.id==i){for(var t in e)s.data[t]=e[t];return s.cookie.setValue("spiceuibackend",i),!0}}),this.getSysinfo(),this.data},e.prototype.getSiteId=function(){return this.data.id},e.prototype.getBackendUrl=function(){return this.data.backendUrl},e.prototype.getFrontendUrl=function(){return void 0!==this.data.frontendUrl?this.data.frontendUrl:""},e.prototype.getUser=function(){return this.data.user},e.prototype.getPassword=function(){return this.data.password},e.prototype.getSysinfo=function(){var t=this,e=this.http.get(this.getBackendUrl()+"/sysinfo");return e.subscribe(function(e){e&&(t.data.languages=e.languages,t.data.backendextensions=e.extensions,t.data.systemparameters=e.systemsettings,t.loaded$.emit(!0))},function(e){}),e},e.prototype.getSystemParamater=function(e){try{return this.data.systemparameters[e]}catch(e){return!1}},e.prototype.checkCapability=function(e){return this.data.backendextensions&&this.data.backendextensions.hasOwnProperty(e)},e.prototype.getCapabilityConfig=function(e){try{return this.data.backendextensions[e]&&this.data.backendextensions[e].config?this.data.backendextensions[e].config:{}}catch(e){return{}}},e.prototype.setData=function(e,t){this.appdata[e]=t,this.datachanged$.emit(e)},e.prototype.getData=function(e){return!!this.appdata[e]&&this.appdata[e]},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.HttpClient,cookie,session,broadcast,router_1.Router])],e)}();exports.configurationService=configurationService;var layout=function(){function e(){this.headerheight=90}return Object.defineProperty(e.prototype,"screenwidth",{get:function(){var e=window.innerWidth;return 1024<=e?"large":768<=e?"medium":"small"},enumerable:!0,configurable:!0}),e=__decorate([core_1.Injectable()],e)}();exports.layout=layout;var metadata=function(){function e(e,t,i,s,a,r,o,n,u){var l=this;this.NgModuleFactoryLoader=e,this.http=t,this.session=i,this.configuration=s,this.componentFactoryResolver=a,this.router=r,this.broadcast=o,this.compiler=n,this.Injector=u,this.componentFactories={},this.role="",this.broadcast.message$.subscribe(function(e){return l.handleMessage(e)})}return Object.defineProperty(e.prototype,"actionSets",{get:function(){return this.configuration.getData("actionsets")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"componentDefaultConfigs",{get:function(){return this.configuration.getData("componentdefaultconfigs")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"componentModuleConfigs",{get:function(){return this.configuration.getData("componentmoduleconfigs")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moduleDirectory",{get:function(){return this.configuration.getData("modules")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"componentDirectory",{get:function(){return this.configuration.getData("components")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"componentSets",{get:function(){return this.configuration.getData("componentsets")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"routes",{get:function(){return this.configuration.getData("routes")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scripts",{get:function(){return this.configuration.getData("scripts")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldSets",{get:function(){return this.configuration.getData("fieldsets")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"validationRules",{get:function(){return this.configuration.getData("validationrules")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldDefs",{get:function(){return this.configuration.getData("fielddefs")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldTypeMappings",{get:function(){return this.configuration.getData("fieldtypemappings")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fieldStatusNetworks",{get:function(){return this.configuration.getData("fieldstatusnetworks")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moduleDefs",{get:function(){return this.configuration.getData("moduledefs")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moduleFilters",{get:function(){return this.configuration.getData("modulefilters")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roles",{get:function(){return this.configuration.getData("roles")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rolemodules",{get:function(){return this.configuration.getData("rolemodules")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"copyrules",{get:function(){return this.configuration.getData("copyrules")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"htmlStyleData",{get:function(){return this.configuration.getData("htmlstyles")},enumerable:!0,configurable:!0}),e.prototype.handleMessage=function(e){var t=this;switch(e.messagetype){case"loader.completed":"loadRepository"==e.messagedata&&this.addRoutes(),"loadModules"==e.messagedata&&(this.roles.some(function(e){if(1==e.defaultrole)return t.role=e.id,!0}),""===this.role&&0<this.roles.length&&(this.role=this.roles[0].id));break;case"metadata.updatefieldsets":for(var i in e.messagedata.add)this.fieldSets[i]=e.messagedata.add[i];for(var i in e.messagedata.update)this.fieldSets[i]=e.messagedata.update[i];for(var i in e.messagedata.delete)delete this.fieldSets[i];break;case"metadata.updatecomponentsets":for(var s in e.messagedata.add)this.componentSets[s]=e.messagedata.add[s];for(var s in e.messagedata.update)this.componentSets[s]=e.messagedata.update[s];for(var s in e.messagedata.delete)delete this.componentSets[s]}},e.prototype.addRoutes=function(){var a=this;System.import("app/systemcomponents/systemcomponents").then(function(e){return e.SystemComponents}).then(function(e){a.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){e.componentFactories.some(function(e){if("SystemNavigationCollector"===e.componentType.name){for(var t=0,i=a.routes;t<i.length;t++){var s=i[t];a.router.config.unshift({path:s.path,component:e.componentType,canActivate:[aclCheck]}),a.router.config.unshift({path:"tab/:tabid/"+s.path,component:e.componentType,canActivate:[aclCheck]})}return!0}})})})},e.prototype.addComponentDirect=function(s,a,r){var o=this,n=new rxjs_1.Subject;if(this.componentDirectory[s])if(this.componentDirectory[s].module){var t=this.componentDirectory[s].module;try{System.import(this.moduleDirectory[t].path).then(function(e){return e[o.moduleDirectory[t].module]}).then(function(e){o.moduleDirectory[t].factories={},o.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){var t=e.componentFactories.find(function(e){return e.componentType.name===s});if(t){var i=a.createComponent(t,void 0,r);i.instance.self=i,n.next(i),n.complete()}else n.error("Cannot find a factory for component "+s),n.complete()})})}catch(e){n.error(e),n.complete()}}else System.import(this.componentDirectory[s].path).then(function(e){return e[s]}).then(function(e){var t=o.componentFactoryResolver.resolveComponentFactory(e),i=a.createComponent(t,void 0,r);i.instance.self=i,n.next(i),n.complete()});else System.import("app/systemcomponents/systemcomponents").then(function(e){return e.SystemComponents}).then(function(e){o.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){e.componentFactories.some(function(e){if("SystemComponentMissing"===e.componentType.name){var t=a.createComponent(e,void 0,r);return t.instance.component=s,n.next(t),n.complete(),!0}})})});return n.asObservable()},e.prototype.checkComponent=function(e){return!!this.componentDirectory[e]},e.prototype.addComponent=function(r,o,n){var u=this,l=new rxjs_1.Subject;if(null!=o)return this.componentDirectory[r]?SystemJS.import("app/systemcomponents/systemcomponents").then(function(e){return e.SystemComponents}).then(function(e){u.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){var s=e.componentFactories.find(function(e){return"SystemComponentContainer"===e.componentType.name}),a=o.createComponent(s,void 0,n);return a.instance.containerComponent=r,a.changeDetectorRef.markForCheck(),a.instance.containerRef.subscribe(function(i){if(u.componentDirectory[r].module){var t=u.componentDirectory[r].module;SystemJS.import(u.moduleDirectory[t].path).then(function(e){return e[u.moduleDirectory[t].module]}).then(function(e){u.moduleDirectory[t].factories={},u.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){if(!(s=e.componentFactories.find(function(e){return e.componentType.name===r})))return console.error("Cannot find a factory for component "+r),!1;var t=i.createComponent(s);return t.instance.self=a,t.changeDetectorRef.markForCheck(),l.next(t),l.complete(),a.instance.loaded=!0})})}else System.import(u.componentDirectory[r].path).then(function(e){return e[r]}).then(function(e){var t=u.componentFactoryResolver.resolveComponentFactory(e),i=o.createComponent(t,void 0,n);i.instance.self=i,l.next(i),l.complete()})}),!0})}):SystemJS.import("app/systemcomponents/systemcomponents").then(function(e){return e.SystemComponents}).then(function(e){u.compiler.compileModuleAndAllComponentsAsync(e).then(function(e){e.componentFactories.some(function(e){if("SystemComponentMissing"===e.componentType.name){var t=o.createComponent(e,void 0,n);return t.instance.component=r,t.changeDetectorRef.markForCheck(),l.next(t),l.complete(),!0}})})}),l.asObservable();console.log("viewchild not defined")},e.prototype.getComponentSet=function(e){return this.componentSets[e]},e.prototype.getAllComponentsets=function(){try{return this.componentSets}catch(e){return""}},e.prototype.addComponentSet=function(e,t,i,s){void 0===s&&(s="custom"),this.componentSets[e]={name:i,module:t,type:s,items:[]}},e.prototype.getRawComponentSets=function(){return this.componentSets},e.prototype.getComponentSets=function(e){void 0===e&&(e="");var t=[];for(var i in this.componentSets)""!==e&&this.componentSets[i].module!==e||t.push({id:i,name:this.componentSets[i].name,module:this.componentSets[i].module,type:this.componentSets[i].type});return t.sort(function(e,t){return e.name?e.name.localeCompare(t.name):1}),t},e.prototype.getComponentSetObjects=function(e){try{return this.componentSets[e].items}catch(e){return[]}},e.prototype.addComponentToComponentset=function(e,t,i){this.componentSets[t].items.push({id:e,component:i,componentconfig:{},sequence:0});for(var s=0,a=0,r=this.componentSets[t].items;a<r.length;a++){r[a].sequence=s,s++}},e.prototype.getRawFieldSets=function(){return this.fieldSets},e.prototype.getFieldSets=function(e,t){void 0===e&&(e=""),void 0===t&&(t="");var i=[];for(var s in this.fieldSets)""!==e&&this.fieldSets[s].module!==e||i.push({id:s,name:this.fieldSets[s].name,module:this.fieldSets[s].module,type:this.fieldSets[s].type});return i.sort(function(e,t){return e.name>t.name?1:-1}),i},e.prototype.getFieldset=function(e){try{return this.fieldSets[e]}catch(e){return""}},e.prototype.getAllFieldsets=function(){try{return this.fieldSets}catch(e){return""}},e.prototype.setFieldset=function(e,t){this.fieldSets[e].name=t.name,this.fieldSets[e].package=t.package},e.prototype.addFieldset=function(e,t,i,s,a){void 0===s&&(s="custom"),void 0===a&&(a=[]),this.fieldSets[e]={items:a,module:t,name:i,type:s}},e.prototype.addFieldsetToFieldset=function(e,t,i){this.fieldSets[t].items.push({id:e,fieldset:i,fieldconfig:{},sequence:0});for(var s=0,a=0,r=this.fieldSets[t].items;a<r.length;a++){r[a].sequence=s,s++}},e.prototype.addFieldToFieldset=function(e,t,i){this.fieldSets[t].items.push({id:e,field:i,fieldconfig:{},sequence:0});for(var s=0,a=0,r=this.fieldSets[t].items;a<r.length;a++){r[a].sequence=s,s++}},e.prototype.removeFieldsetItem=function(e,i){var s=!1;if(this.fieldSets[e].items.some(function(e,t){if(e.id==i.id)return s=t,!0}),!1===s)return!1;this.fieldSets[e].items.splice(s,1);for(var t=0,a=0,r=this.fieldSets[e].items;a<r.length;a++){r[a].sequence=t,t++}return!0},e.prototype.getFieldsetName=function(e){try{return this.fieldSets[e].name}catch(e){return""}},e.prototype.getFieldSetFields=function(e,t){if(void 0===t&&(t=""),this.fieldSets[e]){for(var i=[],s=0,a=this.fieldSets[e].items;s<a.length;s++){var r=a[s];r.field?i.push(r):r.fieldset&&t.indexOf(e)<0&&(i=i.concat(this.getFieldSetFields(r.fieldset,t+":"+e)))}return i}return[]},e.prototype.getFieldSetItems=function(e){return this.fieldSets[e]?this.fieldSets[e].items:[]},e.prototype.getFieldlabel=function(e,t){try{return this.fieldDefs[e][t].vname?this.fieldDefs[e][t].vname:t}catch(e){return t}},e.prototype.getFieldHelpText=function(e,t){try{return this.fieldDefs[e][t].popupHelp}catch(e){return null}},e.prototype.hasField=function(e,t){return this.fieldDefs[e]&&this.fieldDefs[e][t]},e.prototype.getAppModules=function(){var e=[];for(var t in this.moduleDirectory)this.moduleDirectory.hasOwnProperty(t)&&e.push(this.moduleDirectory[t]);return e},e.prototype.getModuleDefs=function(e){return this.moduleDefs[e]},e.prototype.getModuleDuplicatecheck=function(e){try{return"1"===this.moduleDefs[e].duplicatecheck}catch(e){return!1}},e.prototype.getModules=function(){var e=[];for(var t in this.moduleDefs)e.push(t);return e},e.prototype.getModuleById=function(e){for(var t in this.moduleDefs)if(this.moduleDefs[t].id==e)return t;return""},e.prototype.getModuleIcon=function(e){try{return this.moduleDefs[e].icon}catch(e){return!1}},e.prototype.getModuleSingular=function(t){try{return this.moduleDefs[t].singular}catch(e){return t}},e.prototype.getModuleFromSingular=function(e){var t="";for(var i in this.moduleDefs)this.moduleDefs[i].singular==e&&(t=i);return t},e.prototype.getModuleTrackflag=function(e){try{return!!parseInt(this.moduleDefs[e].track,10)}catch(e){return!1}},e.prototype.getModuleFields=function(e){try{return this.fieldDefs[e]?this.fieldDefs[e]:[]}catch(e){return[]}},e.prototype.getModuleDuplicateCheckFields=function(e){var t=[],i=this.getModuleFields(e);for(var s in i)i[s].duplicatecheck&&t.push(s);return t},e.prototype.getModuleValidations=function(e){try{return this.validationRules[e].validations}catch(e){return[]}},e.prototype.getModuleMenu=function(e){try{var t=[];return this.moduleDefs[e].actionset&&(t=this.getActionSetItems(this.moduleDefs[e].actionset)),t}catch(e){return[]}},e.prototype.getModuleListTypes=function(e){try{return this.moduleDefs[e].listtypes}catch(e){return[]}},e.prototype.addModuleListType=function(e,t){this.moduleDefs[e].listtypes.push(t)},e.prototype.updateModuleListType=function(e,i){this.moduleDefs[e].listtypes.some(function(e){if(e.id==i.id){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t]);return!0}})},e.prototype.deleteModuleListType=function(e,t){var i=this.moduleDefs[e].listtypes.findIndex(function(e){return e.id==t});return 0<=i&&this.moduleDefs[e].listtypes.splice(i,1),this.moduleDefs[e].listtypes},e.prototype.getModuleAggregates=function(e){return this.moduleDefs[e].ftsaggregates},e.prototype.getFieldDefs=function(e,t){try{return this.fieldDefs[e][t]}catch(e){return"varchar"}},e.prototype.checkStatusManaged=function(e){for(var t in this.fieldDefs[e])if(this.getFieldDefs(e,t).options&&this.fieldStatusNetworks[this.getFieldDefs(e,t).options])return{statusField:this.getFieldDefs(e,t).name,statusNetwork:this.fieldStatusNetworks[this.getFieldDefs(e,t).options]};return!1},e.prototype.getFieldType=function(e,t){try{return this.fieldDefs[e][t].type}catch(e){return"varchar"}},e.prototype.getFieldSource=function(e,t){try{return this.fieldDefs[e][t].source}catch(e){return""}},e.prototype.getFieldOptions=function(e,t){try{return this.fieldDefs[e][t].options}catch(e){return!1}},e.prototype.getFieldRequired=function(e,t){try{return this.fieldDefs[e][t].required}catch(e){return!1}},e.prototype.getSystemModules=function(){var e=[];for(var t in this.moduleDirectory)e.push(this.moduleDirectory[t]);return e.sort(function(e,t){return e.module>t.module?1:-1}),e},e.prototype.getSystemModuleByComponent=function(e){for(var t in this.componentDirectory)if(t==e)return this.componentDirectory[t].module;return null},e.prototype.getSystemComponents=function(e){var t=[];for(var i in this.componentDirectory)e&&e!=this.componentDirectory[i].module||t.push(this.componentDirectory[i]);return t.sort(function(e,t){return e.component>t.component?1:-1}),t},e.prototype.getComponentConfigOptions=function(e){try{return this.componentDirectory[e].componentconfig}catch(e){return{}}},e.prototype.getComponentConfigurations=function(e){return void 0===e&&(e="*"),"*"===e?this.componentDefaultConfigs:this.componentModuleConfigs[e]?this.componentModuleConfigs[e]:{}},e.prototype.getComponentConfig=function(e,t,i){return void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=""),""===i&&(i=this.role?this.role:"*"),""!=t&&this.componentModuleConfigs[t]&&this.componentModuleConfigs[t][e]&&this.componentModuleConfigs[t][e][i]?this.componentModuleConfigs[t][e][i]:""!=t&&this.componentModuleConfigs[t]&&this.componentModuleConfigs[t][e]&&this.componentModuleConfigs[t][e]["*"]?this.componentModuleConfigs[t][e]["*"]:this.componentDefaultConfigs[e]&&this.componentDefaultConfigs[e][i]?this.componentDefaultConfigs[e][i]:this.componentDefaultConfigs[e]&&this.componentDefaultConfigs[e]["*"]?this.componentDefaultConfigs[e]["*"]:{}},e.prototype.getModuleDefaultComponentConfigByUsage=function(e,t){var i="";switch(t){case"list":i="ObjectList";break;case"details":i="ObjectRecordDetails"}return this.getComponentConfig(i,e)},e.prototype.getRawActionSets=function(){return this.actionSets},e.prototype.getActionSets=function(e){void 0===e&&(e="");var t=[];for(var i in this.actionSets)""!==e&&this.actionSets[i].module!==e||t.push({id:i,name:this.actionSets[i].name,module:this.actionSets[i].module,type:this.actionSets[i].type,package:this.actionSets[i].package,actions:this.actionSets[i].actions});return t.sort(function(e,t){return e.name>t.name?1:-1}),t},e.prototype.getActionSet=function(e){return this.actionSets[e]},e.prototype.getActionSetItems=function(e){try{return this.actionSets[e].actions}catch(e){return[]}},e.prototype.setActionset=function(e,t){this.actionSets[e].name=t.name,this.actionSets[e].package=t.package},e.prototype.setActionSet=function(e,t){this.actionSets[e]={id:e,module:t.module,name:t.name,package:t.package,version:t.version,actions:t.actions,type:t.type}},e.prototype.setActionSetItems=function(e,t){this.actionSets[e].actions=t},e.prototype.addActionset=function(e,t,i,s,a){void 0===s&&(s="custom"),void 0===a&&(a=[]),this.actionSets[e]={items:a,module:t,name:i,type:s}},e.prototype.removeActionset=function(e){delete this.actionSets[e]},e.prototype.removeActionsetItem=function(e,i){var s=!1;if(this.actionSets[e].items.some(function(e,t){if(e.id==i.id)return s=t,!0}),!1===s)return!1;this.actionSets[e].items.splice(s,1);for(var t=0,a=0,r=this.actionSets[e].items;a<r.length;a++){r[a].sequence=t,t++}return!0},e.prototype.getActionsetName=function(e){try{return this.actionSets[e].name}catch(e){return""}},e.prototype.getModuleFilters=function(e){void 0===e&&(e="");var t=[];for(var i in this.moduleFilters)if(this.moduleFilters.hasOwnProperty(i)){if(""!==e&&this.moduleFilters[i].module!==e)continue;t.push(this.moduleFilters[i])}return t.sort(function(e,t){return e.name-t.name}),t},e.prototype.getModuleFilter=function(e){try{return this.moduleFilters[e]}catch(e){return""}},e.prototype.setModuleFilter=function(e,t,i,s){void 0===s&&(s="custom"),this.moduleFilters||this.configuration.setData("moduleFilters",{}),this.moduleFilters[e]={id:e,name:t,module:i,type:s}},e.prototype.removeModuleFilter=function(e){delete this.moduleFilters[e]},e.prototype.checkModuleAcl=function(e,t){try{return t?this.moduleDefs[e].acl[t]:!!this.moduleDefs[e]}catch(e){return!1}},e.prototype.getRoles=function(){return this.roles},e.prototype.getActiveRole=function(){var t=this,i={};return this.roles&&this.roles.some(function(e){if(t.role==e.id)return i=e,!0}),i},e.prototype.setActiveRole=function(e){this.role=e},e.prototype.getRoleModules=function(e){void 0===e&&(e=!1);var t=[];if(this.rolemodules[this.role])for(var i=0,s=this.rolemodules[this.role];i<s.length;i++){var a=s[i];(!1===e||null!==a.sequence)&&this.moduleDefs[a.module]&&this.moduleDefs[a.module].visible&&(!this.moduleDefs[a.module].visibleaclaction||this.moduleDefs[a.module].visibleaclaction&&this.checkModuleAcl(a.module,this.moduleDefs[a.module].visibleaclaction))&&this.moduleDefs[a.module].acl.list&&t.push(a.module)}return t},e.prototype.getCopyRules=function(e,t){return this.copyrules[e]&&this.copyrules[e][t]?this.copyrules[e][t]:[]},e.prototype.getFieldTypes=function(){var e=[];for(var t in this.fieldTypeMappings)e.push(t);return e},e.prototype.getFieldTypeComponent=function(e){return this.fieldTypeMappings[e]},e.prototype.getRouteDetails=function(r){var e;return null===(e=this.routes)||void 0===e?void 0:e.find(function(e){if(e.path==r)return!0;if(r.split("/").length==e.path.split("/").length){for(var t=r.split("/"),i=e.path.split("/"),s=!0,a=0;a<t.length&&s;)":"!==i[a].substr(0,1)&&i[a]!==t[a]&&(s=!1),a++;if(s)return!0}})},e.prototype.getRouteComponent=function(r){var e;return!!this.routes&&(null===(e=this.routes.find(function(e){if(e.path==r)return!0;if(r.split("/").length==e.path.split("/").length){for(var t=r.split("/"),i=e.path.split("/"),s=!0,a=0;a<t.length&&s;)":"!==i[a].substr(0,1)&&i[a]!==t[a]&&(s=!1),a++;if(s)return!0}}))||void 0===e?void 0:e.component)},e.prototype.checkTagging=function(e){try{return!!this.moduleDefs[e].tagging}catch(e){return!1}},e.prototype.loadLibs=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var s=[];e.forEach(function(e){s.push(t.loadLib(e))});for(var a=new rxjs_1.Subject,r=0,o=0,n=s;o<n.length;o++){n[o].subscribe(function(e){r++},function(e){r++,console.error(e),a.error(e)},function(){r==s.length&&(a.next(),a.complete())})}return r==s.length?rxjs_1.of(a):a.asObservable()},e.prototype.loadLib=function(t){var i=this,s=new rxjs_1.Subject;if(!this.scripts[t])return rxjs_1.of({script:t,loaded:!1,status:"Unknown"});if(this.isLibLoaded(t))return rxjs_1.of({script:t,loaded:!0,status:"Already Loaded"});if(this.isLibLoading(t))for(var e=0,a=this.scripts[t];e<a.length;e++){var r=a[e];if(r.loading)return r.loading$.subscribe(function(e){return i.loadLib(t).subscribe(function(e){s.next(e),s.complete()})}),s.asObservable()}else{for(var o=0,n=this.scripts[t];o<n.length;o++){var u=n[o];if(!u.loaded)return this.loadScript(u).subscribe(function(e){i.loadLib(t).subscribe(function(e){s.next(e),s.complete()})}),s.asObservable()}s.next({script:t,loaded:!0,status:"Loaded"}),s.complete()}return s.asObservable()},e.prototype.loadScript=function(t){var i=new rxjs_1.Subject;t.loading=!0,t.loading$=new core_1.EventEmitter;var e={};return t.src.endsWith(".css")?((e=document.createElement("link")).rel="stylesheet",e.href=t.src):((e=document.createElement("script")).type="text/javascript",e.src=t.src),e.readyState?e.onreadystatechange=function(){"loaded"!==e.readyState&&"complete"!==e.readyState||(e.onreadystatechange=null,t.loaded=!0,t.loading=!1,i.next({script:t.src,loaded:!0,status:"Loaded"}),i.complete(),t.loading$.emit("loaded"))}:e.onload=function(){t.loaded=!0,t.loading=!1,i.next({script:t.src,loaded:!0,status:"Loaded"}),i.complete(),t.loading$.emit("loaded")},e.onerror=function(e){t.loading=!1,i.error({script:t.src,loaded:!1,status:"Failed"}),t.loading$.emit("failed")},document.getElementsByTagName("head")[0].appendChild(e),i.asObservable()},e.prototype.isLibLoaded=function(e){if(this.scripts[e]){for(var t=0,i=this.scripts[e];t<i.length;t++){if(!i[t].loaded)return!1}return!0}return!1},e.prototype.isLibLoading=function(e){if(this.scripts[e]){for(var t=0,i=this.scripts[e];t<i.length;t++){if(i[t].loading)return!0}return!1}return!1},e.prototype.getHtmlStylesheetCode=function(e){return _.isObject(this.htmlStyleData.stylesheets[e])&&_.isString(this.htmlStyleData.stylesheets[e].csscode)?this.htmlStyleData.stylesheets[e].csscode:""},e.prototype.getHtmlFormats=function(e){return _.isObject(this.htmlStyleData.stylesheets[e])?(_.isArray(this.htmlStyleData.stylesheets[e].formats)||(this.htmlStyleData.stylesheets[e].formats=[]),this.htmlStyleData.stylesheets[e].stylesDecoded||this.htmlStylesToObjects(e),this.htmlStyleData.stylesheets[e].formats):(console.log("HTML Styling: Unknown style sheet with ID "+e+"."),[])},e.prototype.htmlStylesToObjects=function(e){for(var t=0,i=this.htmlStyleData.stylesheets[e].formats;t<i.length;t++){var s=i[t],a=void 0;if(_.isEmpty(s.styles))s.styles=null;else{try{a=JSON.parse(s.styles)}catch(e){console.log("HTML Styling: Malformed style specification in table sysuihtmlformats (format id: "+s.id+")."),a={}}s.styles=a}}this.htmlStyleData.stylesheets[e].stylesDecoded=!0},e.prototype.getHtmlStylesheetNames=function(){var e=[];for(var t in this.htmlStyleData.stylesheets)e.push({id:this.htmlStyleData.stylesheets[t].id,name:this.htmlStyleData.stylesheets[t].name});return _.sortBy(e,"name")},e.prototype.getHtmlStylesheetToUse=function(e,t){return _.isObject(this.htmlStyleData.stylesheetsToUse[e])&&this.htmlStyleData.stylesheetsToUse[e][t]?this.htmlStyleData.stylesheetsToUse[e][t]:""},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[core_1.NgModuleFactoryLoader,http_1.HttpClient,session,configurationService,core_1.ComponentFactoryResolver,router_1.Router,broadcast,core_1.Compiler,core_1.Injector])],e)}();exports.metadata=metadata;var aclCheck=function(){function e(e,t,i){this.metadata=e,this.router=t,this.session=i}return e.prototype.canActivate=function(e,t){return!(!this.session||!this.session.authData.sessionId)&&(!!("Users"!==e.params.module||e.params.id&&e.params.id==this.session.authData.userId||this.session.authData.admin)&&(!(e.params.module&&"Home"!=e.params.module&&!this.metadata.checkModuleAcl(e.params.module,e.data.aclaction))||(this.router.navigate(["/modules/Home"]),!1)))},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,router_1.Router,session])],e)}();exports.aclCheck=aclCheck;var language=function(){function e(e,t,i,s,a){this.http=e,this.configurationService=t,this.session=i,this.metadata=s,this.cookie=a,this.languagedata={},this._currentlanguage="",this.currentlanguage$=new core_1.EventEmitter}return Object.defineProperty(e.prototype,"currentlanguage",{get:function(){return this._currentlanguage},set:function(e){"string"==typeof e&&null!==e||(e=this.getDefaultLanguage()),this._currentlanguage=e,this.cookie.setValue("spiceuilanguage",e)},enumerable:!0,configurable:!0}),e.prototype.getLanguage=function(e){if(sessionStorage[window.btoa("languageData"+this.session.authData.sessionId)]&&0<sessionStorage[window.btoa("languageData"+this.session.authData.sessionId)].length&&!this.configurationService.data.developerMode){var t=this.session.getSessionData("languageData");this.languagedata=t,""==this.currentlanguage&&(this.currentlanguage=t.languages.default),e.next("getLanguage")}else this.loadLanguage().subscribe(function(){e.next("getLanguage")})},e.prototype.loadLanguage=function(){var i=this,s=new rxjs_1.Subject,e={modules:JSON.stringify(this.metadata.getModules())};return""==this.currentlanguage&&this.cookie.getValue("spiceuilanguage")&&(this.currentlanguage=this.cookie.getValue("spiceuilanguage")),""!=this.currentlanguage&&(e.lang=this.currentlanguage),this.http.get(this.configurationService.getBackendUrl()+"/language/"+this.currentlanguage,{headers:this.session.getSessionHeader(),observe:"response"}).subscribe(function(e){var t=e.body;i.session.setSessionData("languageData",t),i.languagedata=t,""==i.currentlanguage&&(i.currentlanguage=t.languages.default),i.currentlanguage$.emit(i.currentlanguage),s.next(!0),s.complete()}),s.asObservable()},e.prototype.getLabel=function(t,e,i){void 0===e&&(e=""),void 0===i&&(i="default");try{return""!=e&&void 0!==this.languagedata.mod&&null!=this.languagedata.mod[e]&&this.languagedata.mod[e][t]?this.languagedata.mod[e][t]:this.getAppLanglabel(t,i)}catch(e){return t}},e.prototype.getAppLanglabel=function(e,t){return void 0===t&&(t="default"),this.languagedata.applang[e]?"object"==typeof this.languagedata.applang[e]&&this.languagedata.applang[e][t]?this.getNestedLabel(e,t):this.getNestedLabel(e):e},e.prototype.getNestedLabel=function(e,t){var i;if(void 0===t&&(t="default"),this.languagedata.applang[e]&&(_.isObject(this.languagedata.applang[e])?i=this.languagedata.applang[e][t]?this.languagedata.applang[e][t]:this.languagedata.applang[e].default:_.isString(this.languagedata.applang[e])&&(i=this.languagedata.applang[e])),i){var s=this.getNestedTags(i);if(s)for(var a=0,r=s;a<r.length;a++){var o=r[a];i=i.replace("{LABEL:"+o+"}",this.getNestedLabel(o,t))}}return i||e},e.prototype.getNestedTags=function(e){for(var t=e.indexOf("{LABEL:"),i=[];0<=t;)if(0<=t){var s=e.indexOf("}",t);t=0<=s?(i.push(e.substring(t+7,s)),e.indexOf("{LABEL:",s)):-1}return i},e.prototype.getLabelFormatted=function(e,t,i){var s;void 0===i&&(i="default"),s=Array.isArray(t)?t:new Array(t);var a=0;return this.getLabel(e,"",i).replace(/%(s|%)/g,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return"s"===e[1]?s[a++]:"%"===e[1]?"%":e[0]})},e.prototype.getModuleName=function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i="default");try{var s=this.metadata.getModuleDefs(t);if(e){if(s.singular_label)return this.getAppLanglabel(s.singular_label,i);if(this.languagedata.applist.moduleListSingular[t])return this.languagedata.applist.moduleListSingular[t]}else if(s.module_label)return this.getAppLanglabel(s.module_label,i);return this.languagedata.applist.moduleList[t]}catch(e){return t}},e.prototype.getModuleCombinedLabel=function(e,t){return this.languagedata.applang[e+"_"+t.toUpperCase()]?this.getLabel(e+"_"+t.toUpperCase()):this.getLabel(e)+" "+this.getModuleName(t)},e.prototype.getFieldDisplayName=function(e,t,i,s){void 0===i&&(i={}),void 0===s&&(s="default");var a="";if(i.label)if(0<i.label.indexOf(":")){var r=i.label.split(":");a=this.getLabel(r[1],r[0])}else a=this.getLabel(i.label,e,s);else a=this.getLabel(this.metadata.getFieldlabel(e,t),e,s);return""===a?i.label?i.label:t:a},e.prototype.getFieldHelpText=function(e,t,i){void 0===i&&(i={});var s="";if(i.popupHelp)if(0<i.popupHelp.indexOf(":")){var a=i.popupHelp.split(":");s=this.getLabel(a[1],a[0],"default")}else s=this.getLabel(i.popupHelp,e,"default");else s=this.getLabel(this.metadata.getFieldHelpText(e,t),e,"default");return""===s?i.popupHelp?i.popupHelp:t:s},e.prototype.getFieldDisplayOptions=function(e,t,i){void 0===i&&(i=!1);var s=this.metadata.getFieldOptions(e,t);if(!1===s)return[];try{var a=this.languagedata.applist[s];if(i){var r=a;for(var o in a=[],r)a.push({value:o,display:r[o]})}return a}catch(e){return[]}},e.prototype.getDisplayOptions=function(e,t){void 0===t&&(t=!1);var i=this.languagedata.applist[e];if(t){var s=i;for(var a in i=[],s)i.push({value:a,display:s[a]})}return i},e.prototype.getFieldDisplayOptionValue=function(e,t,i){var s=this.metadata.getFieldOptions(e,t);if(!1===s)return i;try{return this.languagedata.applist[s][i]?this.languagedata.applist[s][i]:i}catch(e){return i}},e.prototype.getAvialableLanguages=function(e){void 0===e&&(e=!1);for(var t=[],i=0,s=this.languagedata.languages.available;i<s.length;i++){var a=s[i];(!e||a.system_language&&0!=a.system_language)&&t.push({language:a.language_code,text:a.language_name,system_language:a.system_language,communication_language:a.communication_language,default_language:a.language_code==this.languagedata.languages.default})}return t},e.prototype.addAvailableLanguage=function(t){var i=this,s=!1;this.languagedata.languages.available.some(function(e){if(e.language_code==t.language_code)return e.system_language=t.system_language,e.default_language=t.default_language,t.default_language&&i.setDefaultLanguage(t.language_code),s=!0}),s||this.languagedata.languages.available.push(t)},e.prototype.removeAvailableLanguage=function(e){this.languagedata.languages.available.some(function(e){if(e.language_code==e)return!(e.system_language=!1)})},e.prototype.getDefaultLanguage=function(){return this.languagedata.languages.default},e.prototype.setDefaultLanguage=function(t){var i=this;this.http.post(this.configurationService.getBackendUrl()+"/syslanguages/setdefault/"+t,{},{headers:this.session.getSessionHeader(),observe:"response"}).subscribe(function(e){e.body.success&&(i.languagedata.languages.default=t)})},e.prototype.getLangText=function(t){var i=t;return this.languagedata.languages.available.some(function(e){if(e.language_code==t)return i=e.language_name,!0}),i},e.prototype.searchLabel=function(e,t){void 0===t&&(t=10);var i=[],s=e.toLowerCase().split(" ");for(var a in this.languagedata.applang){for(var r=!0,o=0,n=s;o<n.length;o++){var u=n[o];if(a.toLocaleLowerCase().indexOf(u)<0){r=!1;break}}if(r&&i.push({label:a,translation:this.getAppLanglabel(a)}),i.length>=t)break}return i},e.prototype.addLabel=function(e,t,i,s){void 0===t&&(t=""),void 0===i&&(i=""),void 0===s&&(s=""),this.languagedata.applang[e]={default:t,long:s,short:i}},e.prototype.compareStrings=function(e,t){return e.localeCompare(t,this._currentlanguage.slice(0,2))},e.prototype.sortArray=function(e,i){var s=this;void 0===i&&(i=!1),e.sort(function(e,t){return s.compareStrings(e,t)*(i?-1:1)})},e.prototype.sortObjects=function(e,i,s){var a=this;void 0===s&&(s=!1),e.sort(function(e,t){return a.compareStrings(e[i],t[i])*(s?-1:1)})},e.prototype.ucFirst=function(e){return e.charAt(0).toLocaleUpperCase(this._currentlanguage.slice(0,2))+e.slice(1)},e.prototype.lcFirst=function(e){return e.charAt(0).toLocaleLowerCase(this._currentlanguage.slice(0,2))+e.slice(1)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.HttpClient,configurationService,session,metadata,cookie])],e)}();exports.language=language,moment.defaultFormat="YYYY-MM-DD HH:mm:ss";var modelutilities=function(){function e(e,t,i){this.metadata=e,this.mathcomp=t,this.session=i}var i;return(i=e).prototype.getRand=function(){return Math.random()},e.prototype.S4=function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},e.prototype.generateGuid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},e.prototype.backendModel2spice=function(e,t){var i=this.metadata.getModuleFields(e);for(var s in i)t[s]&&(t[s]=this.backend2spice(e,s,t[s]));return t},e.prototype.backend2spice=function(e,t,i){var s=this.metadata.getFieldDefs(e,t);if(!s||!s.type)return i;switch(s.type){case"date":if(moment.isMoment(i))return i;var a=moment(i);return a.isValid()?a:null;case"datetime":case"datetimecombo":if(moment.isMoment(i))return i;var r=this.session.getSessionData("timezone")||moment.tz.guess(!0),o="string"==typeof r&&0<r.length?moment.utc(i).tz(r):moment(i);return o.isValid()?o:null;case"double":case"currency":return i?parseFloat(i):0;case"int":return i?parseInt(i,10):0;case"bool":case"boolean":return"1"==i||0<i||1==i;case"json":try{return _.isObject(i)?i:i?JSON.parse(i):{}}catch(e){return{}}case"link":if(_.isObject(i)&&i.beans&&s.module)for(var n in i.beans)i.beans[n]=this.backendModel2spice(s.module,i.beans[n]);return i;default:return i}},e.prototype.spiceModel2backend=function(e,t){var i=__assign({},t),s=this.metadata.getModuleFields(e);for(var a in s)t.hasOwnProperty(a)&&(i[a]=this.spice2backend(e,a,t[a]));return i},e.prototype.spice2backend=function(e,t,i){var s=this.metadata.getFieldDefs(e,t);if(!s||!s.type)return i;switch(s.type){case"date":if("string"!=typeof i)return i&&i._isAMomentObject&&i.isValid()?i.format("YYYY-MM-DD"):"";var a=moment(i);return a.isValid()?a.format("YYYY-MM-DD"):"";case"datetime":case"datetimecombo":if("string"!=typeof i)return i&&i._isAMomentObject&&i.isValid()?moment(i).utc().format("YYYY-MM-DD HH:mm:ss"):"";var r=this.session.getSessionData("timezone")||moment.tz.guess(!0),o="string"==typeof r&&0<r.length?moment(i).tz(r):moment(i);return o.isValid()?o.utc().format("YYYY-MM-DD HH:mm:ss"):"";case"json":return i?JSON.stringify(i):"";case"link":if(_.isObject(i)&&i.beans&&s.module)for(var n in i.beans)i.beans[n]=this.spiceModel2backend(s.module,i.beans[n]);return i;case"bool":case"boolean":return i&&("1"==i||0<i||!0===i)?"1":"0";default:return i}},e.prototype.formatDate=function(e){return moment(e).format("YYYY-MM-DD")},e.prototype.cleanAccountName=function(e){for(var t=e.toLowerCase(),i=(t=t.replace(/[^\w\s]/gi,"")).split(" "),s=0,a=["ag","gmbh","gesmbh","corp","inc"];s<a.length;s++){var r=a[s],o=i.indexOf(r);0<=o&&i.splice(o,1)}return i.join(" ")},e.compare=function(e,t,i){switch(t){case"in":case"between":break;case"contain":return-1!==e.indexOf(i);case"greaterequal":return i<=e;case"greater":return i<e;case"lesserequal":return e<=i;case"lesser":return e<i;case"unequal":return e!=i;case"equal":default:return e==i}},e.strtobool=function(e){if("string"!=typeof e)return!1;switch(e.toLowerCase().trim()){case"false":case"no":case"0":case"":return!1;default:return!0}},e.strtomoment=function(e,t){return moment(i.strtotime(e,t),"X")},e.strtotime=function(e,t){var i,s,a,r,o,n,u,l,c,d;if(!e)return!1;e=e.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/[\t\r\n]/g,"").toLowerCase();var h=new RegExp(["^(\\d{1,4})","([\\-\\.\\/:])","(\\d{1,2})","([\\-\\.\\/:])","(\\d{1,4})","(?:\\s(\\d{1,2}):(\\d{2})?:?(\\d{2})?)?","(?:\\s([A-Z]+)?)?$"].join(""));if((s=e.match(h))&&s[2]===s[4])if(1901<s[1])switch(s[2]){case"-":return!(12<s[3]||31<s[5])&&new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3;case".":return!1;case"/":return!(12<s[3]||31<s[5])&&new Date(s[1],parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3}else if(1901<s[5])switch(s[2]){case"-":case".":return!(12<s[3]||31<s[1])&&new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3;case"/":return!(12<s[1]||31<s[3])&&new Date(s[5],parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3}else switch(s[2]){case"-":return!(12<s[3]||31<s[5]||s[1]<70&&38<s[1])&&(r=0<=s[1]&&s[1]<=38?+s[1]+2e3:s[1],new Date(r,parseInt(s[3],10)-1,s[5],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3);case".":return 70<=s[5]?!(12<s[3]||31<s[1])&&new Date(s[5],parseInt(s[3],10)-1,s[1],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3:s[5]<60&&!s[6]&&(!(23<s[1]||59<s[3])&&(a=new Date,new Date(a.getFullYear(),a.getMonth(),a.getDate(),s[1]||0,s[3]||0,s[5]||0,s[9]||0).getTime()/1e3));case"/":return!(12<s[1]||31<s[3]||s[5]<70&&38<s[5])&&(r=0<=s[5]&&s[5]<=38?+s[5]+2e3:s[5],new Date(r,parseInt(s[1],10)-1,s[3],s[6]||0,s[7]||0,s[8]||0,s[9]||0).getTime()/1e3);case":":return!(23<s[1]||59<s[3]||59<s[5])&&(a=new Date,new Date(a.getFullYear(),a.getMonth(),a.getDate(),s[1]||0,s[3]||0,s[5]||0).getTime()/1e3)}if("now"===e)return null===t||isNaN(t)?(new Date).getTime()/1e3|0:0|t;if(!isNaN(i=Date.parse(e)))return i/1e3|0;if(h=new RegExp(["^([0-9]{4}-[0-9]{2}-[0-9]{2})","[ t]","([0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]+)?)","([\\+-][0-9]{2}(:[0-9]{2})?|z)"].join("")),(s=e.match(h))&&("z"===s[4]?s[4]="Z":s[4].match(/^([+-][0-9]{2})$/)&&(s[4]=s[4]+":00"),!isNaN(i=Date.parse(s[1]+"T"+s[2]+s[4]))))return i/1e3|0;function p(e){var t=e.split(" "),i=t[0],s=t[1].substring(0,3),a=/\d+/.test(i),r=("last"===i?-1:1)*("ago"===t[2]?-1:1);if(a&&(r*=parseInt(i,10)),u.hasOwnProperty(s)&&!t[1].match(/^mon(day|\.)?$/i))return o["set"+u[s]](o["get"+u[s]]()+r);if("wee"===s)return o.setDate(o.getDate()+7*r);if("next"===i||"last"===i)!function(e,t,i){var s,a=n[t];void 0!==a&&(0===(s=a-o.getDay())?s=7*i:0<s&&"last"===e?s-=7:s<0&&"next"===e&&(s+=7),o.setDate(o.getDate()+s))}(i,s,r);else if(!a)return!1;return!0}if(o=t?new Date(1e3*t):new Date,n={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6},u={yea:"FullYear",mon:"Month",day:"Date",hou:"Hours",min:"Minutes",sec:"Seconds"},"([+-]?\\d+\\s"+(c="(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)")+"|(last|next)\\s"+c+")(\\sago)?",!(s=e.match(new RegExp("([+-]?\\d+\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?)|(last|next)\\s(years?|months?|weeks?|days?|hours?|minutes?|min|seconds?|sec|sunday|sun\\.?|monday|mon\\.?|tuesday|tue\\.?|wednesday|wed\\.?|thursday|thu\\.?|friday|fri\\.?|saturday|sat\\.?))(\\sago)?","gi"))))return!1;for(d=0,l=s.length;d<l;d++)if(!p(s[d]))return!1;return o.getTime()/1e3},e.prototype.http_build_query=function(e,t,i){void 0===t&&(t=""),void 0===i&&(i="&");var s=[],r=function(e,t,i){var s=[];if(!0===t?t="1":!1===t&&(t="0"),null===t)return"";if("object"==typeof t){for(var a in t)null!==t[a]&&s.push(r(e+"["+a+"]",t[a],i));return s.join(i)}if("function"!=typeof t)return encodeURIComponent(e)+"="+encodeURIComponent(t);throw new Error("There was an error processing for http_build_query().")};for(var a in i=i||"&",e){var o=e[a];t&&!isNaN(parseFloat(a))&&(a=String(t)+a);var n=r(a,o,i);""!==n&&s.push(n)}return s.join(i)},e.prototype.compileMathExpression=function(e){try{return this.mathcomp.do(e)}catch(e){return console.warn(e),!1}},e.prototype.timezoneChanged=function(e,t){for(var i in e)if(_.isObject(e[i]))if(e[i]&&e[i]._isAMomentObject)e[i]._isUTC&&e[i].tz(t);else if(e[i].beans&&_.isObject(e[i].beans))for(var s in e[i].beans)this.timezoneChanged(e[i].beans[s],t)},e=i=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,MathExpressionCompilerService,session])],e)}();exports.modelutilities=modelutilities;var toast=function(){function e(e,t){this.modelutilities=e,this.appref=t,this.activeToasts=[]}return e.prototype.sendToast=function(e,t,i,s,a){return void 0===t&&(t="default"),void 0===i&&(i=""),void 0===s&&(s=!0),this.addToast(e,"toast",t,i,s,a)},e.prototype.sendAlert=function(e,t,i,s,a){return void 0===t&&(t="default"),void 0===i&&(i=""),void 0===s&&(s=!0),this.addToast(e,"alert",t,i,s,a)},e.prototype.addToast=function(e,t,i,s,a,r){var o=this;if(void 0===t&&(t="toast"),void 0===i&&(i="default"),void 0===s&&(s=""),void 0===a&&(a=!0),r&&0<this.activeToasts.filter(function(e){return e.code==r}).length)return"";"error"===i&&(a=!1),!0===a&&(a=5);var n=this.modelutilities.generateGuid();return this.activeToasts.push({id:n,type:i,theme:t,text:e,description:s,code:r}),this.appref.tick(),a&&window.setTimeout(function(){return o.clearToast(n)},1e3*a),n},e.prototype.clearToast=function(i){var s=this;i&&this.activeToasts.some(function(e,t){if(e.id===i)return s.activeToasts.splice(t,1),s.appref.tick(),!0})},e.prototype.clearAll=function(){this.activeToasts=[],this.appref.tick()},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,core_1.ApplicationRef])],e)}();exports.toast=toast;var modalwindow=function(){function e(){}return e=__decorate([core_1.Injectable()],e)}();exports.modalwindow=modalwindow;var modal=function(){function e(e,t,i,s){var a=this;this.metadata=e,this.footer=t,this.toast=i,this.language=s,this.modalsArray=[],this.modalsObject={},window.addEventListener("keyup",function(e){if(27===e.keyCode&&a.modalsArray.length){e.stopImmediatePropagation();var t=a.modalsArray[a.modalsArray.length-1].wrapper;!t.instance.escKey||t.instance.childComponent.instance.onModalEscX&&!1===t.instance.childComponent.instance.onModalEscX()||t.destroy()}})}return e.prototype.openModal=function(s,e,a){var r=this;if(void 0===e&&(e=!0),this.metadata.checkComponent(s)){var o=new rxjs_1.Subject;return this.metadata.addComponentDirect("SystemModalWrapper",this.footer.modalcontainer).subscribe(function(t){var i={};(i.wrapper=t).instance.escKey=e,r.modalsArray.push(i),r.modalsObject[i.modalId]=i,r.metadata.addComponentDirect(s,t.instance.target,a).subscribe(function(e){e.instance.self=t,i.component=e,t.instance.childComponent=e,o.next(e),o.complete()},function(e){r.removeModal(t),r.sendError(s),o.error(e),o.complete()}),t.instance.zIndex=2*r.modalsArray.length+1}),o.asObservable()}return this.sendError(s),rxjs_1.of(!1)},e.prototype.sendError=function(e){this.toast.sendToast('Component "'+e+'" not found.',"error","Misconfiguration on the system as the component should have been opened in a modal but is not avilable. Please contact your system administrator.")},e.prototype.removeModal=function(e){for(var t=0;t<this.modalsArray.length;t++)if(this.modalsArray[t].wrapper===e){this.modalsArray.splice(t,1);break}},e.prototype.closeModal=function(e){if("number"==typeof e)this.modalsArray[e]&&this.modalsArray[e].wrapper.destroy();else for(var t=0;t<this.modalsArray.length;t++)if(this.modalsArray[t].wrapper===e){this.modalsArray.splice(t,1);break}},e.prototype.closeAllModals=function(){for(var e=this.modalsArray.length-1;0<=e;e--)this.modalsArray[e].wrapper.destroy()},Object.defineProperty(e.prototype,"backdropVisible",{get:function(){return 0!==this.modalsArray.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backdropZindex",{get:function(){return 2*this.modalsArray.length},enumerable:!0,configurable:!0}),e.prototype.prompt=function(t,i,s,a,r,o){void 0===s&&(s=null),void 0===a&&(a="shade"),void 0===r&&(r=null),void 0===o&&(o=null);var n=new rxjs_1.Subject;return this.openModal("SystemPrompt").subscribe(function(e){e.instance.type=t,e.instance.text=i,e.instance.headertext=s,e.instance.theme=a,e.instance.value=r,e.instance.options=o,e.instance.answer.subscribe(function(e){n.next(e),n.complete()})}),n.asObservable()},e.prototype.confirm=function(e,t,i){return void 0===t&&(t=null),void 0===i&&(i=null),this.prompt("confirm",e,t,i)},e.prototype.confirmDeleteRecord=function(){return this.prompt("confirm",this.language.getLabel("LBL_DELETE_RECORD","","long"),this.language.getLabel("LBL_DELETE_RECORD"))},e.prototype.input=function(e,t,i,s){return void 0===t&&(t=null),void 0===i&&(i=null),void 0===s&&(s=null),this.prompt("input",e,t,i,s)},e.prototype.info=function(e,t,i){return void 0===t&&(t=null),void 0===i&&(i=null),this.prompt("info",e,t,i)},e.prototype.await=function(t){void 0===t&&(t=null);var i=new core_1.EventEmitter;return this.openModal("SystemLoadingModal",!1).subscribe(function(e){e.instance.messagelabel=t,i.subscribe(function(){e.instance.self.destroy()})}),i},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,footer,toast,language])],e)}();exports.modal=modal;var helper=function(){function e(e){this.modalservice=e,this.dialog=null,this._base64_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}return e.prototype.getRand=function(){return Math.random()},e.prototype.S4=function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},e.prototype.generateGuid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},e.prototype.confirm=function(e,t){var i=new rxjs_1.Subject;return this.modalservice.confirm(t,e).subscribe(function(e){i.next(e),i.complete()}),i.asObservable()},e.prototype.shuffle=function(e){for(var t,i,s=e.length;s;)i=Math.floor(Math.random()*s--),t=e[s],e[s]=e[i],e[i]=t;return e},e.prototype.encodeBase64=function(e){var t,i,s,a,r,o,n,u="",l=0;for(e=this._utf8_encodeBase64(e);l<e.length;)a=(t=e.charCodeAt(l++))>>2,r=(3&t)<<4|(i=e.charCodeAt(l++))>>4,o=(15&i)<<2|(s=e.charCodeAt(l++))>>6,n=63&s,isNaN(i)?o=n=64:isNaN(s)&&(n=64),u=u+this._base64_keyStr.charAt(a)+this._base64_keyStr.charAt(r)+this._base64_keyStr.charAt(o)+this._base64_keyStr.charAt(n);return u},e.prototype.decodeBase64=function(e){var t,i,s,a,r,o,n="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<e.length;)t=this._base64_keyStr.indexOf(e.charAt(u++))<<2|(a=this._base64_keyStr.indexOf(e.charAt(u++)))>>4,i=(15&a)<<4|(r=this._base64_keyStr.indexOf(e.charAt(u++)))>>2,s=(3&r)<<6|(o=this._base64_keyStr.indexOf(e.charAt(u++))),n+=String.fromCharCode(t),64!=r&&(n+=String.fromCharCode(i)),64!=o&&(n+=String.fromCharCode(s));return n=this._utf8_decodeBase64(n)},e.prototype._utf8_encodeBase64=function(e){var t="";e=e.replace(/\r\n/g,"\n");for(var i=0;i<e.length;i++){var s=e.charCodeAt(i);s<128?t+=String.fromCharCode(s):(127<s&&s<2048?t+=String.fromCharCode(s>>6|192):(t+=String.fromCharCode(s>>12|224),t+=String.fromCharCode(s>>6&63|128)),t+=String.fromCharCode(63&s|128))}return t},e.prototype._utf8_decodeBase64=function(e){for(var t="",i=0,s=0,a=0,r=0;i<e.length;)(s=e.charCodeAt(i))<128?(t+=String.fromCharCode(s),i++):191<s&&s<224?(a=e.charCodeAt(i+1),t+=String.fromCharCode((31&s)<<6|63&a),i+=2):(a=e.charCodeAt(i+1),r=e.charCodeAt(i+2),t+=String.fromCharCode((15&s)<<12|(63&a)<<6|63&r),i+=3);return t},e.prototype.determineFileIcon=function(e){var t;if(e){var i,s;if(i=(t=e.split("/"))[0],s=t[1],!i)return"unknown";switch(i){case"image":case"png":case"jpeg":return"image";case"text":switch(s){case"html":return"html";default:return"txt"}case"audio":return"audio";case"video":return"video"}switch(s){case"xml":return"xml";case"pdf":return"pdf";case"vnd.ms-excel":case"vnd.openxmlformats-officedocument.spreadsheetml.sheet":return"excel";case"vnd.openxmlformats-officedocument.wordprocessingml.document":case"vnd.oasis.opendocument.text":return"word";case"vnd.oasis.opendocument.presentation":case"vnd.openxmlformats-officedocument.presentationml.presentation":return"ppt";case"x-zip-compressed":return"zip";case"x-msdownload":return"exe"}}return"unknown"},e.prototype.humanFileSize=function(e){var t=e;if(Math.abs(e)<1024)return t+" B";for(var i=["kB","MB","GB","TB","PB","EB","ZB","YB"],s=-1;t/=1024,++s,1024<=Math.abs(t)&&s<i.length-1;);return t.toFixed(1)+" "+i[s]},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modal])],e)}();exports.helper=helper;var googleapiloader=function(){function e(e,t){this.broadcast=e,this.configuration=t,this.apis=[]}return e.prototype._loadScript=function(){var e=document.createElement("script");e.async=!0,e.defer=!0,e.src="https://maps.googleapis.com/maps/api/js?callback=__onGoogleLoaded&key="+this.configuration.data.googleAPI,e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)},e.prototype.isApiLoaded=function(){return!(!window.google||!window.google.maps)},e.prototype.loadApi=function(){var i=this;this._apiLoadingPromise||(this._apiLoadingPromise=new Promise(function(t){window.__onGoogleLoaded=function(e){t("google maps api loaded"),i.broadcast.broadcastMessage("googleapiloader.maps")},i._loadScript()}))},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[broadcast,configurationService])],e)}();exports.googleapiloader=googleapiloader;var libloader=function(){function e(e){this.configuration=e,this.loadedLibs=[],this.loadedLibs$=new core_1.EventEmitter,this.loadedDirect=[]}return Object.defineProperty(e.prototype,"scripts",{get:function(){return this.configuration.getData("scripts")},enumerable:!0,configurable:!0}),e.prototype.loadLibs=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var s=[];e.forEach(function(e){s.push(t.loadLib(e))});for(var a=new rxjs_1.Subject,r=0,o=0,n=s;o<n.length;o++){n[o].subscribe(function(e){++r==s.length&&(a.next(),a.complete())},function(e){r++,a.error(e)})}return r==s.length?rxjs_1.of(a):a.asObservable()},e.prototype.loadLib=function(t){var i=this;if(this.scripts[t]){if(this.isLibLoaded(t))return rxjs_1.of({script:t,loaded:!0,status:"Already Loaded"});this.loadedLibs.push({name:t,status:"loading"});var s=new rxjs_1.Subject;return this.loadScriptsDirect(this.scripts[t]).then(function(e){s.next({script:t,loaded:!0,status:"Loaded"}),s.complete(),i.loadedLibs.find(function(e){return e.name==t}).status="loaded",i.loadedLibs$.emit({script:t,loaded:!0,status:"Loaded"})},function(e){s.error({script:t,loaded:!1,status:"error"}),s.complete(),i.loadedLibs.find(function(e){return e.name==t}).status="error",i.loadedLibs$.emit({script:t,loaded:!0,status:"error"})}),s.asObservable()}return rxjs_1.of({script:t,loaded:!1,status:"Unknown"})},e.prototype.loadScriptsDirect=function(o){return __awaiter(this,void 0,void 0,function(){var t,i,s,a,r;return __generator(this,function(e){switch(e.label){case 0:t=new rxjs_1.Subject,s=i=0,a=o,e.label=1;case 1:return s<a.length?(r=a[s],[4,this.loadScriptDirect(r.src).then(function(e){++i==o.length&&(t.next({script:name,loaded:!0,status:"Loaded"}),t.complete())},function(e){t.error({script:name,loaded:!1,status:"error"}),t.complete()})]):[3,4];case 2:e.sent(),e.label=3;case 3:return s++,[3,1];case 4:return[2,t.toPromise()]}})})},e.prototype.loadFromSource=function(t){for(var i=new rxjs_1.Subject,s=0,e=0,a=t;e<a.length;e++){var r=a[e];this.loadScriptDirect(r).then(function(e){++s==t.length&&(i.next(!0),i.complete())},function(e){i.error(!1),i.complete()})}return i.asObservable()},e.prototype.loadScriptDirect=function(s){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){return-1!=this.loadedDirect.indexOf(s)?[2,rxjs_1.of(!0).toPromise()]:(t=new rxjs_1.Subject,i={},s.endsWith(".css")?((i=document.createElement("link")).rel="stylesheet",i.href=s):((i=document.createElement("script")).type="text/javascript",i.src=s),i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,t.next(!0),t.complete())}:i.onload=function(){t.next(!0),t.complete()},i.onerror=function(e){t.error(!1),t.complete()},document.getElementsByTagName("head")[0].appendChild(i),[2,t.toPromise()])})})},e.prototype.isLibLoaded=function(t){return!!this.loadedLibs.find(function(e){return e.name==t&&"loaded"==e.status})},e.prototype.isLibLoading=function(t){return!!this.loadedLibs.find(function(e){return e.name==t&&"loading"==e.status})},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService])],e)}();exports.libloader=libloader;var backend=function(){function e(e,t,i,s,a,r,o,n,u,l){this.toast=e,this.http=t,this.sanitizer=i,this.configurationService=s,this.session=a,this.metadata=r,this.router=o,this.modelutilities=n,this.modalservice=u,this.language=l,this.autoLogout={},this.httpErrorsToReport=[],this.httpErrorReporting=!1,this.httpErrorReportingRetryTime=1e4}return e.prototype.getHeaders=function(){var e=this.session.getSessionHeader();return e=e.set("Accept","application/json")},e.prototype.prepareParams=function(i){var s=new http_1.HttpParams;return i&&Object.keys(i).forEach(function(e){var t=i[e];null!=t&&(s="object"==typeof t?s.append(e,JSON.stringify(t)):"boolean"==typeof t?s.append(e,!0===t?"1":"0"):"number"==typeof t?s.append(e,t+""):s.append(e,t.toString()))}),s},e.prototype.getRequest=function(t,i){var s=this;void 0===t&&(t=""),void 0===i&&(i={});var a=new rxjs_1.Subject;return this.resetTimeOut(),this.http.get(this.configurationService.getBackendUrl()+"/"+encodeURI(t),{headers:this.getHeaders(),observe:"response",params:this.prepareParams(i)}).subscribe(function(e){a.next(e.body),a.complete()},function(e){s.handleError(e,t,"GET",{getParams:i}),a.error(e)}),a.asObservable()},e.prototype.getRawRequest=function(e,t,i,s){void 0===e&&(e=""),void 0===t&&(t={}),void 0===i&&(i="blob"),void 0===s&&(s={}),this.resetTimeOut();var a=this.session.getSessionHeader();for(var r in s)a=a.set(r,s[r]);return this.http.get(this.configurationService.getBackendUrl()+"/"+e,{headers:a,params:this.prepareParams(t),responseType:"blob"})},e.prototype.postRequest=function(t,i,s,a){var r=this;void 0===t&&(t=""),void 0===i&&(i={}),void 0===s&&(s={}),void 0===a&&(a=!0);var o=new rxjs_1.Subject;this.resetTimeOut();var e=this.getHeaders();return e=s?e.set("Content-Type","application/json"):e.set("Content-Type","application/x-www-form-urlencoded"),this.http.post(this.configurationService.getBackendUrl()+"/"+encodeURI(t),s,{headers:e,observe:"response",params:this.prepareParams(i)}).subscribe(function(e){o.next(e.body),o.complete()},function(e){r.handleError(e,t,"POST",{getParams:i,body:s},a),o.error(e)}),o.asObservable()},e.prototype.postRequestWithProgress=function(t,i,s,a,r){var o=this;void 0===t&&(t=""),void 0===i&&(i={}),void 0===s&&(s={}),void 0===a&&(a=!0),void 0===r&&(r=null);var n=new rxjs_1.Subject;this.resetTimeOut();var e=this.getHeaders();return e=s?e.set("Content-Type","application/json"):e.set("Content-Type","application/x-www-form-urlencoded"),null!==r&&r.next(0),this.http.post(this.configurationService.getBackendUrl()+"/"+encodeURI(t),s,{headers:e,observe:"events",params:this.prepareParams(i),reportProgress:!!r}).subscribe(function(e){e.type===http_1.HttpEventType.UploadProgress?r.next(100*e.loaded/e.total):e.type===http_1.HttpEventType.Response&&(n.next(e.body),n.complete())},function(e){o.handleError(e,t,"POST",{getParams:i,body:s},a),n.error(e)}),n.asObservable()},e.prototype.getDownloadPostRequestFile=function(i,s,a){var r=this;void 0===i&&(i=""),void 0===s&&(s={}),void 0===a&&(a={});var o=new rxjs_1.Subject;this.resetTimeOut();var e=this.getHeaders();return e=e.set("Accept","*/*"),this.http.post(this.configurationService.getBackendUrl()+"/"+i,a,{headers:e,observe:"response",params:this.prepareParams(s),responseType:"blob"}).subscribe(function(e){var t=window.URL.createObjectURL(e.body);o.next(t),o.complete()},function(e){r.handleError(e,i,"POST",{getParams:s,body:a});var t=new FileReader;t.readAsText(e.error),t.onloadend=function(e){o.error(JSON.parse(t.result.toString()))}}),o.asObservable()},e.prototype.getLinkToDownload=function(t,i,s,a,e){var r=this;void 0===i&&(i="GET"),void 0===s&&(s=null),void 0===a&&(a=null),void 0===e&&(e=null);var o=new rxjs_1.Subject,n=this.getHeaders();return n=n.set("Accept","*/*"),this.http.request(i,this.configurationService.getBackendUrl()+"/"+t,{body:a,headers:n,observe:"response",params:this.prepareParams(s),responseType:"blob"}).subscribe(function(e){if(200==e.status){var t=window.URL.createObjectURL(e.body);o.next(t),o.complete()}else o.error(e.statusText)},function(e){r.handleError(e,t,i,{getParams:s,body:a}),o.error(e)}),o.asObservable()},e.prototype.getCharsetOfResponse=function(e){if(!e.headers)return null;e.headers.lazyInit();var t=e.headers.headers.get("content-type");return t&&(t=(t=t[0]).split(";"))[1]&&(t=t[1].split("="))[1]?t[1]:null},e.prototype.downloadFile=function(e,s,a){void 0===s&&(s=null),void 0===a&&(a=null);var r=new rxjs_1.Subject;return this.getLinkToDownload(e.route,e.method,e.params,e.body,e.headers).subscribe(function(e){var t=e,i=document.createElement("a");document.body.appendChild(i),i.href=t,a&&(i.type=a),i.download=s,i.click(),i.remove(),r.next(),r.complete()},function(e){return r.error(e)}),r.asObservable()},e.prototype.putRequest=function(t,i,s){var a=this;void 0===t&&(t=""),void 0===i&&(i={}),void 0===s&&(s={});var r=new rxjs_1.Subject;return this.resetTimeOut(),this.http.put(this.configurationService.getBackendUrl()+"/"+t,s,{headers:this.getHeaders(),observe:"response",params:this.prepareParams(i)}).subscribe(function(e){r.next(e.body),r.complete()},function(e){a.handleError(e,t,"PUT",{getParams:i,body:s}),r.error(e)}),r.asObservable()},e.prototype.deleteRequest=function(t,i){var s=this;void 0===t&&(t=""),void 0===i&&(i={});var a=new rxjs_1.Subject;return this.resetTimeOut(),this.http.delete(this.configurationService.getBackendUrl()+"/"+t,{headers:this.getHeaders(),params:this.prepareParams(i)}).subscribe(function(e){a.next(e||!0),a.complete()},function(e){s.handleError(e,t,"DELETE",{getParams:i}),a.error(e)}),a.asObservable()},e.prototype.handleError=function(e,t,i,s,a){switch(void 0===s&&(s=null),void 0===a&&(a=!0),e.status){case 401:this.toast.sendAlert(this.language.getLabel("ERR_LOGGED_OUT_SESSION_EXPIRED"),"error",null,!1,"sessionexpired"),this.modalservice.closeAllModals(),this.session.endSession(),this.router.navigate(["/login"]);break;case 0:a&&this.reportError(e,t,i,s)}},e.prototype.reportError=function(e,t,i,s){var a=this;this.httpErrorsToReport.push({clientTime:(new Date).toISOString(),clientInfo:{sessionId:this.session.authData.sessionId,userId:this.session.authData.userId,userName:this.session.authData.userName},route:t,method:i,getParams:s.getParams?s.getParams:null,error:e,body:s.body?s.body:null}),this.httpErrorReporting||(this.httpErrorReporting=!0,window.setTimeout(function(){return a.errorsToBackend()},this.httpErrorReportingRetryTime))},e.prototype.errorsToBackend=function(){var t=this;this.httpErrorsToReport.length&&this.postRequest("httperrors",null,{errors:this.httpErrorsToReport},!1).subscribe(function(){t.httpErrorsToReport.length=0,t.httpErrorReporting=!1},function(e){t.httpErrorReporting=!0,window.setTimeout(function(){return t.errorsToBackend()},t.httpErrorReportingRetryTime)})},e.prototype.resetTimeOut=function(){var e=this;0<this.configurationService.data.autoLogout&&(window.clearTimeout(this.autoLogout),this.autoLogout=window.setTimeout(function(){return e.logout()},6e4*parseInt(this.configurationService.data.autoLogout,10)))},e.prototype.logout=function(){this.session.authData.sessionId&&(this.toast.sendAlert("you have been logged out","error","",!1),this.session.endSession()),this.router.navigate(["/login"])},e.prototype.get=function(i,e,t){var s=this;void 0===t&&(t="");var a=new rxjs_1.Subject,r={};return t&&(r.trackaction=t),this.getRequest("module/"+i+"/"+e,r).subscribe(function(e){for(var t in e)e[t]=s.backend2spice(i,t,e[t]);a.next(e),a.complete()},function(e){a.error(e),a.complete()}),a.asObservable()},e.prototype.all=function(o,e){var n=this;void 0===e&&(e={});var u=new rxjs_1.Subject;return e.limit||(e.limit=-99),e.fields||(e.fields="*"),this.getRequest("module/"+o,e).subscribe(function(e){for(var t=e.list,i=0,s=t;i<s.length;i++){var a=s[i];for(var r in a)a[r]=n.backend2spice(o,r,a[r])}u.next(t),u.complete()}),u.asObservable()},e.prototype.getDuplicates=function(e,t){var i=new rxjs_1.Subject;return this.getRequest("module/"+e+"/"+t+"/duplicates").subscribe(function(e){i.next(e),i.complete()}),i.asObservable()},e.prototype.checkDuplicates=function(e,t){var i=new rxjs_1.Subject;return this.postRequest("module/"+e+"/duplicates",{},t).subscribe(function(e){i.next(e),i.complete()}),i.asObservable()},e.prototype.getAudit=function(e,t,i){void 0===i&&(i={});var s=new rxjs_1.Subject;return this.getRequest("module/"+e+"/"+t+"/auditlog",i).subscribe(function(e){s.next(e),s.complete()},function(e){e.error.error&&e.error.error.errorCode&&"moduleNotAudited"===e.error.error.errorCode&&(s.error(e.error.error.errorCode),s.complete())}),s.asObservable()},e.prototype.getList=function(s,e,t,i){var a=this;void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===i&&(i={});var r=new rxjs_1.Subject,o=(i.start&&i.start,i.limit&&i.limit,i);return o.searchfields=i.searchfields,o.offset=i.start?i.start:0,o.limit=i.limit?i.limit:25,i.listid&&(o.listid=i.listid),0<e.length&&(o.sortfields=e),t&&0<t.length&&(o.fields=JSON.stringify(t)),this.getRequest("module/"+s,o).subscribe(function(e){try{for(var t in e.list)for(var i in e.list[t])e.list[t][i]=a.backend2spice(s,i,e.list[t][i])}catch(e){r.next([]),r.complete()}r.next(e),r.complete()}),r.asObservable()},e.prototype.save=function(t,e,i,s,a){var r=this;void 0===s&&(s=null),void 0===a&&(a=null);var o=new rxjs_1.Subject;return this.postRequestWithProgress("module/"+t+"/"+e,{templateId:a},this.modelutilities.spiceModel2backend(t,i),null,s).subscribe(function(e){o.next(r.modelutilities.backendModel2spice(t,e)),o.complete()},function(e){o.error(e),o.complete()}),o.asObservable()},e.prototype.delete=function(e,t){var i=new rxjs_1.Subject;return this.deleteRequest("module/"+e+"/"+t).subscribe(function(e){i.next(e||!0),i.complete()}),i.asObservable()},e.prototype.getRecent=function(e,t){void 0===e&&(e=""),void 0===t&&(t=0);var i=new rxjs_1.Subject,s={};return e&&(s.module=e),0<t&&(s.limit=t),this.getRequest("modules/Trackers/recent",s).subscribe(function(e){i.next(e),i.complete()}),i.asObservable()},e.prototype.backend2spice=function(e,t,i){return this.modelutilities.backend2spice(e,t,i)},e.prototype.spice2backend=function(e,t,i){return this.modelutilities.spice2backend(e,t,i)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[toast,http_1.HttpClient,platform_browser_1.DomSanitizer,configurationService,session,metadata,router_1.Router,modelutilities,modal,language])],e)}();exports.backend=backend;var recent=function(){function e(e,t,i,s){var a=this;this.backend=e,this.broadcast=t,this.configuration=i,this.session=s,this.moduleItems={},this.broadcast.message$.subscribe(function(e){return a.handleMessage(e)})}return Object.defineProperty(e.prototype,"items",{get:function(){var e=this.configuration.getData("recentitmes");return e||[]},enumerable:!0,configurable:!0}),e.prototype.handleMessage=function(i){var s=this;switch(i.messagetype){case"model.save":this.items.some(function(e,t){if(e.module_name===i.messagedata.module&&e.item_id==i.messagedata.id)return s.items[t].item_summary=i.messagedata.data.summary_text,s.items[t].data=i.messagedata.data,!0}),this.moduleItems[i.messagedata.module]&&this.moduleItems[i.messagedata.module].some(function(e,t){if(e.item_id==i.messagedata.id)return s.moduleItems[i.messagedata.module][t].item_summary=i.messagedata.data.summary_text,s.moduleItems[i.messagedata.module][t].data=i.messagedata.data,!0});break;case"model.delete":this.items.some(function(e,t){if(e.module_name===i.messagedata.module&&e.item_id==i.messagedata.id)return s.items.splice(t,1),!0}),this.moduleItems[i.messagedata.module]&&this.moduleItems[i.messagedata.module].some(function(e,t){if(e.item_id==i.messagedata.id)return s.items.splice(t,1),!0})}},e.prototype.trackItem=function(i,s,e){var a=this;for(this.items.some(function(e,t){if(e.module_name===i&&e.item_id==s)return a.items.splice(t,1),!0}),this.items.splice(0,0,{item_id:s,module_name:i,item_summary:e.summary_text,data:e});50<this.items.length;)this.items.pop();if(this.moduleItems[i])for(this.moduleItems[i].some(function(e,t){if(e.item_id==s)return a.moduleItems[i].splice(t,1),!0}),this.moduleItems[i].splice(0,0,{item_id:s,module_name:i,item_summary:e.summary_text,data:e});5<this.moduleItems[i].length;)this.moduleItems[i].pop()},e.prototype.getModuleRecent=function(a){var r=this;if("Home"==a)return rxjs_1.of(this.items.slice(0,5));if(this.moduleItems[a])return rxjs_1.of(this.moduleItems[a]);var o=new rxjs_1.Subject;return this.moduleItems[a]||this.backend.getRecent(a,5).subscribe(function(e){r.moduleItems[a]=[];for(var t=0,i=e;t<i.length;t++){var s=i[t];r.moduleItems[a].push(s)}o.next(r.moduleItems[a]),o.complete()}),o.asObservable()},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],e)}();exports.recent=recent;var userpreferences=function(){function e(e,t,i,s,a,r,o){var n=this;this.backend=e,this.toast=t,this.configuration=i,this.language=s,this.broadcast=a,this.modalservice=r,this.session=o,this.preferences={global:{}},this.unchangedPreferences={global:{}},this.preferencesComplete=!0,this.defaults={currency:-99,datef:"d.m.Y",dec_sep:",",num_grp_sep:".",timef:"H:i",timezone:"Europe/Vienna",default_currency_significant_digits:2,default_locale_name_format:"l, f",week_day_start:0,navigation_paradigm:"simple",distance_unit_system:"METRIC"},this.formats={nameFormats:[],loaded:!1},this.toUse=this.preferences.global,this.broadcast.message$.subscribe(function(e){"loader.completed"===e.messagetype&&"loadUserData"===e.messagedata&&n.retrievePrefsFromConfigService()})}return e.prototype.retrievePrefsFromConfigService=function(){var e=this.configuration.getData("globaluserpreferences");this.preferences.global=_.extendOwn(this.preferences.global,e),this.unchangedPreferences.global=_.clone(e),this.defaults=_.extendOwn(this.defaults,this.configuration.getData("defaultuserpreferences")),this.askForMissingPreferences(),this.completePreferencesWithDefaults(),this.session.setTimezone(this.toUse.timezone)},e.prototype.getPreferences=function(t){this.loadPreferences().subscribe(function(e){t.next("getPreferences")})},e.prototype.loadPreferences=function(t){var i=this;void 0===t&&(t="global");var s=new rxjs_1.Subject;return this.backend.getRequest("user/"+this.session.authData.userId+"/preferences/"+t).subscribe(function(e){i.preferences[t]=_.extendOwn(i.preferences[t],e),"global"===t?(i.unchangedPreferences.global=_.clone(e),i.completePreferencesWithDefaults(),i.session.setTimezone(i.toUse.timezone)):i.unchangedPreferences[t]=_.clone(e),s.next(e)}),s.asObservable()},e.prototype.completePreferencesWithDefaults=function(){var i=this,s=!1;_.each(this.defaults,function(e,t){"string"==typeof i.preferences.global[t]?i.preferences.global[t]||(i.preferences.global[t]=e,s=!0):void 0!==i.preferences.global[t]&&null!==i.preferences.global[t]||(i.preferences.global[t]=e,s=!0)}),this.preferencesComplete=!s},e.prototype.getPreference=function(e,t){void 0===t&&(t="global");try{return this.preferences[t][e]}catch(e){return!1}},e.prototype.setPreference=function(t,i,e,s){var a=this;if(void 0===e&&(e=!0),void 0===s&&(s="global"),e){var r={};r[t]=i;var o=new rxjs_1.Subject;return this.backend.postRequest("user/"+this.session.authData.userId+"/preferences/"+s,{},r).subscribe(function(e){a.preferences[s]||(a.preferences[s]={}),a.preferences[s][t]=i,a.unchangedPreferences[s]||(a.unchangedPreferences[s]={}),a.unchangedPreferences[s][t]=i,a.completePreferencesWithDefaults(),"global"===s&&"timezone"===t&&a.session.setTimezone(a.toUse.timezone),o.next(e)},function(e){o.error(e)}),o}return this.preferences[s]||(this.preferences[s]={}),this.preferences[s][t]=i,this.completePreferencesWithDefaults(),"global"===s&&"timezone"===t&&this.session.setTimezone(this.toUse.timezone),null},e.prototype.setPreferences=function(e,i){var s=this;void 0===i&&(i="global");var a=new rxjs_1.Subject;return this.backend.postRequest("user/"+this.session.authData.userId+"/preferences/"+i,{},e).subscribe(function(e){for(var t in s.preferences[i])e.hasOwnProperty(t)?s.preferences[i][t]=e[t]:delete s.preferences[i][t];s.unchangedPreferences[i]=e,s.completePreferencesWithDefaults(),s.session.setTimezone(s.toUse.timezone),a.next(!0)},function(e){a.error(e)}),a},e.prototype.getDateFormat=function(){if(this.toUse.datef){var e=this.toUse.datef;return this.jsDateFormat2momentDateFormat(e)}return"YYYY-MM-DD"},e.prototype.jsDateFormat2momentDateFormat=function(e){return e.replace("Y","YYYY").replace("m","MM").replace("d","DD")},e.prototype.getTimeFormat=function(){if(this.toUse.timef){var e=this.toUse.timef;return this.jsTimeFormat2momentTimeFormat(e)}return"hh:mm"},e.prototype.jsTimeFormat2momentTimeFormat=function(e){return e.replace("H","HH").replace("h","hh").replace("i","mm")},e.prototype.needFormats=function(){this.formats.loaded||this.loadFormats()},e.prototype.loadFormats=function(){var a=this,r=new rxjs_1.Subject;return this.formats.nameFormats.length=0,this.formats.loaded=!1,this.backend.getRequest("user/preferencesformats").subscribe(function(e){for(var t=0,i=e.nameFormats;t<i.length;t++){var s=i[t];a.formats.nameFormats.push({name:s,example:a.translateNameFormat(s)})}a.formats.loaded=!0,r.next(!0)}),r.asObservable()},e.prototype.translateNameFormat=function(e){for(var t="",i=0;i<e.length;i++)switch(e.charAt(i)){case"t":t+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_TITLE");break;case"f":t+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_FIRST");break;case"l":t+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_LAST");break;case"s":t+=this.language.getLabel("LBL_LOCALE_NAME_EXAMPLE_SALUTATION");break;default:t+=e.charAt(i)}return t},e.prototype.formatMoney=function(e,t,i,s,a){void 0===t&&(t=this.toUse.default_currency_significant_digits),void 0===i&&(i=3),void 0===s&&(s=this.toUse.num_grp_sep),void 0===a&&(a=this.toUse.dec_sep);var r="\\d(?=(\\d{"+i+"})+"+(0<t?"\\D":"$")+")";return e.toFixed(Math.max(0,~~t)).replace(".",a).replace(new RegExp(r,"g"),"$&"+s)},e.prototype.formatDate=function(e){if(moment.isMoment(e))return e.format(this.getDateFormat());var t=moment(e);return t.isValid()?t.format(this.getDateFormat()):e},e.prototype.formatDateTime=function(e){return moment.isMoment(e)?e.format(this.getDateFormat())+" "+e.format(this.getTimeFormat()):moment.utc(e).format(this.getDateFormat())+" "+moment.utc(e).format(this.getTimeFormat())},e.prototype.askForMissingPreferences=function(){var t=this.getNamesOfMissingImportantPrefs(),i=0;if(this.unchangedPreferences.global&&this.unchangedPreferences.global.timezone){var e=moment.tz(moment.tz.guess()).utcOffset(),s=moment.tz(this.unchangedPreferences.global.timezone).utcOffset();e!==s&&(i=(e*s<0?Math.abs(e)+Math.abs(s):Math.abs(e-s))/60)}0===t.length&&0===i||this.modalservice.openModal("GlobalObtainImportantPreferences").subscribe(function(e){e.instance.namesOfMissingPrefs=t,e.instance.timeshift=i})},e.prototype.getNamesOfMissingImportantPrefs=function(){for(var e=[],t=0,i=["timezone","datef","timef"];t<i.length;t++){var s=i[t];this.unchangedPreferences.global[s]||e.push(s)}return e},e.prototype.getPossibleDateFormats=function(){return[{name:moment().format(this.jsDateFormat2momentDateFormat("Y-m-d")),value:"Y-m-d"},{name:moment().format(this.jsDateFormat2momentDateFormat("m-d-Y")),value:"m-d-Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("d-m-Y")),value:"d-m-Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("Y/m/d")),value:"Y/m/d"},{name:moment().format(this.jsDateFormat2momentDateFormat("m/d/Y")),value:"m/d/Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("d/m/Y")),value:"d/m/Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("Y.m.d")),value:"Y.m.d"},{name:moment().format(this.jsDateFormat2momentDateFormat("d.m.Y")),value:"d.m.Y"},{name:moment().format(this.jsDateFormat2momentDateFormat("m.d.Y")),value:"m.d.Y"}]},e.prototype.getPossibleTimeFormats=function(){return[{name:moment().format(this.jsTimeFormat2momentTimeFormat("H:i")),value:"H:i"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:ia")),value:"h:ia"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:iA")),value:"h:iA"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:i a")),value:"h:i a"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h:i A")),value:"h:i A"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("H.i")),value:"H.i"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.ia")),value:"h.ia"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.iA")),value:"h.iA"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.i a")),value:"h.i a"},{name:moment().format(this.jsTimeFormat2momentTimeFormat("h.i A")),value:"h.i A"}]},Object.defineProperty(e.prototype,"companyCodeId",{get:function(){return this.session.authData.companycode_id},enumerable:!0,configurable:!0}),e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,toast,configurationService,language,broadcast,modal,session])],e)}();exports.userpreferences=userpreferences;var territories=function(){function e(e,t,i,s){this.backend=e,this.metadata=t,this.configurationService=i,this.session=s,this.addTerritories={}}return e.prototype.checkModuleManaged=function(e){return!!this.getModuleParamaters(e)},e.prototype.getModuleParamaters=function(t){var e=this.configurationService.getData("aclterritorymoduletypes");return!!e&&e.find(function(e){return e.module==t})},Object.defineProperty(e.prototype,"userTerritories",{get:function(){return this.configurationService.getData("aclterritoryuserterritories")},enumerable:!0,configurable:!0}),e.prototype.getRecentTerritories=function(e,t,i){void 0===t&&(t=5);var s=this.userTerritories;if(!i||this.session.isAdmin)return s[e]&&0<s[e].length?s[e].slice(0,t):[];var a=s[e]&&0<s[e].length?s[e].filter(function(e){return-1!=e.actions.indexOf(i)}):[];return a&&0<a.length?a.slice(0,t):[]},e.prototype.loadTerritoryName=function(t){var i=this;this.addTerritories[t]="...",this.backend.getRequest("territories/"+t).subscribe(function(e){e.id===t?i.addTerritories[t]=e.name:i.addTerritories[t]="error"})},e.prototype.searchTerritories=function(e,t,i,s,a){void 0===i&&(i=5),void 0===s&&(s=[]);for(var r=[],o=0,n=this.userTerritories[e];o<n.length;o++){var u=n[o];if(0<=u.name.toLowerCase().indexOf(t.toLowerCase())&&s.indexOf(u.id)<0&&(this.session.isAdmin||!a||a&&-1!=u.actions.indexOf(a))&&r.push(u),r.length>=i)return r}return r},e.prototype.isUserTerritory=function(e,t){var i=!1;return this.userTerritories[e].some(function(e){if(e.id===t)return i=!0}),i},e.prototype.getTerritoryName=function(e,t){var i="";return this.userTerritories[e].some(function(e){if(e.id===t)return i=e.name,!0}),""===i&&(this.addTerritories[t]||this.loadTerritoryName(t),i=this.addTerritories[t]),i},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,metadata,configurationService,session])],e)}();exports.territories=territories;var favorite=function(){function e(e,t,i,s){var a=this;this.backend=e,this.broadcast=t,this.configuration=i,this.session=s,this.isEnabled=!1,this.module="",this.id="",this.broadcast.message$.subscribe(function(e){return a.handleMessage(e)})}return Object.defineProperty(e.prototype,"favorites",{get:function(){var e=this.configuration.getData("favorites");return e||[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFavorite",{get:function(){var t=this;return!!this.favorites.find(function(e){return e.module_name==t.module&&e.item_id==t.id})},enumerable:!0,configurable:!0}),e.prototype.handleMessage=function(i){var s=this;switch(i.messagetype){case"model.save":this.favorites.some(function(e,t){if(e.module_name===i.messagedata.module&&e.item_id==i.messagedata.id)return s.favorites[t].item_summary=i.messagedata.data.summary_text,!0})}},e.prototype.enable=function(e,t){this.isEnabled=!0,this.module=e,this.id=t},e.prototype.disable=function(){this.isEnabled=!1,this.module=void 0,this.id=void 0},e.prototype.getFavorites=function(e){for(var t=[],i=0,s=this.favorites;i<s.length;i++){var a=s[i];a.module_name===e&&t.push({item_id:a.item_id,item_summary:a.item_summary})}return t},e.prototype.setFavorite=function(){var t=this;this.backend.postRequest("SpiceFavorites/"+this.module+"/"+this.id).subscribe(function(e){t.favorites.splice(0,0,{item_id:e.id,module_name:e.module,item_summary:e.summary_text,data:e.data})})},e.prototype.deleteFavorite=function(i,s){var a=this;i=i||this.module,s=s||this.id,this.backend.deleteRequest("SpiceFavorites/"+i+"/"+s).subscribe(function(e){a.favorites.some(function(e,t){if(e.module_name===i&&e.item_id===s)return a.favorites.splice(t,1),!0})})},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],e)}();exports.favorite=favorite;var reminder=function(){function e(e,t,i,s){var a=this;this.backend=e,this.broadcast=t,this.configuration=i,this.session=s,this.reminders=[],this.loaded$=new core_1.EventEmitter,this.broadcast.message$.subscribe(function(e){return a.handleMessage(e)})}return e.prototype.handleMessage=function(i){var s=this;switch(i.messagetype){case"loader.completed":if("loadUserDataStep2"==i.messagedata){this.reminders=[];for(var e=0,t=this.configuration.getData("reminders");e<t.length;e++){var a=t[e];a.reminder_date=moment.utc(a.reminder_date),this.reminders.push(a)}this.loaded$.emit(!0)}break;case"model.save":this.reminders.some(function(e,t){if(e.module_name===i.messagedata.module&&e.item_id==i.messagedata.id)return s.reminders[t].item_summary=i.messagedata.data.summary_text,!0})}},e.prototype.getReminder=function(t,i){var s=!1;return this.reminders.some(function(e){if(e.module_name===t&&e.item_id===i)return s=e.reminder_date,!0}),s},e.prototype.getReminders=function(){for(var e=[],t=0,i=this.reminders;t<i.length;t++){var s=i[t];s.module_name===module&&e.push({item_id:s.item_id,item_summary:s.item_summary})}return e},e.prototype.setReminder=function(t,i){var s=this;this.backend.postRequest("SpiceReminders/"+t.module+"/"+t.id+"/"+i.format("YYYY-MM-DD")).subscribe(function(e){s.reminders.splice(0,0,{item_id:t.id,module_name:t.module,item_summary:t.data.summary_text,reminder_date:i})})},e.prototype.deleteReminder=function(i,s){var a=this,t=new rxjs_1.Subject;return this.backend.deleteRequest("SpiceReminders/"+i+"/"+s).subscribe(function(e){a.reminders.some(function(e,t){if(e.module_name===i&&e.item_id===s)return a.reminders.splice(t,1),!0}),t.next(!0),t.complete()}),t.asObservable()},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,configurationService,session])],e)}();exports.reminder=reminder;var assistant=function(){function e(e,t,i){var s=this;this.modelutilities=e,this.backend=t,this.broadcast=i,this.assitantItems=[],this.assistantFilters={objectfilters:[],timefilter:"all"},this.initialized=!1,this.loading=!1,this.activityObjects=["Tasks","Meetings","Calls","Opportunities","Reminders"],this.completeStatuses=["Completed","Deferred","Held","Not Held"],this.broadcast.message$.subscribe(function(e){s.handleMessage(e)})}return e.prototype.handleMessage=function(t){var i=this,s=0;switch(t.messagetype){case"model.delete":case"assistant.complete":this.assitantItems.some(function(e){if(e.id==t.messagedata.id)return i.assitantItems.splice(s,1),!0;s++});break;case"model.save":this.assitantItems.some(function(e){if(e.id==t.messagedata.id)return t.messagedata.data.status&&0<=i.completeStatuses.indexOf(t.messagedata.data.status)?i.assitantItems.splice(s,1):e.data=t.messagedata.data,!0;s++})}},e.prototype.initialize=function(){this.initialized||(this.loadItems(),this.initialized=!0)},e.prototype.loadItems=function(){var o=this;this.loading=!0,this.assitantItems=[];var n=new rxjs_1.Subject,e={objectfilters:JSON.stringify(this.assistantFilters.objectfilters),timefilter:this.assistantFilters.timefilter};return this.backend.getRequest("assistant/list",e).subscribe(function(e){for(var t=0,i=e;t<i.length;t++){var s=i[t],a=[];for(var r in s.data)a[r]=o.modelutilities.backend2spice(s.module,r,s.data[r]);o.assitantItems.push({id:s.id,module:s.module,date_activity:s.date_activity,data:a})}n.next(o.assitantItems),n.complete(),o.loading=!1}),n.asObservable()},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,backend,broadcast])],e)}();exports.assistant=assistant;var currency=function(){function e(e){this.configuration=e}return Object.defineProperty(e.prototype,"currencies",{get:function(){return this.configuration.getData("currencies")},enumerable:!0,configurable:!0}),e.prototype.getCurrencies=function(){for(var e=[],t=0,i=this.currencies;t<i.length;t++){var s=i[t];e.push({id:s.id,name:s.name,iso:s.iso,symbol:s.symbol})}return e},e.prototype.getCurrencySmbol=function(t){var e=this.currencies.find(function(e){return e.id==t});return e?e.symbol:""},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService])],e)}();exports.currency=currency;var loader=function(){function e(e,t,i,s,a){var r=this;this.http=e,this.broadcast=t,this.configuration=i,this.session=s,this.language=a,this.module="",this.id="",this.data={},this.loaderHandler=new rxjs_1.Subject,this.start="",this.counterCompleted=0,this.progress=0,this.activeLoader="",this.loadPhase="system",this.loadElements={system:[{name:"getLanguage",display:"Language",status:"initial",sequence:35,action:function(e){e.language.getLanguage(e.loaderHandler)}}],primary:[],secondary:[]},this.loaderHandler.subscribe(function(e){return r.handleLoaderHandler()})}return e.prototype.getLoadTasks=function(){var a=this,r=new rxjs_1.Subject;return this.http.get(this.configuration.getBackendUrl()+"/spiceui/core/loadtasks",{headers:this.session.getSessionHeader()}).subscribe(function(e){a.loadElements.primary=[],a.loadElements.secondary=[];for(var t=0,i=e;t<i.length;t++){var s=i[t];s.status="initial",a.loadElements[s.phase].push(s)}a.loadElements.primary.sort(function(e,t){return e.sequence>t.sequence?1:-1}),a.loadElements.secondary.sort(function(e,t){return e.sequence>t.sequence?1:-1}),r.next(!0),r.complete()}),r.asObservable()},e.prototype.load=function(){var t=this;return this.loadComplete=new rxjs_1.Subject,this.getLoadTasks().subscribe(function(e){t.resetLoader(),t.start=performance.now(),t.handleLoaderHandler()}),this.loadComplete.asObservable()},e.prototype.reloadPrimary=function(){this.loadComplete=new rxjs_1.Subject,this.loadPhase="primary",this.progress=0;for(var e=this.counterCompleted=0,t=this.loadElements.primary;e<t.length;e++){t[e].status="initial"}return this.start=performance.now(),this.handleLoaderHandler(),this.loadComplete.asObservable()},e.prototype.resetLoader=function(){this.counterCompleted=0,this.progress=0,this.loadPhase="system";for(var e=0,t=this.loadElements.system;e<t.length;e++){t[e].status="initial"}for(var i=0,s=this.loadElements.primary;i<s.length;i++){s[i].status="initial"}for(var a=0,r=this.loadElements.secondary;a<r.length;a++){r[a].status="initial"}},e.prototype.reset=function(){this.counterCompleted=0;for(var e=this.progress=0,t=this.loadElements;e<t.length;e++){t[e].status="initial"}},e.prototype.setComplete=function(){var e=this;500<performance.now()-this.start?this.complete():setTimeout(function(){return e.complete()},500)},e.prototype.complete=function(){this.loadComplete.next(!0),this.loadComplete.complete()},e.prototype.handleLoaderHandler=function(){for(var e=!1,t=0,i=this.loadElements[this.loadPhase];t<i.length;t++){var s=i[t];if("active"===s.status)s.status="completed",this.progress=++this.counterCompleted/(this.loadElements.primary.length+this.loadElements.system.length)*100,100<this.progress&&this.progress;else if("initial"===s.status){s.status="active",s.action?s.action(this):this.handleRouteElement(s),e=!0,this.activeLoader=s.display;break}}!1===e&&"system"==this.loadPhase?(this.loadPhase="primary",this.handleLoaderHandler()):!1===e&&"primary"==this.loadPhase&&(this.setComplete(),this.loadPhase="secondary",this.handleLoaderHandler())},e.prototype.handleRouteElement=function(i){var s=this,e=i.route?i.route:"/spiceui/core/loadtasks/"+i.id;this.http.get(this.configuration.getBackendUrl()+e,{headers:this.session.getSessionHeader()}).subscribe(function(e){for(var t in e)s.configuration.setData(t,e[t]);s.broadcast.broadcastMessage("loader.completed",i.name),s.loaderHandler.next(i.name)})},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[http_1.HttpClient,broadcast,configurationService,session,language])],e)}();exports.loader=loader;var loginService=function(){function e(e,t,i,s,a,r,o,n,u,l){var c=this;this.configurationService=e,this.http=t,this.router=i,this.loader=s,this.toast=a,this.helper=r,this.session=o,this.broadcast=n,this.modal=u,this.metadata=l,this.redirectUrl="",this.authData={userName:"",password:""},this.oauthToken="",this.accessToken="",this.loginSuccessful=new rxjs_1.Subject,this.broadcast.message$.subscribe(function(e){"loader.completed"===e.messagetype&&"loadUserData"===e.messagedata&&c.session.authData.obtainGDPRconsent&&c.modal.openModal("GlobalObtainGDPRConsentContainer")})}return e.prototype.login=function(){var e,i=this,t="",s={};if(0<this.authData.userName.length&&0<this.authData.password.length){var a=this.authData.userName.indexOf("#as#");-1<a&&(e=this.authData.userName.slice(0,a),this.authData.userName=this.authData.userName.slice(a+4));var r=new http_1.HttpHeaders;r=r.set("Authorization","Basic "+this.helper.encodeBase64(this.authData.userName+":"+this.authData.password)),t=this.configurationService.getBackendUrl()+"/login",e&&(t+="?byDev="+encodeURIComponent(e)),s={headers:r}}else{if(!(0<this.oauthToken.length))throw new Error("Cannot Log In");var o={oauthToken:this.oauthToken,accessToken:this.accessToken};t=this.configurationService.getBackendUrl()+"/google_oauth/token",s={params:o}}return this.http.get(t,s).subscribe(function(e){0==e.result&&i.toast.sendToast("error authenticating","error",e.error);var t=e;i.session.authData.sessionId=t.id,i.session.authData.userId=t.userid,i.session.authData.companycode_id=t.companycode_id,i.session.authData.userName=t.user_name,i.session.authData.userimage=t.user_image,i.session.authData.first_name=t.first_name,i.session.authData.last_name=t.last_name,i.session.authData.display_name=t.display_name,i.session.authData.email=t.email,i.session.authData.admin=1==t.admin,i.session.authData.dev=1==t.dev,i.session.authData.portalOnly="1"===t.portal_only,i.session.authData.renewPass="1"===t.renewPass,i.session.authData.googleToken=t.access_token,i.session.authData.obtainGDPRconsent=t.obtainGDPRconsent,sessionStorage["OAuth-Token"]=i.session.authData.sessionId,sessionStorage[btoa(i.session.authData.sessionId+":backendurl")]=btoa(i.configurationService.getBackendUrl()),sessionStorage[btoa(i.session.authData.sessionId+":siteid")]=btoa(i.configurationService.getSiteId()),i.session.authData.renewPass||i.load(),i.broadcast.broadcastMessage("login"),i.loginSuccessful.next(!0),i.loginSuccessful.complete()},function(e){switch(e.status){case 401:i.toast.sendToast("error authenticating","error","Wrong username and/or password")}i.loginSuccessful.next(!1),i.loginSuccessful.error("Not logged in")}),this.loginSuccessful.asObservable()},e.prototype.load=function(){var t=this;this.loader.load().subscribe(function(e){return t.redirect(e)})},e.prototype.redirect=function(e){!0===e&&(this.session.authData.loaded=!0,this.toast.clearAll(),this.redirectUrl?(this.router.navigate([this.redirectUrl]),this.redirectUrl=""):this.router.navigate(["/"]))},e.prototype.logout=function(){this.http.delete(this.configurationService.getBackendUrl()+"/login?session_id="+this.session.authData.sessionId),this.session.endSession(),this.loader.reset(),this.broadcast.broadcastMessage("logout"),this.router.navigate(["/login"])},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[configurationService,http_1.HttpClient,router_1.Router,loader,toast,helper,session,broadcast,modal,metadata])],e)}();exports.loginService=loginService;var loginCheck=function(){function e(e,t,i,s){this.login=e,this.session=t,this.router=i,this.loader=s}return e.prototype.canActivate=function(e,t){return!(!this.session||!this.session.authData.sessionId)||("/"!=t.url&&(this.login.redirectUrl=t.url),this.router.navigate(["/login"]),!1)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[loginService,session,router_1.Router,loader])],e)}();exports.loginCheck=loginCheck;var dockedComposer=function(){function e(e,t){var i=this;this.modelutilities=e,this.broadcast=t,this.composers=[],this.calls=[],this.hiddenComposers=[],this.broadcast.message$.subscribe(function(e){return i.handleLogout(e)})}return e.prototype.handleLogout=function(e){"logout"==e.messagetype&&(this.composers=[],this.calls=[],this.hiddenComposers=[])},e.prototype.addComposer=function(e,t){t?this.composers.splice(0,0,{module:e,id:t.id,name:t.summary_text,model:{module:e,id:t.id,data:t.data}}):this.composers.splice(0,0,{module:e,id:this.modelutilities.generateGuid(),name:"",model:{}})},e.prototype.focusComposer=function(s){var a=this;this.composers.some(function(e,t){if(e.id==s){var i=a.composers.splice(t,1);return a.composers.unshift(i.shift()),!0}})},Object.defineProperty(e.prototype,"maxComposers",{get:function(){return Math.floor((window.innerWidth-70)/500)},enumerable:!0,configurable:!0}),e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[modelutilities,broadcast])],e)}();exports.dockedComposer=dockedComposer;var fts=function(){function e(e,t,i,s,a){this.backend=e,this.configurationService=t,this.session=i,this.modelutilities=s,this.metadata=a,this.hits=[],this.found=0,this.runningsearch=void 0,this.runningmodulesearch=void 0,this.searchTerm="",this.searchSort={},this.searchOwner=!1,this.searchGeo={},this.searchAggregates={},this.searchModules=[],this.modulefilter="",this.buckets={},this.moduleSearchresults=[],this.lastSearchParams={},this.gloablSearchResults={},this.getSearchModules()}return Object.defineProperty(e.prototype,"loadedSearchModules",{get:function(){var t=this;return this.searchModules.filter(function(e){return t.metadata.checkModuleAcl(e,"list")})},enumerable:!0,configurable:!0}),e.prototype.transformHits=function(e){for(var t=[],i=0,s=e;i<s.length;i++){var a=s[i];t.push(this.tranformHit(a))}return t},e.prototype.tranformHit=function(e){for(var t in e._source)e._source.hasOwnProperty(t)&&"string"==typeof e._source[t]&&(e._source[t]=e._source[t]);return e},e.prototype.search=function(e,t){var i=this;void 0===t&&(t=5),this.searchTerm=e,this.runningsearch&&this.runningsearch.unsubscribe(),this.resetData(),this.runningsearch=this.backend.postRequest("search",{},{size:t,searchterm:e,modules:this.loadedSearchModules.join(",")}).subscribe(function(e){i.hits=e.hits.hits,i.found=e.hits.total,i.runningsearch=void 0})},e.prototype.searchByModules=function(i){var s=this,a=new rxjs_1.Subject;return i.modules&&0!==i.modules.length||(i.modules=this.loadedSearchModules),i.searchterm&&-1!=i.searchterm.indexOf("%")&&(i.searchterm=i.searchterm.replace(/%/g,"*")),i.searchterm=i.searchterm.trim(),this.searchTerm=i.searchterm,this.searchAggregates=i.aggregates,this.searchSort=i.sortparams,this.searchGeo=i.searchgeo,this.searchOwner=i.owner,this.modulefilter=i.modulefilter,this.buckets=i.buckets,this.runningmodulesearch&&this.runningmodulesearch.unsubscribe(),this.runningmodulesearch=this.backend.postRequest("search",{},{modules:0<i.modules.length?i.modules.join(","):"",searchterm:i.searchterm,searchgeo:i.searchgeo,records:i.size,owner:i.owner,aggregates:this.searchAggregates,sort:this.searchSort,modulefilter:i.modulefilter,buckets:i.buckets}).subscribe(function(e){for(var t in s.moduleSearchresults=[],e)e.hasOwnProperty(t)&&s.moduleSearchresults.push({module:t,data:{hits:s.transformHits(e[t].hits),max_score:e[t].max_score,total:e[t].total}});s.moduleSearchresults.sort(function(e,t){var i=parseFloat(e.data.max_score),s=parseFloat(t.data.max_score);return isNaN(i)&&isNaN(s)?1:isNaN(s)?-1:isNaN(i)?1:i<s?1:-1}),s.lastSearchParams=i,s.runningmodulesearch=void 0,a.next(e),a.complete()}),a.asObservable()},e.prototype.export=function(e,t,i,s,a,r){void 0===s&&(s={}),void 0===a&&(a={}),void 0===r&&(r=!1);var o=new rxjs_1.Subject;return-1!=e.indexOf("%")&&(e=e.replace(/%/g,"*")),e=e.trim(),this.searchTerm=e,this.searchAggregates=s,this.searchSort=a,this.runningmodulesearch=this.backend.getDownloadPostRequestFile("search/export",{},{module:t,searchterm:e,fields:i,owner:r,aggregates:s,sort:this.searchSort}).subscribe(function(e){o.next(e),o.complete()}),o.asObservable()},e.prototype.loadMore=function(e){var o=this,n=new rxjs_1.Subject;if(!this.runningmodulesearch){if(e){for(var t=!1,i=0,s=e.bucketitems;i<s.length;i++){var a=s[i];(!a.total||a.total>a.items)&&(t=!0)}if(!t)return}else if(this.moduleSearchresults[0].data.hits.length>=this.moduleSearchresults[0].data.total)return;return this.runningmodulesearch=this.backend.postRequest("search",{},{modules:0<this.lastSearchParams.modules.length?this.lastSearchParams.modules.join(","):"",searchterm:this.lastSearchParams.searchterm,aggregates:this.searchAggregates,sort:this.searchSort,owner:this.searchOwner,records:this.lastSearchParams.size,start:this.moduleSearchresults[0].data.hits.length,modulefilter:this.modulefilter,buckets:e}).subscribe(function(e){for(var t=0,i=o.lastSearchParams.modules;t<i.length;t++)for(var s=0,a=e[i[t]].hits;s<a.length;s++){var r=a[s];o.moduleSearchresults[0].data.hits.push(o.tranformHit(r))}o.runningmodulesearch=void 0,n.next(e),n.complete()}),n.asObservable()}},e.prototype.getSearchModules=function(){var a=this;this.backend.getRequest("fts/searchmodules").subscribe(function(e){for(var t=0,i=e.modules;t<i.length;t++){var s=i[t];a.metadata.checkModuleAcl(s,"list")&&a.searchModules.push(s)}})},e.prototype.resetData=function(){this.found=0,this.hits=[]},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,configurationService,session,modelutilities,metadata])],e)}();exports.fts=fts;var navigation=function(){function e(e,t,i,s,a,r,o,n,u,l){var c=this;this.title=e,this.session=t,this.modal=i,this.language=s,this.broadcast=a,this.configurationService=r,this.metadata=o,this.helper=n,this.userpreferences=u,this.router=l,this.navigationparadigm="simple",this.enforcednavigationparadigm=!1,this.activeModule="Home",this.modelsEditing=[],this.modelregister=[],this.modelregisterCounter=0,this.activeObject="",this.maintab={path:void 0,params:void 0,id:"main",active:!0,pinned:!1,enablesubtabs:!1},this.objectTabs=[],this.objectTabsChange$=new core_1.EventEmitter,this.activeModule$=new core_1.EventEmitter,this.broadcast.message$.subscribe(function(e){return c.handleMessage(e)}),window.setTimeout(function(){addEventListener("beforeunload",function(e){c.anyDirtyModel()&&(e.preventDefault(),e.returnValue="")})},1),this.activeTab$=new rxjs_1.BehaviorSubject("main")}return e.prototype.setSessionData=function(){this.session.setSessionData("navigation",{main:this.maintab,tabs:this.objectTabs})},Object.defineProperty(e.prototype,"activeTabObject",{get:function(){return this.maintab.active?this.maintab:this.objectTabs.find(function(e){return e.active})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activeTab",{get:function(){var e;return this.maintab.active?"main":null===(e=this.objectTabs.find(function(e){return e.active}))||void 0===e?void 0:e.id},set:function(t){var e;this.maintab.active?this.maintab.active=!1:(e=this.objectTabs.find(function(e){return e.active}))&&(e.active=!1);"main"==t?(this.maintab.active=!0,this.activeTab$.next("main"),this.router.navigate([this.maintab.url])):(e=this.objectTabs.find(function(e){return e.id==t}))&&this.setTabActive(e);this.setSessionData()},enumerable:!0,configurable:!0}),e.prototype.setTabActive=function(e){e.active=!0,this.activeTab$.next(e.id),this.router.navigate([e.url])},e.prototype.getSubTabs=function(t){return t?this.objectTabs.filter(function(e){return e.parentid==t}):[]},Object.defineProperty(e.prototype,"displayTab",{get:function(){var e;return this.maintab.active?"main":null===(e=this.objectTabs.find(function(e){return e.active}))||void 0===e?void 0:e.id},enumerable:!0,configurable:!0}),e.prototype.setActiveModule=function(e,t,i){void 0===t&&(t=""),void 0===i&&(i=""),this.activeModule=e,this.activeModule$.emit(e),this.title.setTitle(this.systemName+" "+(""!==i?i:e))},Object.defineProperty(e.prototype,"systemName",{get:function(){return this.configurationService.data.display?this.configurationService.data.display:"SpiceCRM"},enumerable:!0,configurable:!0}),e.prototype.enforceNavigationParadigm=function(e){this.enforcednavigationparadigm=!0,this.navigationparadigm=e},e.prototype.handleMessage=function(e){switch(e.messagetype){case"loader.completed":if(!this.enforcednavigationparadigm&&"loadUserData"==e.messagedata){var t=this.userpreferences.getPreference("navigation_paradigm");this.navigationparadigm=t||"simple"}break;case"userpreferences.save":var i=this.userpreferences.getPreference("navigation_paradigm");!this.enforcednavigationparadigm&&i&&this.navigationparadigm!=i&&("simple"==i&&this.navigationparadigm!=i?(this.objectTabs=[],this.router.navigate(["module/Home"])):"simple"!=i&&this.navigationparadigm!=i&&this.router.navigate(["module/Home"]),this.navigationparadigm=i);break;case"logout":this.objectTabs=[],this.maintab={path:void 0,params:void 0,id:"main",pinned:!1,active:!0,enablesubtabs:!1};break;case"login":var s=this.session.getSessionData("navigation");_.isEmpty(s)||(this.maintab=s.main,this.objectTabs=s.tabs,this.maintab.params.module&&(this.activeModule=this.maintab.params.module),this.activeTab$.next(this.activeTab))}},e.prototype.addModelEditing=function(e,t,i){this.modelsEditing.push({module:e,id:t,summary_text:i,tabid:this.activeTab})},e.prototype.removeModelEditing=function(t,i){var s=this,a=0;this.modelsEditing.some(function(e){if(e.id==i&&e.module==t)return s.modelsEditing.splice(a,1),!0;a++})},Object.defineProperty(e.prototype,"editing",{get:function(){return 0<this.modelsEditing.length},enumerable:!0,configurable:!0}),e.prototype.discardAllChanges=function(){this.modelsEditing=[]},e.prototype.registerModel=function(e){var t=++this.modelregisterCounter;return this.modelregister.push({id:t,model:e,tabid:this.activeTab}),t},e.prototype.unregisterModel=function(i){var s=this;this.modelregister.some(function(e,t){if(e.id===i)return s.modelregister.splice(t,1),!0})},e.prototype.getRegisteredModel=function(t,i){var e;return null===(e=this.modelregister.find(function(e){return e.id==t&&e.model.module==i}))||void 0===e?void 0:e.model},e.prototype.anyDirtyModel=function(t){return!!this.modelregister.some(function(e){if(e.model.isDirty()&&(!t||t&&e.tabid==t))return!0})},e.prototype.matchPath=function(e,t){if(e.path.replace("tab/:tabid/","")==t.path)return!0;if(e.path.replace("tab/:tabid/","")==t.referencepath)return!0;var i=this.metadata.getRouteDetails(e.path.replace("tab/:tabid/",""));return!(!i.referencepath||i.referencepath!=t.path)||!(!i.referencepath||i.referencepath!=t.referencepath)},e.prototype.buildUrl=function(e){var t="";return e.forEach(function(e){""!=t&&(t+="/"),t+=e.path}),t},e.prototype.matchRouteParams=function(e,t){if(_.isEqual(e.params,t))return!0;if(t.tabid&&t.tabid==e.id){var i=__assign({},t);return delete i.tabid,_.isEqual(e.params,i)}return!1},e.prototype.handleNavigation=function(i,s,a){var e,r=this,t=this.metadata.getRouteDetails(s.path.replace("tab/:tabid/",""));if("M"==(null===(e=t)||void 0===e?void 0:e.target)||"simple"==this.navigationparadigm){if(this.maintab.path==s.path&&_.isEqual(this.maintab.params,i))return void(this.activeTab="main");this.mainTabChangeCheck().subscribe(function(e){var t;e?(r.maintab.path=s.path,r.maintab.params=__assign({},i),r.maintab.url=r.buildUrl(a.url),r.activeTab="main",(null===(t=r.maintab.params)||void 0===t?void 0:t.module)&&(r.activeModule=r.maintab.params.module)):r.router.navigate([r.maintab.url])})}else{for(var o=0,n=this.objectTabs;o<n.length;o++){var u=n[o];if(this.matchPath(u,t)&&this.matchRouteParams(u,i))return u.path!=s.path.replace("tab/:tabid/","")&&(u.path=s.path,u.url=this.buildUrl(a.url)),void(this.activeTab=u.id)}var l=void 0;"subtabbed"==this.navigationparadigm&&i.tabid&&(l=this.objectTabs.find(function(e){return e.id==i.tabid}));var c=this.helper.generateGuid();this.objectTabs.unshift({id:c,parentid:l&&l.enablesubtabs?l.id:void 0,path:s.path,url:this.buildUrl(a.url),params:__assign({},i),active:!1,pinned:!1,enablesubtabs:"1"==t.subtabs}),this.activeTab=c,this.objectTabsChange$.emit(!0)}},e.prototype.setActiveTab=function(e){this.activeTab=e,this.activeTab$.next(this.activeTab)},e.prototype.settabinfo=function(e,t){if("main"==e)t.displaymodule&&this.setActiveModule(t.displaymodule);else{var i=this.getTabById(e);i&&(i.displayname=t.displayname,i.displaymodule=t.displaymodule,i.displayicon=t.displayicon,this.objectTabsChange$.emit(!0))}},e.prototype.getTabById=function(t){return"main"==t?this.maintab:this.objectTabs.find(function(e){return e.id==t})},e.prototype.mainTabChangeCheck=function(){if(this.anyDirtyModel("main")){var t=new rxjs_1.Subject;return this.modal.confirm(this.language.getLabel("MSG_NAVIGATIONSTOP","","long"),this.language.getLabel("MSG_NAVIGATIONSTOP")).subscribe(function(e){e?t.next(!0):t.next(!1),t.complete()}),t.asObservable()}return rxjs_1.of(!0)},e.prototype.closeObjectTab=function(t,e){var i=this;void 0===e&&(e=!1),"main"!=t&&(!e&&this.anyDirtyModel(t)?this.modal.confirm(this.language.getLabel("MSG_NAVIGATIONSTOP","","long"),this.language.getLabel("MSG_NAVIGATIONSTOP")).subscribe(function(e){e&&i.unsetObjectTab(t)}):this.unsetObjectTab(t))},e.prototype.unsetObjectTab=function(t){var e,i=this,s=this.objectTabs.findIndex(function(e){return e.id==t});if(0<=s){!this.objectTabs[s].active&&(null===(e=this.objectTabs.find(function(e){return e.active}))||void 0===e?void 0:e.parentid)!=t||(this.objectTabs[s].parentid?this.router.navigate([this.objectTabs.find(function(e){return e.id==i.objectTabs[s].parentid}).url]):this.router.navigate([this.maintab.url])),this.objectTabs.splice(s,1);for(var a=-1;0<=(a=this.modelregister.findIndex(function(e){return e.tabid==t}));)this.modelregister.splice(a,1)}for(var r=s=0,o=this.objectTabs;r<o.length;r++){if(o[r].parentid==t){this.objectTabs.splice(s,1);for(a=-1;0<=(a=this.modelregister.findIndex(function(e){return e.tabid==t}));)this.modelregister.splice(a,1)}else s++}this.objectTabsChange$.emit(!0),this.setSessionData()},e.prototype.checkActiveRoute=function(e){return _.isEqual(e,this.activeRoute)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[platform_browser_1.Title,session,modal,language,broadcast,configurationService,metadata,helper,userpreferences,router_1.Router])],e)}();exports.navigation=navigation;var canNavigateAway=function(){function e(e,t,i){this.navigation=e,this.modal=t,this.language=i}return e.prototype.canActivate=function(e,t){for(var i=this,s=!1,a=0,r=this.navigation.modelregister;a<r.length;a++){var o=r[a];if(!o.model.isGlobal&&o.model.isDirty()){s=!0;break}}if(s){var n=new rxjs_1.Subject;return this.modal.confirm(this.language.getLabel("MSG_NAVIGATIONSTOP","","long"),this.language.getLabel("MSG_NAVIGATIONSTOP")).subscribe(function(e){e&&i.navigation.discardAllChanges(),n.next(e),n.complete()}),n.asObservable()}return rxjs_1.of(!0)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[navigation,modal,language])],e)}();exports.canNavigateAway=canNavigateAway;var navigationtab=function(){function e(){this.activeRoute={params:void 0,path:void 0},this.tabinfo$=new core_1.EventEmitter,this.close$=new core_1.EventEmitter,this.activeRoute$=new rxjs_1.BehaviorSubject(this.activeRoute)}return e.prototype.setTabInfo=function(e){this.tabinfo$.emit(e)},e.prototype.closeTab=function(){this.close$.emit(!0)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.navigationtab=navigationtab;var model=function(){function e(e,t,i,s,a,r,o,n,u,l,c,d,h){var p=this;this.backend=e,this.broadcast=t,this.metadata=i,this.utils=s,this.session=a,this.recent=r,this.router=o,this.toast=n,this.language=u,this.modal=l,this.navigation=c,this.configuration=d,this.injector=h,this._module="",this.id="",this.acl={},this.data={acl:{edit:!0}},this.backupData={},this.isSaving=!1,this.saved$=new core_1.EventEmitter,this.mode$=new core_1.EventEmitter,this.canceledit$=new core_1.EventEmitter,this.isValid=!1,this.isLoading=!1,this.isEditing=!1,this.isGlobal=!1,this.isNew=!1,this._fields_stati=[],this._fields_stati_tmp=[],this._model_stati_tmp=[],this._messages=[],this.reference="",this._fields=[],this.messageChange$=new core_1.EventEmitter,this.duplicate=!1,this.templateId=null,this.duplicateChecking=!1,this.duplicates=[],this.duplicatecount=0,this.savingProgress=new rxjs_1.BehaviorSubject(1),this.modelRegisterId=this.navigation.registerModel(this),this.data$=new rxjs_1.BehaviorSubject(this.data),this.broadcast.message$.subscribe(function(e){"timezone.changed"===e.messagetype&&(p.utils.timezoneChanged(p.data,e.messagedata),p.utils.timezoneChanged(p.backupData,e.messagedata))})}return Object.defineProperty(e.prototype,"messages",{get:function(){return this._messages},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"module",{get:function(){return this._module},set:function(e){this._module=e,this.initializeFieldsStati()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayname",{get:function(){return this.getFieldValue("summary_text")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fields",{get:function(){return!this.module||this._fields&&0!=this._fields.length||(this._fields=this.metadata.getModuleFields(this.module)),this._fields},enumerable:!0,configurable:!0}),e.prototype.generateGuid=function(){return this.utils.generateGuid()},e.prototype.isFieldRequired=function(e){switch(e){case"date_entered":case"date_modified":return!0;default:return this.metadata.getFieldRequired(this.module,e)}},e.prototype.isRequired=function(e){return this.isFieldRequired(e)},e.prototype.checkAccess=function(e){return!(!this.data||!this.data.acl)&&this.data.acl[e]},e.prototype.checkFieldAccess=function(e){return!(this.data&&this.data.acl_fieldcontrol&&this.data.acl_fieldcontrol[e]&&"1"==this.data.acl_fieldcontrol[e])},e.prototype.goDetail=function(e){if(!this.checkAccess("detail"))return!1;var t="/module/"+this.module+"/"+this.id;e&&(t="/tab/"+e+"/"+t),this.router.navigate([t])},e.prototype.goModule=function(){this.router.navigate(["/module/"+this.module])},e.prototype.getData=function(e,t,i,s){var a=this;void 0===e&&(e=!0),void 0===t&&(t=""),void 0===i&&(i=!0),void 0===s&&(s=!1);var r=new rxjs_1.Subject;return e&&this.resetData(),this.isLoading=i,this.backend.get(this.module,this.id,t).subscribe(function(e){a.data=e,""!=t&&a.recent.trackItem(a.module,a.id,a.data),a.initializeFieldsStati(),a.evaluateValidationRules(null,"init"),a.isLoading=!1,a.data$.next(e),a.broadcast.broadcastMessage("model.loaded",{id:a.id,module:a.module,data:a.data}),r.next(e),r.complete()},function(e){s&&401!=e.status&&(a.toast.sendToast(a.language.getLabel("LBL_ERROR_LOADING_RECORD"),"error"),a.router.navigate(["/module/"+a.module])),r.error(e)}),r.asObservable()},e.prototype.validate=function(e){for(var t in this.resetMessages(),this.isValid=!0,this.evaluateValidationRules(null,"change"),this.fields)"id"===t||!this.getFieldStati(t).required||this.data[t]&&0!==this.data[t].length||(this.isValid=!1,this.addMessage("error",this.language.getLabel("MSG_INPUT_REQUIRED")+"!",t)),this.getFieldStati(t).invalid&&(this.isValid=!1);return this.isValid||console.warn("validation failed:",this.messages),this.isValid},e.prototype.initializeFieldsStati=function(){var e=[];for(var t in this.fields)e[t]=this.evaluateFieldStati(t);this._fields_stati=e},e.prototype.getDefaultStati=function(){return{editable:this.checkAccess("edit"),invalid:!1,required:!1,incomplete:!1,disabled:!1,hidden:!1,readonly:!1}},e.prototype.evaluateFieldStati=function(e){var t=this.getDefaultStati();return this.data&&this.data.acl_fieldcontrol&&this.data.acl_fieldcontrol[e]&&parseInt(this.data.acl_fieldcontrol[e],10)<3&&(t.editable=!1),this.isRequired(e)&&(t.required=!0),t},e.prototype.resetFieldStati=function(e){this._fields_stati[e]=this.evaluateFieldStati(e),this._fields_stati_tmp[e]=__assign({},this._fields_stati[e]),this.getFieldMessages(e,"error")&&(this._fields_stati_tmp[e].invalid=!0)},e.prototype.setFieldStatus=function(e,t,i){void 0===i&&(i=!0);try{var s=this._fields_stati[e];return s[t]&&!i?(console.warn("could not set status "+t+" to "+i+" because it has to be: "+s[t]),!1):(this._fields_stati_tmp[e]||(this._fields_stati_tmp[e]=__assign({},s)),this._fields_stati_tmp[e][t]=i,!0)}catch(e){return console.warn(e),!1}},e.prototype.setFieldStati=function(e,t){for(var i in t){if(!this.setFieldStatus(e,i,t[i]))return!1}return!0},e.prototype.getFieldStati=function(e){var t=this._fields_stati_tmp[e];return(t=t||this._fields_stati[e])||(t=this.getDefaultStati(),this._fields_stati[e]=t),!(t=__assign({},t)).invalid&&this.getFieldMessages(e,"error")&&(t.invalid=!0),t},e.prototype.evaluateValidationRules=function(e,t){var i=this.metadata.getModuleValidations(this.module);if(!i)return!0;this._fields_stati_tmp=[],this._model_stati_tmp=[],this.resetMessages();for(var s=0,a=i;s<a.length;s++){var r=a[s],o=0,n=!0;if(!(r.onevents instanceof Array)||r.onevents.includes(t)){if(r.conditions instanceof Array)for(var u=0,l=r.conditions;u<l.length;u++){var c=l[u];if(0<(o+=(1!=c.onchange||!e||c.fieldname==e)&&this.evaluateCondition(c)?1:0)&&"or"==r.logicoperator){n=!0;break}}if(r.conditions&&1<r.conditions.length&&"and"==r.logicoperator?o<r.conditions.length&&(n=!1):0==o&&r.conditions&&(n=!1),n)for(var d=0,h=r.actions;d<h.length;d++){var p=h[d];this.executeValidationAction(p)||console.warn("Action "+p.action+" for "+p.fieldname+" failed!")}}}},e.prototype.evaluateCondition=function(e){if(void 0===this.data[e.fieldname])return!1;var t=this.data[e.fieldname],i=this.evaluateValidationParams(e.valuations);return modelutilities.compare(t,e.comparator,i)},e.prototype.executeValidationAction=function(e){var t=this.evaluateValidationParams(e.params);switch(e.action){case"set_value":return this.data[e.fieldname]=t,!0;case"set_message":return t instanceof Object&&(this._messages.push(t),this.messageChange$.emit(!0),!0);case"error":return this.addMessage("error",t,e.fieldname);case"warning":return this.addMessage("warning",t,e.fieldname);case"notice":return this.addMessage("notice",t,e.fieldname);case"hide":return t="string"==typeof t?modelutilities.strtobool(t):t,this.setFieldStatus(e.fieldname,"hidden",t);case"show":return t=!("string"==typeof t?modelutilities.strtobool(t):t),this.setFieldStatus(e.fieldname,"hidden",t);case"require":return t="string"==typeof t?modelutilities.strtobool(t):t,this.setFieldStatus(e.fieldname,"required",t);case"set_stati":return t="string"==typeof t?JSON.parse(t):t,this.setFieldStati(e.fieldname,t);case"set_model_state":if(t instanceof Array)for(var i=0,s=t;i<s.length;i++){var a=s[i];this.checkModelState(a)||this._model_stati_tmp.push(a)}else this.checkModelState(t)||this._model_stati_tmp.push(t);return!0;default:return console.warn("action: "+e.action+" is not defined!"),!1}},e.prototype.evaluateValidationParams=function(e,t){if("string"==typeof e){if(/(\<[a-z\_]+\>)/.test(e))for(var i=0,s=e.match(/(\<[a-z\_]+\>)/g);i<s.length;i++){var a=s[i],r=a.replace("<","").replace(">",""),o=this.data[r]?this.data[r]:0;switch(this.metadata.getFieldDefs(this.module,r).type){case"datetimecombo":case"datetime":case"date":o=o&&o.format("YYYY-MM-DD HH:mm:ss")}e=e.replace(a,o)}if(/\d+[\.\-]\d+[\.\-]\d+/.test(e)&&/[\+\-]/.test(e))e=modelutilities.strtomoment(e)||e;else if(/\d+\s*[\+\-\*\/\^]\s*\d+/.test(e)){e=this.utils.compileMathExpression(e)||e}}return e},e.prototype.checkModelState=function(e){return this._model_stati_tmp.includes(e)},e.prototype.startEdit=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1),this.isEditing||(e&&!this.duplicate&&(this.backupData=__assign({},this.data)),t||(this.isEditing=!0,this.mode$.emit("edit")),this.navigation.addModelEditing(this.module,this.id,this.getFieldValue("summary_text")))},e.prototype.getFieldValue=function(e){return this.data[e]},e.prototype.getField=function(e){return this.getFieldValue(e)},e.prototype.setFieldValue=function(e,t){if(!e)return!1;this.data[e]=t,this.data$.next(this.data),this.evaluateValidationRules(e,"change"),this.duplicateCheckOnChange([e])},e.prototype.setField=function(e,t){return this.setFieldValue(e,t)},e.prototype.setFields=function(e){var t=[];for(var i in e){var s=e[i];_.isString(s)&&(s=s.trim()),this.data[i]=s,t.push(i)}this.data$.next(this.data),this.evaluateValidationRules(null,"change"),this.duplicateCheckOnChange(t)},e.prototype.cancelEdit=function(){this.isEditing=!1,this.mode$.emit("display"),this.navigation.removeModelEditing(this.module,this.id),this.backupData&&(this.data=__assign({},this.backupData),this.data$.next(this.data),this.backupData=null,this.resetMessages()),this.canceledit$.emit(!0)},e.prototype.endEdit=function(){this.backupData=null,this.isEditing=!1,this.mode$.emit("display"),this.navigation.removeModelEditing(this.module,this.id)},e.prototype.getDirtyFields=function(){var e={};for(var t in this.data)t&&(!this.backupData||_.isObject(this.data[t])||_.isArray(this.data[t])||!_.isEqual(this.data[t],this.backupData[t])||this.isFieldARelationLink(t))&&(e[t]=this.data[t]);return e},e.prototype.save=function(i){var s=this;void 0===i&&(i=!1);var a=new rxjs_1.Subject;for(var e in this.isSaving=!0,this.data)_.isString(this.data[e])&&(this.data[e]=this.data[e].trim());var t={};return this.isEditing&&!this.isNew?(t=this.getDirtyFields()).date_modified=this.data.date_modified:t=this.data,this.backend.save(this.module,this.id,t,this.savingProgress,this.templateId).subscribe(function(e){s.data=e,s.isNew=!1,s.data$.next(e),s.broadcast.broadcastMessage("model.save",{id:s.id,reference:s.reference,module:s.module,data:s.data,changed:s.getDirtyFields(),backupdata:__assign({},s.backupData)}),s.isSaving=!1,i&&s.toast.sendToast(s.language.getLabel("LBL_DATA_SAVED")+".","success"),s.saved$.emit({changed:s.getDirtyFields(),backupdata:__assign({},s.backupData)}),s.endEdit(),s.initializeFieldsStati(),a.next(!0),a.complete()},function(t){switch(t.status){case 409:s.modal.openModal("ObjectOptimisticLockingModal",!1,s.injector).subscribe(function(e){e.instance.conflicts=t.error.error.conflicts});break;default:i&&s.toast.sendToast(s.language.getLabel("LBL_ERROR")+" "+t.status,"error",t.error.error.message),a.error(!0),a.complete()}s.isSaving=!1}),a.asObservable()},e.prototype.delete=function(){var t=this,i=new rxjs_1.Subject;return this.backend.delete(this.module,this.id).subscribe(function(e){t.broadcast.broadcastMessage("model.delete",{id:t.id,module:t.module,data:_.clone(t.data)}),i.next(!0),i.complete()}),i.asObservable()},e.prototype.reset=function(){this.id=null,this.module=null,this._fields_stati_tmp=this._fields_stati=[],this.isLoading=!1,this.isEditing=!1,this.mode$.emit("display"),this.resetMessages(),this.resetData()},e.prototype.clone=function(){return{module:this.module,id:this.id,data:__assign({},this.data)}},e.prototype.getAuditLog=function(e){void 0===e&&(e={});var t=new rxjs_1.Subject;return this.backend.getAudit(this.module,this.id,e).subscribe(function(e){t.next(e),t.complete()},function(e){t.next(e),t.complete()}),t.asObservable()},e.prototype.resetData=function(){this.isValid=!0,this.data={}},e.prototype.initialize=function(e){return void 0===e&&(e=null),this.initializeModel(e)},e.prototype.initializeModel=function(e){void 0===e&&(e=null),this.id||(this.id=this.generateGuid(),this.isNew=!0),this.duplicates=[],this.data={},this.data.assigned_user_id=this.session.authData.userId,this.data.assigned_user_name=this.session.authData.userName,this.data.modified_by_id=this.session.authData.userId,this.data.modified_by_name=this.session.authData.userName,this.data.date_entered=new moment,this.data.date_modified=new moment,this.executeCopyRules(e),this.evaluateValidationRules(),this.data.acl={create:!0,edit:!0},this.initializeFieldsStati(),this.evaluateValidationRules(null,"init")},e.prototype.addModel=function(e,t,i,s){var a=this;void 0===e&&(e=""),void 0===t&&(t=null),void 0===i&&(i={}),void 0===s&&(s=!1);var r=new rxjs_1.Subject;if(this.metadata.checkModuleAcl(this.module,"create")){for(var o in this.initializeModel(),this.executeCopyRules(t),this.reference=e,i)this.data[o]=i[o];this.modal.openModal("ObjectEditModal",!1,this.injector).subscribe(function(e){e&&(e.instance.model.isNew=!0,e.instance.reference=a.reference,e.instance.preventGoingToRecord=s,e.instance.action$.subscribe(function(e){"save"!=e&&"savegodetail"!=e||(r.next(a.data),a.recent.trackItem(a.module,a.id,a.data)),r.complete()}))})}else this.toast.sendToast(this.language.getLabel("MSG_NOT_AUTHORIZED_TO_CREATE")+" "+this.language.getModuleName(this.module),"error"),window.setTimeout(function(){r.complete()},100);return r.asObservable()},e.prototype.executeCopyRules=function(e){if(e)if(_.isArray(e))for(var t=0,i=e;t<i.length;t++){var s=i[t];s.data&&this.executeCopyRulesParent(s)}else e.data&&this.executeCopyRulesParent(e);this.executeCopyRulesGeneric()},e.prototype.executeCopyRulesGeneric=function(){for(var e=0,t=this.metadata.getCopyRules("*",this.module);e<t.length;e++){var i=t[e];i.tofield&&i.fixedvalue?this.setFixedValue(i.tofield,i.fixedvalue):i.tofield&&i.calculatedvalue&&this.setFieldValue(i.tofield,this.getCalculatdValue(i.calculatedvalue))}},e.prototype.executeCopyRulesParent=function(e){e.data.id||(e.data.id=e.id);for(var t=0,i=this.metadata.getCopyRules(e.module,this.module);t<i.length;t++){var s=i[t];s.fromfield&&s.tofield?this.copyValue(s.tofield,e.data[s.fromfield]):s.tofield&&s.fixedvalue&&this.setFieldValue(s.tofield,s.fixedvalue)}},e.prototype.copyValue=function(e,t){var i=this.metadata.getFieldDefs(this.module,e);switch(i||this.setField(e,t),i.type){case"link":if(_.isObject(t)&&t.beans){var s={beans:{}};for(var a in t.beans)s.beans[this.utils.generateGuid()]=__assign({},t.beans[a]);this.setField(e,s)}default:this.setField(e,t)}},e.prototype.setFixedValue=function(e,t){var i=this.metadata.getFieldDefs(this.module,e);switch(i||this.setField(e,t),i.type){case"bool":this.setField(e,"true"===t||"1"===t||"false"!==t&&"0"!==t&&null);break;default:this.setField(e,t)}},e.prototype.getCalculatdValue=function(e){switch(e){case"now":return new moment;case"nextfullhour":var t=new moment;return 0==t.minute()||(t.minute(0),t.add(1,"h")),t}return""},e.prototype.edit=function(t,i){if(void 0===t&&(t=!1),void 0===i&&(i=""),!this.checkAccess("edit"))return rxjs_1.of(!1);var s=new rxjs_1.Subject;return this.modal.openModal("ObjectEditModal",!1,this.injector).subscribe(function(e){e&&(i&&""!=i&&(e.instance.componentSet=i),t&&e.instance.model.getData(!1,"editview",!1),e.instance.actionSubject.subscribe(function(e){s.next(e),s.complete()}))}),s.asObservable()},e.prototype.duplicateCheckOnChange=function(e){var t=this;if(this.isNew&&this.metadata.getModuleDuplicatecheck(this.module)){var i=this.metadata.getModuleDuplicateCheckFields(this.module);if(0==i.length)return;for(var s=!1,a=!1,r=0,o=i;r<o.length;r++){var n=o[r];a=a||0<=e.indexOf(n),s=s||this.getField(n)}if(s&&a){var u=new rxjs_1.Subject;return this.duplicateCheck(!0).subscribe(function(e){t.duplicates=e.records,t.duplicatecount=e.count,u.next(!0),u.complete()},function(e){u.next(!1),u.complete()}),u.asObservable()}a&&!s&&(this.duplicates=[])}return rxjs_1.of(!1)},e.prototype.duplicateCheck=function(e){var t=this;if(void 0===e&&(e=!1),this.metadata.getModuleDuplicatecheck(this.module)){this.duplicateChecking=!0;var i=new rxjs_1.Subject;if(e){var s=this.data;s.id=this.id,this.backend.checkDuplicates(this.module,s).subscribe(function(e){i.next(e),i.complete(),t.duplicateChecking=!1},function(e){i.next([]),i.complete(),t.duplicateChecking=!1})}else this.backend.getDuplicates(this.module,this.id).subscribe(function(e){i.next(e),i.complete(),t.duplicateChecking=!1},function(e){i.next([]),i.complete(),t.duplicateChecking=!1});return i.asObservable()}return rxjs_1.of([])},e.prototype.addMessage=function(e,t,i,s){return void 0===i&&(i=null),void 0===s&&(s="validation"),this._messages.push({type:e,message:t,reference:i,source:s}),"error"==e&&i&&this.setFieldStatus(i,"invalid",!0),this.messageChange$.emit(!0),!0},e.prototype.getMessages=function(){return this.messages},e.prototype.setFieldMessage=function(e,t,i,s){return this.resetFieldMessages(i,e,s),"error"==e&&this.setFieldStatus(i,"invalid",!0),this.addMessage(e,t,i,s)},e.prototype.getFieldMessages=function(t,i){var e=this._messages.filter(function(e){return e.reference==t&&(!i||e.type==i)});return 0<e.length&&e},e.prototype.resetFieldMessages=function(e,t,i){if(0==this._messages.length)return!0;for(var s=this._messages.length-1;0<=s;s--){var a=this._messages[s];a.reference!=e||t&&a.type!=t||i&&a.source!=i||(this._messages.splice(s,1),this.messageChange$.emit(!0))}return this.resetFieldStati(e),!0},e.prototype.resetMessages=function(e,t){if(void 0===t&&(t="validation"),0==this._messages.length)return!0;for(var i=this._messages.length-1;0<=i;i--){var s=this._messages[i];e&&s.type!=e||t&&s.source!=t||(this._messages.splice(i,1),this.messageChange$.emit(!0)),this.resetFieldStati(s.reference)}return!0},e.prototype.isFieldARelationLink=function(e){try{return"link"==this.fields[e].type}catch(e){return!1}},e.prototype.getRelatedRecords=function(e){var t=[];if(!this.isFieldARelationLink(e))return t;if(!this.data[e])return t;for(var i in this.data[e].beans)t.push(this.data[e].beans[i]);return t},e.prototype.setRelatedRecords=function(e,t){return void 0===t&&(t=null),!!this.isFieldARelationLink(e)&&(this.data[e]={beans:{}},t?this.addRelatedRecords(e,t):void 0)},e.prototype.addRelatedRecords=function(e,t,i){if(void 0===i&&(i=!0),!this.isFieldARelationLink(e))return!1;this.data[e]||(this.data[e]={beans:{}});for(var s=0,a=t;s<a.length;s++){var r=a[s];!i&&this.data[e].beans[r.id]||(this.data[e].beans[r.id]=r)}return!0},e.prototype.ngOnDestroy=function(){this.navigation.unregisterModel(this.modelRegisterId)},e.prototype.isDirty=function(){return this.isEditing&&_.values(this.getDirtyFields()).length},e.prototype.checkModuleFilterMatch=function(e){var t=this.configuration.getData("modulefilters");if(!t[e]||!t[e].filterdefs)return!1;var i=t[e].filterdefs;return i="string"==typeof i?JSON.parse(i):i,!!t&&this.checkModuleFilterGroupMatch(i)},e.prototype.checkModuleFilterGroupMatch=function(t){var i=this;if("own"==t.groupscope&&this.data.assigned_user_id!=this.session.authData.userId)return!1;var s=!1;return!(!t||!t.conditions)&&(t.conditions.forEach(function(e){return s=e.conditions?i.checkModuleFilterGroupMatch(e):i.checkModuleFilterConditionMatch(e),!("AND"==t.logicaloperator&&!s)&&(!!s||void 0)}),s)},e.prototype.checkModuleFilterConditionMatch=function(e){switch(e.operator){case"empty":return""==this.getFieldValue(e.field)||null==this.getFieldValue(e.field);case"equals":return this.getFieldValue(e.field)==e.filtervalue;case"oneof":return-1<(e.filtervalue instanceof Array?e.filtervalue:e.filtervalue.split(",")).indexOf(this.getFieldValue(e.field));case"true":return 1==this.getFieldValue(e.field);case"false":return 0==this.getFieldValue(e.field);case"starts":return 0==this.getFieldValue(e.field).indexOf(e.filtervalue);case"contains":return this.getFieldValue(e.field).includes(e.filtervalue);case"ncontains":return!this.getFieldValue(e.field).includes(e.filtervalue);case"greater":return this.getFieldValue(e.field)>e.filtervalue;case"gequal":return this.getFieldValue(e.field)>=e.filtervalue;case"less":return this.getFieldValue(e.field)<e.filtervalue;case"lequal":return this.getFieldValue(e.field)<=e.filtervalue;case"today":return moment(this.getFieldValue(e.field)).isSame(new moment,"days");case"past":return moment(this.getFieldValue(e.field)).isBefore(new moment);case"future":return moment(this.getFieldValue(e.field)).isAfter(new moment);case"thismonth":return moment(this.getFieldValue(e.field)).isSame(new moment,"month");case"nextmonth":return moment(this.getFieldValue(e.field)).isAfter(new moment,"month");case"thisyear":return moment(this.getFieldValue(e.field)).isSame(new moment,"year");case"nextyear":return moment(this.getFieldValue(e.field)).isAfter(new moment,"year");case"inndays":return moment(this.getFieldValue(e.field)).isSame((new moment).add(+e.filtervalue,"d"),"days");case"ndaysago":return moment(this.getFieldValue(e.field)).isSame((new moment).subtract(+e.filtervalue,"d"),"days");case"inlessthandays":return moment(this.getFieldValue(e.field)).isBefore((new moment).add(+e.filtervalue,"d"),"days");case"inmorethandays":return moment(this.getFieldValue(e.field)).isAfter((new moment).add(+e.filtervalue,"d"),"days")}},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,broadcast,metadata,modelutilities,session,recent,router_1.Router,toast,language,modal,navigation,configurationService,core_1.Injector])],e)}();exports.model=model;var mediafiles=function(){function e(e,t,i,s,a,r,o,n,u,l){this.sanitizer=e,this.http=t,this.backend=i,this.configurationService=s,this.session=a,this.metadata=r,this.footer=o,this.toast=n,this.language=u,this.modalservice=l,this.categoriesLoaded=!1,this.categories={},this.categoriesSorted=[]}return e.prototype._getImage=function(e,t){var i=this;void 0===t&&(t="");var s=new rxjs_1.Subject;return this.backend.getRawRequest("module/MediaFiles/"+e+"/file"+(""!=t?"/":"")+t,{},null,{}).subscribe(function(e){var t=URL.createObjectURL(e);s.next(i.sanitizer.bypassSecurityTrustUrl(t)),s.complete()}),s.asObservable()},e.prototype._getImageBase64=function(e){var t=new rxjs_1.Subject;return this.backend.getRequest("module/MediaFiles/"+e+"/base64").subscribe(function(e){t.next(e),t.complete()}),t.asObservable()},e.prototype.getImageVariant=function(e,t){return this._getImage(e,t)},e.prototype.getImage=function(e){return this._getImage(e,"")},e.prototype.getImageBase64=function(e){return this._getImageBase64(e)},e.prototype.getImageThumb=function(e,t){return this._getImage(e,"th/"+t)},e.prototype.getImageSquare=function(e,t){return this._getImage(e,"sq/"+t)},e.prototype.uploadFile=function(e){if(0!==e.length){var i=new rxjs_1.Subject,t=new FormData;t.append("file",e[0],e[0].name);var s=new XMLHttpRequest;return s.onreadystatechange=function(e){if(void 0===e&&(e=this),4==s.readyState)try{var t=JSON.parse(s.response);i.next({filedata:t}),i.complete()}catch(e){({status:"error",data:"Unknown error occurred: ["+s.responseText+"]"})}},s.upload.addEventListener("progress",function(e){i.next({progress:{total:e.total,loaded:e.loaded}})},!1),s.open("POST",this.configurationService.getBackendUrl()+"/module/MediaFiles/fileupload",!0),s.setRequestHeader("OAuth-Token",this.session.authData.sessionId),s.send(t),i.asObservable()}},e.prototype.getMediaFile=function(e,t,i,s,a){var r=this;void 0===i&&(i=!1),void 0===s&&(s=!1);var o=new rxjs_1.Subject;return i?this.uploadMediaFile([],s,a).subscribe(function(e){e&&(o.next(e),o.complete())}):this.pickMediaFile(e,t).subscribe(function(e){e.id?(o.next(e.id),o.complete()):!0===e.upload&&r.uploadMediaFile([],s,a).subscribe(function(e){e&&(o.next(e),o.complete())})}),o.asObservable()},e.prototype.pickMediaFile=function(t,i){var s=new rxjs_1.Subject;return this.modalservice.openModal("MediaFilePicker").subscribe(function(e){e.instance.mediatype=t,e.instance.filetype=i,e.instance.answer.subscribe(function(e){s.next(e),s.complete()})}),s.asObservable()},e.prototype.uploadMediaFile=function(t,i,s){void 0===i&&(i=!1);var a=new rxjs_1.Subject;return this.modalservice.openModal("MediaFileUploader").subscribe(function(e){e.instance.acceptFileTypes=t,e.instance.noMetaData=i,e.instance.category=s,e.instance.answer.subscribe(function(e){a.next(e),a.complete()})}),a.asObservable()},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[platform_browser_1.DomSanitizer,http_1.HttpClient,backend,configurationService,session,metadata,footer,toast,language,modal])],e)}();exports.mediafiles=mediafiles;var modelattachments=function(){function e(e,t,i,s,a,r){this.backend=e,this.configurationService=t,this.session=i,this.toast=s,this.broadcast=a,this.language=r,this.module="",this.id="",this.count=0,this.files=[],this.loading=!1,this.loaded$=new core_1.EventEmitter}return e.prototype.getCount=function(){var t=this,i=new rxjs_1.Subject;return this.backend.getRequest("module/"+this.module+"/"+this.id+"/attachment/count").subscribe(function(e){t.count=e.count,i.next(t.count),i.complete()},function(e){i.complete()}),i.asObservable()},e.prototype.broadcastAttachmentCount=function(){this.broadcast.broadcastMessage("attachments.loaded",{module:this.module,id:this.id,attachmentcount:this.count})},e.prototype.getAttachments=function(){var i=this,s=new rxjs_1.Subject;return this.files=[],this.loading=!0,this.backend.getRequest("module/"+this.module+"/"+this.id+"/attachment/ui").subscribe(function(e){for(var t in e)e[t].date=new moment(e[t].date),i.files.push(e[t]);i.count=i.files.length,i.broadcastAttachmentCount(),i.loading=!1,s.next(i.files),s.complete(),i.loaded$.emit(!0)},function(e){i.loading=!1,s.error(e),s.complete()}),s.asObservable()},e.prototype.humanFileSize=function(e){var t=e;if(Math.abs(e)<1024)return t+" B";for(var i=["kB","MB","GB","TB","PB","EB","ZB","YB"],s=-1;t/=1024,++s,1024<=Math.abs(t)&&s<i.length-1;);return t.toFixed(1)+" "+i[s]},e.prototype.uploadAttachmentsBase64=function(e){var r=this;if(0!==e.length){for(var o=new rxjs_1.Subject,t=this.configurationService.getSystemParamater("upload_maxsize"),i=function(s){if(t&&s.size>t)return n.toast.sendToast(n.language.getLabelFormatted("LBL_EXCEEDS_MAX_UPLOADFILESIZE",[s.name,n.humanFileSize(t)]),"error"),"continue";var a={date:new moment,file:"",file_mime_type:s.type?s.type:"application/octet-stream",filesize:s.size,filename:s.name,id:"",text:"",thumbnail:"",user_id:"1",user_name:"admin",uploadprogress:0};n.files.unshift(a),n.count++,n.broadcastAttachmentCount(),n.readFile(s).subscribe(function(e){var i=new XMLHttpRequest;i.onreadystatechange=function(e){if(void 0===e&&(e=r),4==i.readyState)try{var t=JSON.parse(i.response);a.id=t[0].id,a.thumbnail=t[0].thumbnail,a.user_id=t[0].user_id,a.user_name=t[0].user_name,delete a.uploadprogress,o.next({files:t}),o.complete()}catch(e){({status:"error",data:"Unknown error occurred: ["+i.responseText+"]"})}},i.upload.addEventListener("progress",function(e){a.uploadprogress=Math.round(e.loaded/e.total*100),o.next({progress:{total:e.total,loaded:e.loaded}})},!1),i.open("POST",r.configurationService.getBackendUrl()+"/module/"+r.module+"/"+r.id+"/attachment",!0),i.setRequestHeader("OAuth-Token",r.session.authData.sessionId),i.setRequestHeader("Content-Type","application/json;charset=UTF-8");var t={file:s.filecontent,filename:s.name,filemimetype:s.type?s.type:"application/octet-stream"};i.send(JSON.stringify(t))})},n=this,s=0,a=e;s<a.length;s++){i(a[s])}return o.asObservable()}},e.prototype.uploadFileBase64=function(e,t,i){var s=this,a=new rxjs_1.Subject,r=this.configurationService.getSystemParamater("upload_maxsize");if(!(r&&atob(e).length>r)){var o={date:new moment,file:"",file_mime_type:i||"application/octet-stream",filesize:atob(e).length,filename:t,id:"",text:"",thumbnail:"",user_id:"1",user_name:"admin",uploadprogress:0};this.files.unshift(o),this.count++,this.broadcastAttachmentCount();var n=new XMLHttpRequest;n.onreadystatechange=function(e){if(void 0===e&&(e=s),4==n.readyState)try{var t=JSON.parse(n.response);o.id=t[0].id,o.thumbnail=t[0].thumbnail,o.user_id=t[0].user_id,o.user_name=t[0].user_name,delete o.uploadprogress,a.next({files:t}),a.complete()}catch(e){({status:"error",data:"Unknown error occurred: ["+n.responseText+"]"})}},n.upload.addEventListener("progress",function(e){o.uploadprogress=Math.round(e.loaded/e.total*100),a.next({progress:{total:e.total,loaded:e.loaded}})},!1),n.open("POST",this.configurationService.getBackendUrl()+"/module/"+this.module+"/"+this.id+"/attachment",!0),n.setRequestHeader("OAuth-Token",this.session.authData.sessionId),n.setRequestHeader("Content-Type","application/json;charset=UTF-8");var u={file:e,filename:t,filemimetype:i||"application/octet-stream"};return n.send(JSON.stringify(u)),a.asObservable()}this.toast.sendToast(this.language.getLabelFormatted("LBL_EXCEEDS_MAX_UPLOADFILESIZE",[t,this.humanFileSize(r)]),"error")},e.prototype.readFile=function(e){var s=new rxjs_1.Subject,a=new FileReader;return a.file=e,a.onloadend=function(e){var t=a.result.toString();t=t.substring(t.indexOf("base64,")+7);var i=a.file;i.filecontent=t,s.next(i),s.complete()},a.readAsDataURL(e),s.asObservable()},e.prototype.deleteAttachment=function(i){var s=this;this.backend.deleteRequest("module/"+this.module+"/"+this.id+"/attachment/"+i).subscribe(function(e){s.files.some(function(e,t){if(e.id==i)return s.files.splice(t,1),s.count--,s.broadcastAttachmentCount(),!0})})},e.prototype.downloadAttachment=function(e,t){var a=this;this.backend.getRequest("/module/"+this.module+"/"+this.id+"/attachment/"+e).subscribe(function(e){var t=a.b64toBlob(e.file,e.file_mime_type),i=URL.createObjectURL(t),s=document.createElement("a");document.body.appendChild(s),s.href=i,s.download=e.filename,s.type=e.file_mime_type,s.click(),s.remove()})},e.prototype.getAttachment=function(e){var t=new rxjs_1.Subject;return this.backend.getRequest("/module/"+this.module+"/"+this.id+"/attachment/"+e).subscribe(function(e){t.next(e.file),t.complete()}),t.asObservable()},e.prototype.b64toBlob=function(e,t,i){void 0===t&&(t=""),void 0===i&&(i=512);for(var s=atob(e),a=[],r=0;r<s.length;r+=i){for(var o=s.slice(r,r+i),n=new Array(o.length),u=0;u<o.length;u++)n[u]=o.charCodeAt(u);var l=new Uint8Array(n);a.push(l)}return new Blob(a,{type:t})},e.prototype.openAttachment=function(e,t){var s=this;this.backend.getRequest("/module/"+this.module+"/"+this.id+"/attachment/"+e).subscribe(function(e){var t=s.b64toBlob(e.file,e.file_mime_type),i=URL.createObjectURL(t);window.open(i,"_blank")})},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[backend,configurationService,session,toast,broadcast,language])],e)}();exports.modelattachments=modelattachments;var modellist=function(){function e(e,t,i,s,a,r,o,n){var u=this;this.broadcast=e,this.backend=t,this.metadata=i,this.language=s,this.userpreferences=a,this.session=r,this.configuration=o,this.toast=n,this._module="",this.listDataChanged$=new core_1.EventEmitter,this.listData={list:[],totalcount:0,source:void 0,listcomponent:void 0},this.listSelected={type:"",items:[]},this.selectionChanged$=new core_1.EventEmitter,this.lastFields=[],this.sortArray=[],this.lastLoad=new moment,this.loadlimit=50,this.isLoading=!1,this.searchTerm="",this.moduleAggregates=[],this.selectedAggregates=[],this.buckets={},this.usecache=!0,this.standardLists=[{id:"all",type:"all",name:"<LBL_ALL> <module>",config:{showSearch:!0,enableFilter:!1,enableAggregates:!0,enableDelete:!1}},{id:"owner",type:"owner",name:"<LBL_MY> <module>",config:{showSearch:!0,enableFilter:!1,enableAggregates:!0,enableDelete:!1}}],this.listTypes=[],this.currentList={},this._listcomponent="ObjectList",this.serviceSubscriptions=[],this.displayAggregates=!1,this.displayFilters=!1,this._listfields=[],this.listfield$=new core_1.EventEmitter,this.listtype$=new rxjs_1.BehaviorSubject("all"),this.listcomponent$=new rxjs_1.BehaviorSubject(this._listcomponent),this.serviceSubscriptions.push(this.broadcast.message$.subscribe(function(e){u.handleMessage(e)}))}return Object.defineProperty(e.prototype,"module",{get:function(){return this._module},set:function(e){this.setModule(e)},enumerable:!0,configurable:!0}),e.prototype.setModule=function(e,t){if(void 0===t&&(t=!1),!this._module||this._module!=e){if(this._module=e,this.resetListData(),t)return;if(this.loadListTypes(),this.getFromSession())this.reLoadList(!0);else{var i=this.userpreferences.getPreference(e);i&&i.lastlisttype&&this.listtypeexists(i.lastlisttype)?this.setListType(i.lastlisttype,!1):this.setListType("all",!1)}this.moduleAggregates=[];for(var s=0,a=this.metadata.getModuleAggregates(e);s<a.length;s++){var r=a[s];this.moduleAggregates.push(__assign({},r))}this.moduleAggregates.sort(function(e,t){return e.priority||t.priority?!e.priority||e.priority>t.priority?1:-1:0})}},Object.defineProperty(e.prototype,"listtype",{get:function(){return this.currentList.id},enumerable:!0,configurable:!0}),e.prototype.handleMessage=function(t){var i=this;if(t.messagedata.module===this.module)switch(t.messagetype){case"model.delete":var e=this.listData.list.findIndex(function(e){return e.id==t.messagedata.id});if(0<=e&&(this.listData.list.splice(e,1),this.listData.totalcount--,this.bucketfield)){for(var s=[],a=0,r=this.bucketamountfield;a<r.length;a++){var o=r[a];s.push({fieldname:o.name,value:t.messagedata.data[o.name]})}this.removeItemFromBucket(t.messagedata.data[this.bucketfield],s)}this.listDataChanged$.next(!0);break;case"model.save":var n=this.listData.list.findIndex(function(e){return e.id==t.messagedata.id});if(0<=n){if(this.listData.list[n]=t.messagedata.data,this.bucketfield)if(t.messagedata.changed[this.bucketfield]){s=[];for(var u=0,l=this.bucketamountfield;u<l.length;u++){o=l[u];s.push({fieldname:o.name,valuefrom:t.messagedata.backupdata[o.name],valueto:t.messagedata.data[o.name]})}this.updateBuckets(t.messagedata.backupdata[this.bucketfield],t.messagedata.data[this.bucketfield],s)}else if(this.bucketamountfield)for(var c=this.buckets.bucketitems.find(function(e){return e.bucket==t.messagedata.data[i.bucketfield]}),d=0,h=this.bucketamountfield;d<h.length;d++){o=h[d];t.messagedata.changed[o.name]&&(c.values["_bucket_agg_"+o.name]+=t.messagedata.data[o.name]-t.messagedata.backupdata[o.name])}this.listDataChanged$.next(!0)}else this.reLoadList()}},e.prototype.ngOnDestroy=function(){for(var e=0,t=this.serviceSubscriptions;e<t.length;e++){t[e].unsubscribe()}},e.prototype.loadListTypes=function(){this.listTypes=[];for(var e=0,t=this.metadata.getModuleListTypes(this.module);e<t.length;e++){var i=t[e];this.listTypes.push(i)}},Object.defineProperty(e.prototype,"listcomponent",{get:function(){return this._listcomponent?this._listcomponent:"ObjectList"},set:function(e){this._listcomponent=e,this.listcomponent$.next(e),"all"!=this.currentList.id&&"owner"!=this.currentList.id||this.userpreferences.setPreference("defaultlisttype",e,!1,"SpiceUI_"+this.module),this.currentList.fielddefs=void 0,this.determineListFields()},enumerable:!0,configurable:!0}),e.prototype.setSortField=function(t,e,i){var s=this;if(void 0===i&&(i=!0),t&&!this.isLoading){var a=this.sortArray.findIndex(function(e){return e.sortfield==t});if(0<=a){var r=this.sortArray[a];"ASC"==r.sortdirection?r.sortdirection="DESC":this.sortArray.splice(a,1)}else this.sortArray.push({sortfield:t,sortdirection:e||"ASC"});i&&(this.reloadTimeOut&&window.clearTimeout(this.reloadTimeOut),this.reloadTimeOut=window.setTimeout(function(){return s.reLoadList()},500))}},e.prototype.getSortField=function(t){var e=this.sortArray.findIndex(function(e){return e.sortfield==t});return 0<=e&&{sortdirection:this.sortArray[e].sortdirection,sortindex:e,sortitems:this.sortArray.length}},e.prototype.getSortFields=function(){for(var e=[],t=0,i=this.sortArray;t<i.length;t++){var s=i[t];e.push(this.language.getFieldDisplayName(this.module,s.sortfield))}return e.join(", ")},Object.defineProperty(e.prototype,"isSorted",{get:function(){return 0<this.sortArray.length},enumerable:!0,configurable:!0}),e.prototype.addCustomListtype=function(e,t,i,s,a){this.listTypes.push({id:e,name:t,global:a,fielddefs:i,filterdefs:s})},e.prototype.listtypeexists=function(t){return!!this.getListTypes().find(function(e){return e.id==t})},e.prototype.setListType=function(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=[]),this.displayAggregates=!1,this.displayFilters=!1;for(var s=0,a=this.getListTypes();s<a.length;s++){var r=a[s];r.id===e&&(this.currentList=r)}if(this.determineListFields(),t){var o=this.userpreferences.getPreference(this.module);(o=o||{}).lastlisttype=e,this.userpreferences.setPreference(this.module,o)}if(this.currentList.aggregates?this.selectedAggregates=JSON.parse(atob(this.currentList.aggregates)):this.selectedAggregates=[],this.currentList.sortfields?this.sortArray=JSON.parse(atob(this.currentList.sortfields)):this.sortArray=i,this.currentList.listcomponent)this.listcomponent=this.currentList.listcomponent;else{var n=this.userpreferences.getPreference("defaultlisttype",this.module);n&&(this.listcomponent=n)}this.listtype$.next(e),this.getListData()},e.prototype.determineListFields=function(){this._listfields=[];for(var s=this.getFieldDefs(),e=this.metadata.getComponentConfig(this.listcomponent,this.module),t=this.metadata.getFieldSetFields(e.fieldset),i=function(t){var e=s?s.find(function(e){return e.id==t.id}):void 0;s&&e?a._listfields.push({id:t.id,field:t.field,fieldconfig:t.fieldconfig,sort:e.sort,width:e.width}):s||!1===t.fieldconfig.default||a._listfields.push({id:t.id,field:t.field,fieldconfig:t.fieldconfig})},a=this,r=0,o=t;r<o.length;r++){i(o[r])}s&&this._listfields.sort(function(t,i){return s.findIndex(function(e){return e.id==t.id})>s.findIndex(function(e){return e.id==i.id})?1:-1})},Object.defineProperty(e.prototype,"listfields",{get:function(){return this._listfields},set:function(e){var i=this;this._listfields=e;function t(t){s._listfields.find(function(e){return e.field==i.sortArray[t].sortfield})||s.sortArray.splice(parseInt(t,10),1)}var s=this;for(var a in this.sortArray)t(a);this.listfield$.emit(this._listfields)},enumerable:!0,configurable:!0}),e.prototype.canDelete=function(){try{return"all"!=this.currentList&&"owner"!=this.currentList}catch(e){return!1}},e.prototype.filterEnabled=function(){try{return"all"!=this.currentList.id&&"owner"!=this.currentList.id}catch(e){return!1}},e.prototype.aggregatesEnabled=function(){try{return!!this.searchAggregates}catch(e){return!1}},e.prototype.setToSession=function(){if(!this.usecache)return!1;this.configuration.setData("lastlist_"+this.module,{module:this.module,listtype:this.listtype,listcomponent:this.listcomponent,listdata:this.listData,sortarray:this.sortArray,searchterm:this.searchTerm,searchaggregates:this.searchAggregates,selectedaggregates:this.selectedAggregates,buckets:this.buckets})},e.prototype.getFromSession=function(){var e=this.configuration.getData("lastlist_"+this.module);if(e){this._module=e.module,this.loadListTypes();for(var t=0,i=this.getListTypes();t<i.length;t++){var s=i[t];s.id===e.listtype&&(this.currentList=s)}return this.listcomponent=e.listcomponent,this.listData=e.listdata,this.searchTerm=e.searchterm,this.searchAggregates=e.searchaggregates,this.selectedAggregates=e.selectedaggregates,this.sortArray=e.sortarray,this.buckets=e.buckets,this.determineListFields(),!0}return!1},e.prototype.getListTypeName=function(t){var i=this;void 0===t&&(t="");try{return this.getListTypes().find(function(e){return e.id==(t||i.currentList.id)}).name}catch(e){return t||this.currentList.id}},e.prototype.getGlobal=function(){return"1"==this.currentList.global},e.prototype.getFieldDefs=function(){try{return JSON.parse(atob(this.currentList.fielddefs))}catch(e){return}},e.prototype.getFilterDefs=function(){try{return JSON.parse(this.currentList.filterdefs)}catch(e){return{logicaloperator:"and",groupscope:"all",conditions:[]}}},e.prototype.addListType=function(e,t){var i=this,s=new rxjs_1.Subject,a={list:e,global:t};return this.backend.postRequest("spiceui/core/modules/"+this.module+"/listtypes",{},JSON.stringify(a)).subscribe(function(e){i.addCustomListtype(e.id,e.name,null,null,e.global),i.metadata.addModuleListType(i.module,{id:e.id,name:e.name,fielddefs:null}),i.setListType(e.id),s.next(!0),s.complete()}),s.asObservable()},e.prototype.updateListType=function(i,t){var s=this;void 0===t&&(t=!1);var a=new rxjs_1.Subject;(i=i||{}).aggregates=btoa(JSON.stringify(this.selectedAggregates)),i.listcomponent=this.listcomponent,i.sortfields=btoa(JSON.stringify(this.sortArray));for(var e=[],r=0,o=this.listfields;r<o.length;r++){var n=o[r];e.push({id:n.id,width:n.width})}return i.fielddefs=btoa(JSON.stringify(e)),this.backend.postRequest("spiceui/core/modules/"+this.module+"/listtypes/"+this.currentList.id,{},i).subscribe(function(e){s.listTypes.some(function(e){if(e.id==s.currentList.id){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t]);return s.currentList=e,!0}}),i.id=s.currentList.id,s.metadata.updateModuleListType(s.module,i),t&&s.reLoadList(),a.next(!0),a.complete()}),a.asObservable()},e.prototype.deleteListType=function(t){var i=this;void 0===t&&(t=""),""===t&&(t=this.currentList.id),this.backend.deleteRequest("spiceui/core/modules/"+this.module+"/listtypes/"+t).subscribe(function(e){i.setListType("all"),i.listTypes=i.metadata.deleteModuleListType(i.module,t)},function(e){i.toast.sendToast(i.language.getLabel("LBL_ERROR"),"error")})},e.prototype.getLastLoadTime=function(){return this.lastLoad.format(this.userpreferences.getTimeFormat())},e.prototype.getListData=function(e){return this.resetListData(),e?this.lastFields=e:e=this.lastFields,this.loadList(e)},e.prototype.showSearch=function(e){e=e||this.listtype;for(var t=0,i=this.getListTypes();t<i.length;t++){var s=i[t];if(s.id===e)return s.config.showSearch}return!1},e.prototype.reLoadList=function(e){return void 0===e&&(e=!1),this.loadList(this.lastFields,e)},e.prototype.resetListData=function(){if(this.buckets&&this.buckets.bucketitems)for(var e=0,t=this.buckets.bucketitems;e<t.length;e++){var i=t[e];i.count=0,i.items=0}this.listData={list:[],totalcount:0}},e.prototype.getListTypes=function(e){void 0===e&&(e=!0);var t=[];if(e)for(var i=0,s=this.standardLists;i<s.length;i++){var a=s[i];t.push({id:a.id,type:a.type,global:1,name:a.name.replace("<module>",this.language.getModuleName(this.module)).replace("<LBL_MY>",this.language.getLabel("LBL_MY")).replace("<LBL_ALL>",this.language.getLabel("LBL_ALL")),config:a.config})}for(var r=0,o=this.listTypes;r<o.length;r++){a=o[r];t.push(a)}return t},Object.defineProperty(e.prototype,"hasAggregates",{get:function(){return 0<this.selectedAggregates.length},enumerable:!0,configurable:!0}),e.prototype.setAggregate=function(e,t){this.selectedAggregates.push(e+"::"+t),this.reLoadList()},e.prototype.getCheckedAggregateCount=function(t){return this.selectedAggregates.filter(function(e){return-1<e.indexOf(t+"::")}).length},e.prototype.checkAggregate=function(e,t){return-1<this.selectedAggregates.indexOf(e+"::"+t.trim())},e.prototype.removeAggregate=function(e,t){var i=this.selectedAggregates.indexOf(e+"::"+t);0<=i&&(this.selectedAggregates.splice(i,1),this.reLoadList())},e.prototype.removeAllAggregates=function(){this.selectedAggregates=[],this.reLoadList()},e.prototype.setAllSelected=function(){this.listSelected.type="all";for(var e=0,t=this.listData.list;e<t.length;e++){t[e].selected=!0}this.selectionChanged$.emit(!0)},e.prototype.setAllUnselected=function(){this.listSelected.type="none";for(var e=0,t=this.listData.list;e<t.length;e++){t[e].selected=!1}this.selectionChanged$.emit(!0)},e.prototype.getSelectedCount=function(){for(var e=0,t=0,i=this.listData.list;t<i.length;t++){i[t].selected&&e++}return e},e.prototype.getSelectedIDs=function(){for(var e=[],t=0,i=this.listData.list;t<i.length;t++){var s=i[t];s.selected&&e.push(s.id)}return e},e.prototype.getSelectedItems=function(){for(var e=[],t=0,i=this.listData.list;t<i.length;t++){var s=i[t];s.selected&&e.push(s)}return e},e.prototype.checkAccess=function(e){if(!("edit"!=e&&"delete"!=e||"all"!=this.currentList.id&&"owner"!=this.currentList.id))return!1;if(!this.getGlobal())return!0;switch(e){case"delete":return this.canDelete()&&this.session.authData.admin;case"edit":return this.session.authData.admin;default:return!1}},e.prototype.loadList=function(e,t){var i,s=this;void 0===t&&(t=!1);var a=new rxjs_1.Subject;if(t){if(this.buckets&&this.buckets.bucketitems)for(var r=0,o=this.buckets.bucketitems;r<o.length;r++){o[r].items=0}}else this.resetListData(),this.isLoading=!0;var n={};return n[this.module]=this.selectedAggregates,this.backend.getList(this.module,this.sortArray,e,{start:0,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:n,buckets:this.buckets,relatefilter:(null===(i=this.relatefilter)||void 0===i?void 0:i.active)?this.relatefilter:null}).subscribe(function(e){s.listData=e,s.listData.listcomponent=s.listcomponent,s.lastLoad=new moment,s.isLoading=!1,s.searchAggregates=e.aggregations,s.buckets=e.buckets,s.setToSession(),a.next(!0),a.complete(),s.listDataChanged$.next(!0)}),a.asObservable()},e.prototype.loadMoreList=function(){var e,t=this;if(this.isLoading||this.listData.list.length>=this.listData.totalcount)return!1;this.isLoading=!0;var i={};i[this.module]=this.selectedAggregates,this.backend.getList(this.module,this.sortArray,this.lastFields,{modulefilter:this.modulefilter,start:this.listData.list.length,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:i,buckets:this.buckets,relatefilter:(null===(e=this.relatefilter)||void 0===e?void 0:e.active)?this.relatefilter:null}).subscribe(function(e){t.listData.list=t.listData.list.concat(e.list),t.listDataChanged$.next(!0),t.lastLoad=new moment,t.isLoading=!1,t.setToSession()})},e.prototype.loadMoreBucketList=function(t){var e,i=this,s=this.buckets.bucketitems.find(function(e){return e.bucket==t});if(!s||this.isLoading||s.items>=s.items.total)return!1;this.isLoading=!0;var a={};a[this.module]=this.selectedAggregates,this.backend.getList(this.module,this.sortArray,this.lastFields,{modulefilter:this.modulefilter,start:this.listData.list.length,limit:this.loadlimit,listid:this.currentList.id,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:a,buckets:{bucketfield:this.buckets.bucketfield,bucketitems:[s]},relatefilter:(null===(e=this.relatefilter)||void 0===e?void 0:e.active)?this.relatefilter:null}).subscribe(function(e){i.listData.list=i.listData.list.concat(e.list),i.lastLoad=new moment,i.listDataChanged$.next(!0),i.isLoading=!1,i.setToSession()})},e.prototype.exportList=function(e){var t=new rxjs_1.Subject,i=this.getSelectedIDs();if(0<i.length)this.backend.getLinkToDownload("/module/"+this.module+"/export","POST",{},{ids:i,fields:e||this.lastFields},{}).subscribe(function(e){t.next(e),t.complete()});else{var s={};s[this.module]=this.selectedAggregates,this.backend.getLinkToDownload("/module/"+this.module+"/export","POST",{},{listid:this.currentList.id,modulefilter:this.modulefilter,sortfields:this.sortArray,fields:e||this.lastFields,searchterm:this.searchTerm,searchgeo:this.searchGeo,aggregates:s}).subscribe(function(e){t.next(e),t.complete()})}return t.asObservable()},Object.defineProperty(e.prototype,"bucketfield",{get:function(){return this.buckets?this.buckets.bucketfield:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bucketamountfield",{get:function(){return this.buckets?this.buckets.buckettotal:""},enumerable:!0,configurable:!0}),e.prototype.updateBuckets=function(t,i,e){void 0===e&&(e=[]);var s=this.buckets.bucketitems.find(function(e){return e.bucket==t});s.items--,s.total--;var a=this.buckets.bucketitems.find(function(e){return e.bucket==i});a.items++,a.total++;for(var r=0,o=this.buckets.buckettotal;r<o.length;r++)for(var n=o[r],u=0,l=e;u<l.length;u++){var c=l[u];"sum"==n.function&&n.name==c.fieldname&&(s.values["_bucket_agg_"+c.fieldname]-=c.valuefrom,a.values["_bucket_agg_"+c.fieldname]+=c.valueto)}},e.prototype.removeItemFromBucket=function(t,e){void 0===e&&(e=[]);var i=this.buckets.bucketitems.find(function(e){return e.bucket==t});i.items--,i.total--;for(var s=0,a=e;s<a.length;s++){var r=a[s];i.values["_bucket_agg_"+r.fieldname]-=r.value}},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[broadcast,backend,metadata,language,userpreferences,session,configurationService,toast])],e)}();exports.modellist=modellist;var popup=function(){function e(){this.closePopup$=new core_1.EventEmitter}return e.prototype.close=function(){this.closePopup$.emit(!0)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.popup=popup;var view=function(){function e(e,t){var i=this;this.model=e,this.layout=t,this.mode="view",this.isEditable=!1,this.displayLinks=!0,this.displayLabels=!0,this.editfieldid="",this.editfieldname="",this.labels="default",this._size="regular",this.linkedToModel=!1,this.mode$=new rxjs_1.BehaviorSubject(this.mode),this.model&&this.model.mode$.subscribe(function(e){i.linkedToModel&&"display"==e&&i.setViewMode()})}return Object.defineProperty(e.prototype,"size",{get:function(){return"small"==this.layout.screenwidth?"small":this._size},set:function(e){this._size=e},enumerable:!0,configurable:!0}),e.prototype.getMode=function(){return this.mode},e.prototype.isEditMode=function(){return"edit"===this.mode},e.prototype.setEditMode=function(e){void 0===e&&(e=""),this.mode="edit",this.editfieldid=e,this.mode$.next(this.mode)},e.prototype.setViewMode=function(){this.mode="view",this.mode$.next(this.mode)},e=__decorate([core_1.Injectable(),__param(0,core_1.Optional()),__metadata("design:paramtypes",[model,layout])],e)}();exports.view=view;var relatedmodels=function(){function e(e,t,i,s,a,r){var o=this;this.metadata=e,this.backend=t,this.broadcast=i,this.modelutilities=s,this.toast=a,this.language=r,this.module="",this.id="",this.relatedModule="",this.linkName="",this.modulefilter="",this.fieldfilters={},this.items=[],this.count=0,this.loaditems=5,this.relationshipFields=[],this.isloading=!1,this.isonlyfiltered=!1,this.sort={sortfield:"",sortdirection:"ASC"},this.lastLoad=new moment,this.sequencefield=null,this.serviceSubscriptions=[],this.serviceSubscriptions.push(this.broadcast.message$.subscribe(function(e){o.handleMessage(e)}))}return e.prototype.ngOnDestroy=function(){this.stopSubscriptions()},e.prototype.stopSubscriptions=function(){for(var e=0,t=this.serviceSubscriptions;e<t.length;e++){t[e].unsubscribe()}this.serviceSubscriptions=[]},Object.defineProperty(e.prototype,"sortfield",{get:function(){return this.sort.sortfield},set:function(e){this.sort.sortfield==e?this.sort.sortdirection="ASC"==this.sort.sortdirection?"DESC":"ASC":(this.sort.sortfield=e,this.sort.sortdirection="ASC"),this.getData()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_linkName",{get:function(){return""!=this.linkName?this.linkName:this.relatedModule.toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sortBySequencefield",{get:function(){return!(!this.sequencefield||this.modulefilter||this.sort.sortfield)},enumerable:!0,configurable:!0}),e.prototype.handleMessage=function(i){var s=this;if(-1!==i.messagetype.indexOf("model")&&i.messagedata.module===this.relatedModule)switch(i.messagetype){case"model.delete":this.items.some(function(e,t){if(e.id===i.messagedata.id)return s.items.splice(t,1),s.count--,!0});break;case"model.save":for(var e=!1,t=0,a=this.items;t<a.length;t++){var r=a[t];if(r.id===i.messagedata.id){for(var o in r)r.hasOwnProperty(o)&&i.messagedata.data.hasOwnProperty(o)&&(r[o]=i.messagedata.data[o]);e=!0,this.sortItems()}}!e||this.modulefilter?this.getData(!0):this.sortItems()}},e.prototype.getLastLoadTime=function(){return this.lastLoad.format("HH:mm")},e.prototype.getData=function(e){var i=this;void 0===e&&(e=!1);var s=new rxjs_1.Subject;if(!1===this.metadata.checkModuleAcl(this.relatedModule,"list"))return rxjs_1.of(!1);e||(this.resetData(),this.isloading=!0);var t={module:this.relatedModule,getcount:!0,offset:0,limit:this.loaditems,modulefilter:this.modulefilter,fieldfilters:this.fieldfilters,relationshipFields:JSON.stringify(this.relationshipFields),sort:this.sort.sortfield?JSON.stringify(this.sort):""},a="";return a=this.isonlyfiltered?"module/"+this.module+"/"+this.id+"/filtered":"module/"+this.module+"/"+this.id+"/related/"+this._linkName,this.backend.getRequest(a,t).subscribe(function(e){for(var t in i.items=[],i.count=parseInt(e.count,10),e.list)e.list.hasOwnProperty(t)&&(e.list[t].relid=t,e.list[t]=i.modelutilities.backendModel2spice(i.relatedModule,e.list[t]),i.items.push(e.list[t]));i.isloading=!1,i.sortItems(),i.lastLoad=new moment,s.next(!0),s.complete()}),s.asObservable()},Object.defineProperty(e.prototype,"canloadmore",{get:function(){return!this.isloading&&this.count&&0<this.count-this.items.length},enumerable:!0,configurable:!0}),e.prototype.getMoreData=function(e){var i=this;if(void 0===e&&(e=5),!1===this.metadata.checkModuleAcl(this.relatedModule,"list"))return rxjs_1.of(!0);this.isloading=!0;var t={module:this.relatedModule,getcount:!0,offset:this.items.length,limit:this.items.length+e,modulefilter:this.modulefilter,relationshipFields:JSON.stringify(this.relationshipFields),sort:this.sort.sortfield?JSON.stringify(this.sort):""},s=new rxjs_1.Subject,a="";return a=this.isonlyfiltered?"module/"+this.module+"/"+this.id+"/filtered":"module/"+this.module+"/"+this.id+"/related/"+this._linkName,this.backend.getRequest(a,t).subscribe(function(e){for(var t in i.count=parseInt(e.count,10),e.list)e.list.hasOwnProperty(t)&&(e.list[t].relid=t,e.list[t]=i.modelutilities.backendModel2spice(i.relatedModule,e.list[t]),i.items.push(e.list[t]));i.sortItems(),i.lastLoad=new moment,i.isloading=!1,s.next(!0),s.complete()}),s.asObservable()},e.prototype.sortItems=function(){var s,a;this.sort.sortfield?(s=this.sort.sortfield,a=this.sort.sortdirection):this.sortBySequencefield&&(s=this.sequencefield,a="ASC"),s&&this.items.sort(function(e,t){var i=0;return i=isNaN(parseInt(e[s],10))||isNaN(parseInt(t[s],10))?e[s]>t[s]?1:-1:parseInt(e[s],10)>parseInt(t[s],10)?1:-1,"ASC"==a?i:-1*i})},e.prototype.resetData=function(){this.items=[]},e.prototype.addItems=function(a){var r=this;if(this.isonlyfiltered)this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_ADD"),"error");else{for(var e=[],t=0,i=a;t<i.length;t++){var s=i[t];e.push(s.id)}this.backend.postRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,[],e).subscribe(function(e){for(var t=function(t){var i=!1;r.items.some(function(e){if(e.id==t.id)return i=!0}),i||(r.items.push(t),r.count++)},i=0,s=a;i<s.length;i++){t(s[i])}})}},e.prototype.setItem=function(e){if(this.isonlyfiltered)return this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_SET"),"error"),rxjs_1.of(!0);var t=new rxjs_1.Subject;return this.backend.putRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,[],this.modelutilities.spiceModel2backend(this.relatedModule,e)).subscribe(function(e){t.next(!0),t.complete()},function(e){t.error(e),t.complete()}),t.asObservable()},e.prototype.deleteItem=function(i){var s=this;if(this.isonlyfiltered)this.toast.sendToast(this.language.getLabel("LBL_NOT_POSSIBLE_TO_SET"),"error");else{var e=[];e.push(i);var t={relatedids:e};this.backend.deleteRequest("module/"+this.module+"/"+this.id+"/related/"+this._linkName,t).subscribe(function(e){s.items.some(function(e,t){if(e.id==i)return s.items.splice(t,1),s.count--,!0})})}},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,backend,broadcast,modelutilities,toast,language])],e)}();exports.relatedmodels=relatedmodels;var activitiytimeline=function(){function e(e,t,i,s,a,r){var o=this;this.metadata=e,this.backend=t,this.modelutilities=i,this.configurationService=s,this.session=a,this.broadcast=r,this.serviceSubscriptions=[],this.filters={searchterm:"",objectfilters:[],own:""},this.loading$=new core_1.EventEmitter,this.defaultLimit=5,this.modules=["Activities","History"],this.timelineModules=["Calls","Meetings","Tasks","Emails","Notes"],this.activeStates=["Planned","In Progress","Not Started","Pending Input"],this.activityObjects=["Tasks","Meetings","Calls","Notes","Emails"],this.sortDates={Calls:"date_start",Meetings:"date_start",Tasks:"date_due",Emails:"date_entered",Notes:"date_entered"},this.activities={Activities:{loading:!1,loadingmore:!1,list:[],totalcount:0,aggregates:[]},History:{loading:!1,loadingmore:!1,list:[],totalcount:0,aggregates:[]}},this.usefts=!1,this._openness=!1,this.serviceSubscriptions.push(this.broadcast.message$.subscribe(function(e){return o.handleMessage(e)})),this.openness$=new rxjs_1.BehaviorSubject(this._openness)}return Object.defineProperty(e.prototype,"openness",{get:function(){return this._openness},set:function(e){this._openness=e,this.openness$.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterObjects",{get:function(){if(this.usefts){var e=[];for(var t in this.activities)e=e.concat(this.getAggregateObjects(t));return _.uniq(e)}return this.activityObjects},enumerable:!0,configurable:!0}),e.prototype.getAggregateObjects=function(e){try{for(var t=[],i=0,s=this.activities[e].aggregates.module;i<s.length;i++){var a=s[i];t.push(a.module)}return t}catch(e){return[]}},e.prototype.stopSubscriptions=function(){for(var e=0,t=this.serviceSubscriptions;e<t.length;e++){t[e].unsubscribe()}},e.prototype.handleMessage=function(s){var a=this,e=s.messagetype.split(".");if("model"===e[0])switch(e[1]){case"save":if(this.usefts)this.metadata.getModuleDefs(s.messagedata.module).ftsactivities.Activities&&this.getTimeLineData("Activities",!0),this.metadata.getModuleDefs(s.messagedata.module).ftsactivities.History&&this.getTimeLineData("History",!0);else{var i="History";if(s.messagedata.data.status&&0<=this.activeStates.indexOf(s.messagedata.data.status)?i="Activities":this.activities.Activities.list.some(function(e,t){if(e.id==s.messagedata.id)return a.activities.Activities.list.splice(t,1),!0}),(s.messagedata.data.parent_id===this.parent.id||s.messagedata.data.contact_id===this.parent.id)&&0<=this.timelineModules.indexOf(s.messagedata.module)){var r=!1;this.activities[i].list.some(function(e,t){if(e.id==s.messagedata.id)return r=!0,a.activities[i].list[t].data=s.messagedata.data,!0}),r||(this.activities[i].list.push({module:s.messagedata.module,id:s.messagedata.id,data:s.messagedata.data}),this.activities[i].totalcount++),this.sortListdata(i)}}break;case"delete":var o=!1;if(0<=this.timelineModules.indexOf(s.messagedata.module))for(var t=function(i){if(n.activities[i].list.some(function(e,t){if(e.module,s.messagedata.module,e.id===s.messagedata.id)return a.activities[i].list.splice(t,1),a.getTimeLineData(i,!0),o=!0}),o)return{value:void 0}},n=this,u=0,l=this.modules;u<l.length;u++){var c=t(l[u]);if("object"==typeof c)return c.value}}},e.prototype.checkModuleActive=function(e){return 0==this.filters.objectfilters.length||0<=this.filters.objectfilters.indexOf(e)},e.prototype.toggleModuleFilter=function(e){0==this.filters.objectfilters.length?(this.filters.objectfilters=this.filterObjects,this.filters.objectfilters.splice(this.filters.objectfilters.indexOf(e),1)):0<=this.filters.objectfilters.indexOf(e)?this.filters.objectfilters.splice(this.filters.objectfilters.indexOf(e),1):(this.filters.objectfilters.push(e),this.filters.objectfilters.length==this.filterObjects.length&&(this.filters.objectfilters=[]))},e.prototype.reload=function(e){void 0===e&&(e=!1),this.loading$.emit(!0);for(var t=0,i=this.modules;t<i.length;t++){var s=i[t];this.getTimeLineData(s,e)}},e.prototype.getTimeLineData=function(a,e){var r=this;void 0===e&&(e=!1),e||(this.activities[a].loading=!0);var t={count:!0,limit:this.defaultLimit,objects:JSON.stringify(this.filters.objectfilters),own:this.filters.own,searchterm:this.filters.searchterm};this.backend.postRequest("module/"+a+"/fts/"+this.parent.module+"/"+this.parent.id,{},t).subscribe(function(e){if(e){r.resetListData(a);for(var t=0,i=e.items;t<i.length;t++){var s=i[t];s.data=r.modelutilities.backendModel2spice(s.module,s.data)}r.activities[a].list=e.items,r.activities[a].totalcount=parseInt(e.totalcount,10),r.activities[a].aggregates=e.aggregates?e.aggregates:[]}r.activities[a].loading=!1},function(e){r.activities[a].loading=!1})},e.prototype.getMoreTimeLineData=function(a,e){var r=this;if(!this.canLoadMore(a)||this.activities[a].loading)return rxjs_1.of(!0);var o=new rxjs_1.Subject,t={start:this.activities[a].list.length,limit:e||this.defaultLimit,objects:JSON.stringify(this.filters.objectfilters),own:this.filters.own,searchterm:this.filters.searchterm};return this.activities[a].loadingmore=!0,this.backend.postRequest("module/"+a+"/fts/"+this.parent.module+"/"+this.parent.id,{},t).subscribe(function(e){for(var t=0,i=e.items;t<i.length;t++){var s=i[t];s.data=r.modelutilities.backendModel2spice(s.module,s.data),r.activities[a].list.push(s)}r.activities[a].loadingmore=!1,o.next(!0),o.complete()},function(e){r.activities[a].loadingmore=!1,o.error(e),o.complete()}),o.asObservable()},e.prototype.resetListData=function(e){this.activities[e]={loading:!1,loadingmore:!1,list:[],totalcount:0}},e.prototype.canLoadMore=function(e){return this.activities[e].totalcount>this.activities[e].list.length&&!this.activities[e].loadingmore},e.prototype.sortListdata=function(a){var r=this;this.activities[a].list.sort(function(e,t){var i=new moment(e.data[r.sortDates[e.module]]),s=new moment(t.data[r.sortDates[t.module]]);return"Activities"!==a?i.isBefore(s):i.isAfter(s)})},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[metadata,backend,modelutilities,configurationService,session,broadcast])],e)}();exports.activitiytimeline=activitiytimeline;var fielderrorgrouping=function(){function e(){this.fieldsWithErrors={},this.nrErrorsFields=0,this.change$=new core_1.EventEmitter}return e.prototype.setError=function(e,t){var i=!1;t?this.fieldsWithErrors[e]||(this.fieldsWithErrors[e]=!0,this.nrErrorsFields++,i=!0):this.fieldsWithErrors[e]&&(delete this.fieldsWithErrors[e],this.nrErrorsFields--,i=!0),i&&this.change$.emit(this.nrErrorsFields)},e.prototype.hasErrors=function(){return this.nrErrorsFields||!1},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[])],e)}();exports.fielderrorgrouping=fielderrorgrouping;